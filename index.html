<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Encendido de Navidad!</title>
  <style>
    /* Custom font-face */
    @font-face {
      font-family: 'HelveticaNowTextExtraBold';
      src: url('Assets/HelveticaNowText-ExtraBold.ttf.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('Assets/Encendido_BG.png');
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    .container {
      width: 85vw;
      max-width: 400px;
      padding: 20px 15px;
      margin-top: 20px;
      background: transparent;
      position: relative;
      border-radius: 25px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    /* GOLD OUTLINE AS FRAME, NO FILL */
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 25px;
      padding: 4px;
      background: linear-gradient(
        135deg,
        #b8860b,
        #ffd700,
        #fff3b0,
        #ffd700,
        #b8860b
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    @media (max-width: 375px) {
      .container {
        width: 90vw;
        max-width: none;
        padding: 15px 5px;
      }
    }

    /* Wrapper that holds camera + controls for responsive layout */
    .camera-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Camera frame: default 2:3 portrait box (live camera) */
    .camera-area {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 2 / 3;
      margin: 30px auto 15px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }

    /* When showing the captured preview, force horizontal 3:2 */
    .camera-area.preview-mode {
      aspect-ratio: 3 / 2;
      max-width: 100%;
    }

    /* Video & canvas fill the frame and are cropped */
    #video,
    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      display: block;
      object-fit: cover;
      background-color: #000;
    }

    /* Front camera ‚Äúun-mirror‚Äù ‚Äì added/removed from JS */
    #video.front-unmirror {
      transform: scaleX(-1);
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
      border: 2px solid white;
      border-radius: 4px;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      text-transform: uppercase;
    }

    #switchCameraButton {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #292725;
      color: white;
      width: 150px;
    }

    #switchCameraButton img {
      width: 20px;
      margin-right: 10px;
    }

    #captureButton,
    #uploadButton,
    #retakeButton {
      background-color: #3ca360;
      color: white;
      width: 150px;
    }

    #retakeButton {
      background-color: #e74c3c;
    }

    button:disabled {
      background-color: #cccccc;
    }

    /* Upload loading spinner on button */
    .button-loading {
      position: relative;
      opacity: 0.8;
    }

    .button-loading::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      width: 14px;
      height: 14px;
      margin-top: -7px;
      border-radius: 50%;
      border: 2px solid #fff;
      border-top-color: transparent;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #errorLog {
      color: white;
      margin-top: 10px;
      font-size: 11px;
    }

    .footer-text {
      font-size: 12px;
      color: black;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }

    .app-footer {
      font-size: 10px;
      color: white;
      margin-bottom: 10px;
      text-align: center;
    }

    .disclaimer {
      font-size: 10px;
      color: white;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 0;
      line-height: 1.4;
      width: 100%;
    }

    .disclaimer strong {
      text-decoration: underline;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .btn-slot {
      position: relative;
    }

    .btn-slot button {
      width: 150px;
    }

    .logo-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }

    #topLogo {
      width: 75%;
      max-width: 250px;
      height: auto;
      display: block;
    }

    @media (max-height: 750px) {
      #topLogo {
        width: 75%;
        max-width: 250px;
      }
    }

    @media (max-width: 600px) {
      button {
        font-size: 12px;
        padding: 8px 16px;
      }

      #switchCameraButton img {
        width: 16px;
      }
    }

    /* Intro overlay */
    @keyframes intro-shake {
      0%   { transform: translateX(0); }
      20%  { transform: translateX(-6px); }
      40%  { transform: translateX(6px); }
      60%  { transform: translateX(-4px); }
      80%  { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }

    .intro-box.shake {
      animation: intro-shake 0.35s ease;
    }

    #introModal {
      position: fixed;
      inset: 0;
      z-index: 999;
      display: flex;
    }

    .intro-backdrop {
      background: rgba(0, 0, 0, 0.75);
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .intro-box {
      background: #ffffff;
      border-radius: 12px;
      padding: 28px 22px;
      max-width: 340px;
      width: 85vw;
      text-align: center;
      display: flex;
      position: relative;
      flex-direction: column;
      justify-content: flex-start;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .intro-box h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .intro-box p {
      margin: 0 0 16px;
      font-size: 13px;
      color: #444;
    }

    .intro-close {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 20px;
      color: #888;
      cursor: pointer;
      font-weight: thin;
    }

    .intro-close:hover {
      color: #888888;
    }

    #countrySelect,
    #regionSelect,
    #lastNameInput,
    #emailInput {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    #countrySelect,
    #regionSelect {
      background: #fff;
    }

    .intro-buttons {
      display: flex;
      justify-content: center;
    }

    #submitIntroButton {
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      text-transform: uppercase;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      background: #3ca360;
      color: #fff;
      width: 100%;
    }

    .intro-error {
      margin-top: 8px;
      font-size: 12px;
      color: #d32f2f;
    }

    .upload-status {
      font-size: 11px;
      color: #ffffff;
      text-align: center;
      margin-top: 4px;
      min-height: 14px;
    }

    .newsletter-label {
      font-size: 12px;
      color: #444;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
      text-align: left;
    }

    .newsletter-label input {
      margin-top: 2px;
    }

    .thank-you-toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1000;
      text-align: center;
      max-width: 90vw;
    }

    .thank-you-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .controls-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .orientation-hint {
      font-size: 11px;
      color: #f9fafb;
      text-align: center;
      margin-top: 6px;
      opacity: 0.85;
    }

    @media (orientation: landscape) {
      .container {
        max-width: 1000px;
        margin-top: 40px;
      }

      .camera-controls-wrapper {
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
        gap: 35px;
        margin-top: 20px;
      }

      .camera-area {
        flex: 0 0 auto;
        width: 65%;
        max-width: 700px;
        aspect-ratio: 3 / 2;
        margin: 0 auto;
      }

      .controls-column {
        flex: 0 0 auto;
        width: 25%;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 40px;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
    }

    /* TICKET OVERLAY (turno de foto) */
    .ticket-overlay {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: none;
    }

    .ticket-backdrop {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .ticket-card {
      background: #f5e6c8;
      border-radius: 18px;
      padding: 20px 18px 18px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      position: relative;
      text-align: center;
      border: 2px dashed #b48a3a;
    }

    .ticket-tag {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #8a5a16;
      margin-bottom: 6px;
    }

    .ticket-number {
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      font-size: 40px;
      letter-spacing: 0.12em;
      color: #2b1a07;
      margin: 4px 0 8px;
    }

    .ticket-text {
      font-size: 13px;
      color: #3f2a11;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .ticket-note {
      font-size: 11px;
      color: #6b4a1e;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .ticket-close-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #3ca360;
      color: #ffffff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      cursor: pointer;
    }

    .ticket-close-button:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <!-- Intro overlay -->
  <div id="introModal">
    <div class="intro-backdrop">
      <div class="intro-box">
        <div class="intro-close" id="introClose">√ó</div>

        <h2>¬øDesde d√≥nde nos visitas? üòä</h2>
        <p>Selecciona tu pa√≠s y municipio/estado, escribe tus apellidos y contin√∫a a tu selfie.</p>

        <select id="countrySelect">
          <option value="">Selecciona tu pa√≠s</option>
          <option value="Puerto Rico">Puerto Rico</option>
          <option value="Estados Unidos">Estados Unidos</option>
        </select>

        <select id="regionSelect" disabled>
          <option value="">Selecciona tu municipio/estado</option>
        </select>

        <input type="text" id="lastNameInput" placeholder="Apellidos de la familia (Ej. P√©rez Gonz√°lez)">
        <input
          type="email"
          id="emailInput"
          placeholder="Correo electr√≥nico"
          required
          pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
        />

        <label class="newsletter-label">
          <input type="checkbox" id="newsletterOptIn">
          <span>
            Deseo recibir noticias y ofertas de
            <strong>Municipio de Mayag√ºez.</strong>
          </span>
        </label>

        <p style="font-size:9px; color:#666; margin:2px 0 12px;">
          Tu email ser√° utilizado √∫nicamente si autorizas recibir nuestro bolet√≠n.
        </p>

        <div class="intro-buttons">
          <button id="submitIntroButton">CONTINUAR</button>
        </div>
        <div id="introError" class="intro-error"></div>
      </div>
    </div>
  </div>

  <!-- Main container -->
  <div class="container">
    <div class="logo-wrapper">
      <img id="topLogo" src="Assets/Logo Mayaguez.png" alt="Logo Mayag√ºez">
    </div>

    <!-- Camera + controls wrapper for responsive layout -->
    <div class="camera-controls-wrapper">
      <div class="camera-area" id="cameraArea">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div class="controls-column">
        <div class="button-group">
          <div class="btn-slot">
            <button id="switchCameraButton">
              <img src="Assets/Camera Switch Icon.png" alt="Switch Icon">VOLTEAR
            </button>
            <button id="retakeButton" style="display:none;">RETOMAR</button>
          </div>

          <div class="btn-slot">
            <button id="captureButton">¬°TOMAR SELFIE!</button>
            <button id="uploadButton" style="display:none;">SUBIR FOTO</button>
          </div>
        </div>

        <div id="uploadStatus" class="upload-status"></div>
        <div class="orientation-hint">
          Para mejores resultados, gira tu tel√©fono a posici√≥n horizontal antes de tomar la foto.
        </div>
        <div id="errorLog"></div>
      </div>
    </div>

    <div class="footer-text">Municipio de Mayag√ºez.</div>

    <div class="disclaimer">
      Al tomar una foto, aceptas que ser√° mostrada p√∫blicamente en la pantalla durante el evento.
      <strong>Sube solo contenido apropiado para un ambiente familiar.</strong>
      Las im√°genes subidas podr√°n ser utilizadas en las redes sociales del Municipio de Mayag√ºez.
    </div>
  </div>

  <div class="footer-text app-footer">
    Luminar Apps<br>¬© 2025 LMNR Group LLC. All rights reserved.
  </div>

  <div id="thankYouToast" class="thank-you-toast"></div>

  <!-- Ticket overlay (turno de foto) -->
  <div id="ticketOverlay" class="ticket-overlay">
    <div class="ticket-backdrop">
      <div class="ticket-card">
        <div class="ticket-tag">FOTO RECIBIDA</div>
        <div id="ticketNumber" class="ticket-number">#000</div>
        <div id="ticketText" class="ticket-text">
          Tu n√∫mero de turno es el que ves en este boleto.
        </div>
        <div class="ticket-note">
          Tu foto ser√° mostrada en la pantalla principal en los pr√≥ximos minutos.
          Conserva este n√∫mero para verificar tu turno.
        </div>
        <button id="ticketClose" class="ticket-close-button">
          LISTO
        </button>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('captureButton');
    const uploadButton = document.getElementById('uploadButton');
    const retakeButton = document.getElementById('retakeButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const errorLog = document.getElementById('errorLog');
    const introModal = document.getElementById('introModal');
    const introClose = document.getElementById('introClose');
    const countrySelect = document.getElementById('countrySelect');
    const regionSelect = document.getElementById('regionSelect');
    const lastNameInput = document.getElementById('lastNameInput');
    const emailInput = document.getElementById('emailInput');
    const submitIntroButton = document.getElementById('submitIntroButton');
    const introError = document.getElementById('introError');
    const introBox = document.querySelector('.intro-box');
    const uploadStatus = document.getElementById('uploadStatus');
    const thankYouToast = document.getElementById('thankYouToast');
    const cameraArea = document.getElementById('cameraArea');

    const ticketOverlay = document.getElementById('ticketOverlay');
    const ticketNumberEl = document.getElementById('ticketNumber');
    const ticketTextEl = document.getElementById('ticketText');
    const ticketCloseBtn = document.getElementById('ticketClose');

    let currentFacingMode = 'user';           // Start with front camera
    let currentStream = null;                 // Active MediaStream
    const BACKEND_URL = 'https://mayaguez-photoapp.vercel.app';
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    let photoCounter = 1;
    let lastCaptureWasPortrait = false;
    let hasShownPortraitWarning = false;

    // Preload flag images
    const flagImages = {
      PR: new Image(),
      US: new Image()
    };
    flagImages.PR.src = 'Assets/pr_flag.png';
    flagImages.US.src = 'Assets/us_flag.png';

    // --- REGION DATA ---

    const PR_MUNICIPALITIES = [
      "Adjuntas","Aguada","Aguadilla","Aguas Buenas","Aibonito","A√±asco","Arecibo",
      "Arroyo","Barceloneta","Barranquitas","Bayam√≥n","Cabo Rojo","Caguas","Camuy",
      "Can√≥vanas","Carolina","Cata√±o","Cayey","Ceiba","Ciales","Cidra","Coamo",
      "Comer√≠o","Corozal","Culebra","Dorado","Fajardo","Florida","Gu√°nica","Guayama",
      "Guayanilla","Guaynabo","Gurabo","Hatillo","Hormigueros","Humacao","Isabela",
      "Jayuya","Juana D√≠az","Juncos","Lajas","Lares","Las Mar√≠as","Las Piedras",
      "Lo√≠za","Luquillo","Manat√≠","Maricao","Maunabo","Mayag√ºez","Moca","Morovis",
      "Naguabo","Naranjito","Orocovis","Patillas","Pe√±uelas","Ponce","Quebradillas",
      "Rinc√≥n","R√≠o Grande","Sabana Grande","Salinas","San Germ√°n","San Juan",
      "San Lorenzo","San Sebasti√°n","Santa Isabel","Toa Alta","Toa Baja","Trujillo Alto",
      "Utuado","Vega Alta","Vega Baja","Vieques","Villalba","Yabucoa","Yauco"
    ];

    const US_STATES = [
      "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut",
      "Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa",
      "Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan",
      "Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
      "New Hampshire","New Jersey","New Mexico","New York","North Carolina",
      "North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island",
      "South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont",
      "Virginia","Washington","West Virginia","Wisconsin","Wyoming"
    ];

    function populateRegionOptions(country, preselected) {
      regionSelect.innerHTML = '';
      let list = [];

      if (country === 'Puerto Rico') {
        list = PR_MUNICIPALITIES;
      } else if (country === 'Estados Unidos') {
        list = US_STATES;
      }

      if (!country || list.length === 0) {
        regionSelect.disabled = true;
        regionSelect.innerHTML = '<option value="">Selecciona tu municipio/estado</option>';
        return;
      }

      regionSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = country === 'Puerto Rico'
        ? 'Selecciona tu municipio'
        : 'Selecciona tu estado';
      regionSelect.appendChild(placeholder);

      list.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        regionSelect.appendChild(opt);
      });

      if (preselected && list.includes(preselected)) {
        regionSelect.value = preselected;
      }
    }

    countrySelect.addEventListener('change', () => {
      populateRegionOptions(countrySelect.value, null);
    });

    function getPRDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc - 4 * 60 * 60000);
    }

    function buildPhotoFileName() {
      const prNow = getPRDate();

      const dd = String(prNow.getDate()).padStart(2, '0');
      const mm = String(prNow.getMonth() + 1).padStart(2, '0');
      const yy = String(prNow.getFullYear()).slice(-2);
      const HH = String(prNow.getHours()).padStart(2, '0');
      const MM = String(prNow.getMinutes()).padStart(2, '0');
      const SS = String(prNow.getSeconds()).padStart(2, '0');

      const num = String(photoCounter).padStart(2, '0');
      photoCounter++;

      return `${num}_${dd}_${mm}_${yy}-${HH}_${MM}_${SS}.jpeg`;
    }

    function showThankYou(message) {
      if (!thankYouToast) return;
      thankYouToast.textContent = message;
      thankYouToast.classList.add('show');
      setTimeout(() => {
        thankYouToast.classList.remove('show');
      }, 2500);
    }

    // --- Ticket helpers ---

    function formatTicketLabel(ticketFromServer) {
  if (ticketFromServer == null) return '';

  // If server sends "T001", "T12", etc ‚Üí turn into "#001"
  if (typeof ticketFromServer === 'string') {
    const m = ticketFromServer.match(/T?(\d{1,})/i);
    if (m) {
      return '#' + m[1].padStart(3, '0');
    }
    // Fallback: show raw string
    return ticketFromServer;
  }

  const n = Number(ticketFromServer);
  if (!Number.isFinite(n)) return String(ticketFromServer);
  return '#' + String(n).padStart(3, '0');
}

    function showTicketOverlay(ticketNumber) {
      if (!ticketOverlay) return;
      const label = formatTicketLabel(ticketNumber);

      if (ticketNumberEl && label) {
        ticketNumberEl.textContent = label;
      }

      // Optional, could customize text here in the future if server sends more data
      if (ticketTextEl) {
        ticketTextEl.textContent = 'Tu n√∫mero de turno es el que ves en este boleto.';
      }

      ticketOverlay.style.display = 'flex';
    }

    function hideTicketOverlay() {
      if (!ticketOverlay) return;
      ticketOverlay.style.display = 'none';
    }

    if (ticketCloseBtn) {
      ticketCloseBtn.addEventListener('click', hideTicketOverlay);
    }

    if (ticketOverlay) {
      ticketOverlay.addEventListener('click', (e) => {
        // Close if clicking outside the ticket card
        if (e.target === ticketOverlay || e.target.classList.contains('ticket-backdrop')) {
          hideTicketOverlay();
        }
      });
    }

    async function setupCamera(facingMode = 'user') {
      try {
        // ANDROID/OTHERS: stop previous stream before opening new one.
        // iOS: KEEP previous stream (Safari can be picky with repeated stops).
        if (currentStream && !isIOS) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }

        const constraints = isIOS
          ? { video: { facingMode } }
          : {
              video: {
                facingMode: { ideal: facingMode },
                width: { ideal: 1080 },
                height: { ideal: 1440 }
              }
            };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;

        video.srcObject = stream;
        await video.play();

        // Toggle ‚Äúun-mirror‚Äù only for front camera
        if (facingMode === 'user') {
          video.classList.add('front-unmirror');
        } else {
          video.classList.remove('front-unmirror');
        }

        console.log('Actual video resolution:', video.videoWidth, video.videoHeight);
      } catch (error) {
        console.error('Camera error:', error);
        errorLog.textContent = `Camera error: ${error.message}`;
      }
    }

    function switchCamera() {
      currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
      setupCamera(currentFacingMode);
    }

    function drawLocationOverlay(ctx, width, height) {
      const country = localStorage.getItem('lumi_country') || '';
      const region = localStorage.getItem('lumi_region') || '';

      if (!country && !region) return;

      let label = '';
      if (country && region) {
        label = `${region}, ${country}`;
      } else {
        label = country || region;
      }

      if (!label) return;

      // --- layout constants ---
      const padding = 24;           // distance from canvas edge
      const flagWidth = 60;
      const flagHeight = 40;
      const gapBetween = 12;        // space between flag and text

      // pick flag image
      let flagImg = null;
      if (country === 'Puerto Rico') flagImg = flagImages.PR;
      if (country === 'Estados Unidos') flagImg = flagImages.US;

      ctx.save();

      // text metrics
      ctx.font = 'bold 24px Arial';
      ctx.textBaseline = 'middle';
      const textMetrics = ctx.measureText(label);
      const textWidth = textMetrics.width;

      const sidePadding = 12;       // inside box: left/right
      const topPadding = 8;         // inside box: top/bottom
      const boxHeight = flagHeight + topPadding * 2;
      const contentWidth = flagWidth + gapBetween + textWidth;
      const boxWidth = contentWidth + sidePadding * 2;

      // --- TOP-RIGHT position ---
      const boxX = width - padding - boxWidth; // right-aligned
      const boxY = padding;                    // from top

      // background box
      ctx.globalAlpha = 0.75;
      ctx.fillStyle = '#000000';
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

      // flag position
      const flagX = boxX + sidePadding;
      const flagY = boxY + topPadding;

      if (flagImg && flagImg.complete) {
        ctx.drawImage(flagImg, flagX, flagY, flagWidth, flagHeight);
      }

      // text position
      ctx.fillStyle = '#ffffff';
      const textX = flagX + flagWidth + gapBetween;
      const textY = boxY + boxHeight / 2;

      // Simple text shadow for readability
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;

      ctx.fillText(label, textX, textY);
      ctx.restore();
    }
    
      if (!rawTicket) return;

      // Convert T001 ‚Üí #001
      let label = '';
      if (typeof rawTicket === 'string') {
        const m = rawTicket.match(/T?(\d+)/i);
        if (m) label = '#' + m[1].padStart(3, '0');
      } else if (typeof rawTicket === 'number') {
        label = '#' + String(rawTicket).padStart(3, '0');
      }
      if (!label) return;

      const padding = 24;
      const boxW = 160;
      const boxH = 70;

      ctx.save();
      ctx.globalAlpha = 0.75;
      ctx.fillStyle = '#000000';
      ctx.fillRect(padding, padding, boxW, boxH);

      ctx.globalAlpha = 1;
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 36px Arial';
      ctx.textBaseline = 'middle';

      // Slight text shadow
      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;

      ctx.fillText(label, padding + 20, padding + boxH / 2);
      ctx.restore();
    }
    // Capture selfie
    captureButton.addEventListener('click', () => {
      // Always capture to a horizontal 3:2 canvas for upload + preview
      const targetWidth  = 1500;
      const targetHeight = 1000;

      canvas.width  = targetWidth;
      canvas.height = targetHeight;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const vw = video.videoWidth;
      const vh = video.videoHeight;

      if (!vw || !vh) {
        errorLog.textContent = 'Error: Camera not ready';
        return;
      }

      // Detect if the video feed is effectively "portrait"
      lastCaptureWasPortrait = vh > vw;

      const videoAspect  = vw / vh;
      const canvasAspect = targetWidth / targetHeight;

      let sx, sy, sWidth, sHeight;

      if (videoAspect > canvasAspect) {
        sHeight = vh;
        sWidth  = sHeight * canvasAspect;
        sx      = (vw - sWidth) / 2;
        sy      = 0;
      } else {
        sWidth  = vw;
        sHeight = sWidth / canvasAspect;
        sx      = 0;
        sy      = (vh - sHeight) / 2;
      }

      ctx.save();

      // Mirror the captured image only for the front camera
      if (currentFacingMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }

      ctx.drawImage(
        video,
        sx, sy, sWidth, sHeight,
        0, 0, canvas.width, canvas.height
      );

      ctx.restore();

      // Draw country/region flag + text overlay
      drawLocationOverlay(ctx, canvas.width, canvas.height);

      // Swap UI: VOLTEAR/TOMAR ‚Üí RETOMAR/SUBIR
      video.style.display = 'none';
      canvas.style.display = 'block';
      cameraArea.classList.add('preview-mode');

      switchCameraButton.style.display = 'none';
      retakeButton.style.display = 'inline-block';

      captureButton.style.display = 'none';
      uploadButton.style.display = 'inline-block';
    });

    // Retake
    retakeButton.addEventListener('click', () => {
      video.style.display = 'block';
      canvas.style.display = 'none';
      cameraArea.classList.remove('preview-mode');

      switchCameraButton.style.display = 'inline-flex';
      retakeButton.style.display = 'none';

      uploadButton.style.display = 'none';
      captureButton.style.display = 'inline-block';

      uploadButton.disabled = false;
      uploadButton.textContent = 'SUBIR FOTO';
      uploadButton.classList.remove('button-loading');
      uploadStatus.textContent = '';
      errorLog.textContent = '';
      hideTicketOverlay();
    });

    // Upload
    uploadButton.addEventListener('click', async () => {
      if (uploadButton.disabled) return;

      // If the last capture was in portrait feed, warn once
      if (lastCaptureWasPortrait && !hasShownPortraitWarning) {
        const proceed = window.confirm(
          'Tu foto se ve vertical y podr√≠a salir recortada en la pantalla.\n\n' +
          '¬øQuieres subirla as√≠ de todos modos?\n\nPulsa "Aceptar" para subirla as√≠, o "Cancelar" para volver y retomar la foto.'
        );
        if (!proceed) {
          uploadStatus.textContent =
            'Te recomendamos girar tu tel√©fono a horizontal y volver a tomar la foto.';
          return;
        }
        hasShownPortraitWarning = true;
      }

      uploadButton.disabled = true;
      uploadButton.textContent = 'SUBIENDO...';
      uploadButton.classList.add('button-loading');
      uploadStatus.textContent = 'Subiendo foto, por favor espera...';
      errorLog.textContent = '';

      canvas.toBlob(async (blob) => {
        try {
          const response = await fetch(`${BACKEND_URL}/upload`, {
            method: 'POST',
            headers: {
              'Content-Type': blob.type,
              'X-File-Name': buildPhotoFileName(),
              'x-session-id': getSessionId()
            },
            body: blob
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Upload successful:', result);

          uploadStatus.textContent = '¬°Foto subida correctamente!';
          uploadButton.textContent = 'SUBIDA';
          uploadButton.classList.remove('button-loading');

          // Try to read ticket info from backend (fallback-safe)
          // Try to read ticket info from backend (now using ticketLabel / ticketIndex)
const ticketNumber =
  result.ticketLabel ??      // "T001", "T002", ...
  result.ticketIndex ??      // 1, 2, 3, ...
  result.ticketNumber ??     // legacy/fallback
  result.ticket ??           // legacy/fallback
  result.photoIndex ??       // legacy/fallback
  null;

if (ticketNumber !== null && ticketNumber !== undefined) {
  showTicketOverlay(ticketNumber);
  showThankYou('¬°Gracias! Guarda tu n√∫mero de turno.');
} else {
  showThankYou('¬°Gracias! Tu foto ha sido enviada.');
}
        } catch (error) {
          console.error('Upload error:', error);
          errorLog.textContent = `Error al subir la foto: ${error.message}`;

          uploadButton.disabled = false;
          uploadButton.textContent = 'SUBIR FOTO';
          uploadButton.classList.remove('button-loading');
          uploadStatus.textContent = 'Hubo un error. Intenta nuevamente.';
        }
      }, 'image/jpeg');
    });

    switchCameraButton.addEventListener('click', switchCamera);

    // Intro / registration
    function startCameraAfterIntro() {
      introModal.style.display = 'none';
      setupCamera(currentFacingMode);
    }

    introClose.addEventListener('click', () => {
      startCameraAfterIntro();
      showThankYou('Puedes tomar tu selfie cuando est√©s listo.');
    });

    submitIntroButton.addEventListener('click', async () => {
      if (submitIntroButton.disabled) return;

      const country = countrySelect.value;
      const region = regionSelect.value;
      const lastName = lastNameInput.value.trim();
      const email = emailInput.value.trim();
      const newsletter = document.getElementById('newsletterOptIn').checked;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      // VALIDATION + SHAKE
      if (!emailRegex.test(email)) {
        introError.textContent = 'Por favor escribe un correo electr√≥nico v√°lido.';
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      if (!country || !region || !lastName || !email) {
        introError.textContent = 'Por favor completa todos los campos para continuar.';
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      introError.textContent = '';

      const originalText = submitIntroButton.textContent;
      submitIntroButton.disabled = true;
      submitIntroButton.textContent = 'ENVIANDO...';
      submitIntroButton.classList.add('button-loading');

      // Save locally for overlay + persistence
      localStorage.setItem('lumi_country', country);
      localStorage.setItem('lumi_region', region);
      localStorage.setItem('lumi_lastname', lastName);
      localStorage.setItem('lumi_email', email);
      localStorage.setItem('lumi_newsletter', newsletter ? '1' : '0');

      try {
        // Send to backend (country combined with region for backwards compatibility)
        await fetch(`${BACKEND_URL}/visit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': getSessionId()
          },
          body: JSON.stringify({
            country: `${region}, ${country}`,
            lastName,
            email,
            newsletter,
            timestamp: new Date().toISOString()
          })
        });

        startCameraAfterIntro();
        showThankYou('¬°Gracias por registrarte! Ahora toma tu selfie.');
      } catch (err) {
        console.error('Error sending visit info:', err);
        introError.textContent = 'Hubo un error al enviar tus datos. Intenta de nuevo.';

        submitIntroButton.disabled = false;
        submitIntroButton.textContent = originalText;
        submitIntroButton.classList.remove('button-loading');
      }
    });

    // --- SESSION ID HELPERS ---

    function getSessionId() {
      let id = localStorage.getItem('lumi_session_id');
      if (!id) {
        id = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('lumi_session_id', id);
      }
      return id;
    }

    // Call this once on page load (logs a visit with session_id)
    function pingSession() {
      fetch(`${BACKEND_URL}/ping`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-session-id': getSessionId()
        },
        body: JSON.stringify({})
      }).catch(console.error);
    }

    // Prefill intro from localStorage (if exists)
    function prefillIntroFromStorage() {
      const storedCountry = localStorage.getItem('lumi_country') || '';
      const storedRegion = localStorage.getItem('lumi_region') || '';
      const storedLast = localStorage.getItem('lumi_lastname') || '';
      const storedEmail = localStorage.getItem('lumi_email') || '';
      const storedNewsletter = localStorage.getItem('lumi_newsletter') === '1';

      if (storedCountry) {
        countrySelect.value = storedCountry;
        populateRegionOptions(storedCountry, storedRegion);
      }

      if (storedLast) lastNameInput.value = storedLast;
      if (storedEmail) emailInput.value = storedEmail;
      document.getElementById('newsletterOptIn').checked = storedNewsletter;
    }

    // Run as soon as the page is ready
    window.addEventListener('load', () => {
      prefillIntroFromStorage();
      introModal.style.display = 'flex';
      pingSession();
    });
  </script>
</body>
</html>
