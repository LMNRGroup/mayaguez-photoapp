<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Encendido de Navidad!</title>
  <style>
    /* Custom font-face */
    @font-face {
      font-family: 'HelveticaNowTextExtraBold';
      src: url('Assets/HelveticaNowText-ExtraBold.ttf.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('Assets/Encendido_BG.png');
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    .container {
      width: 85vw;
      max-width: 400px;
      padding: 20px 15px;
      margin-top: 20px;
      background: transparent;
      position: relative;
      border-radius: 25px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    /* GOLD OUTLINE AS FRAME, NO FILL */
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 25px;
      padding: 4px;
      background: linear-gradient(
        135deg,
        #b8860b,
        #ffd700,
        #fff3b0,
        #ffd700,
        #b8860b
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    @media (max-width: 375px) {
      .container {
        width: 90vw;
        max-width: none;
        padding: 15px 5px;
      }
    }

    /* Wrapper that holds camera + controls for responsive layout */
    .camera-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Camera frame: fixed 2:3 portrait box */
    .camera-area {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 2 / 3;
      margin: 30px auto 15px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }

    /* Video & canvas fill the frame and are cropped */
    #video,
    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      display: block;
      object-fit: cover;
      background-color: #000;
    }

    /* Front camera ‚Äúun-mirror‚Äù ‚Äì added/removed from JS */
    #video.front-unmirror {
      transform: scaleX(-1);
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
      border: 2px solid white;
      border-radius: 4px;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      text-transform: uppercase;
    }

    #switchCameraButton {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #292725;
      color: white;
      width: 150px;
    }

    #switchCameraButton img {
      width: 20px;
      margin-right: 10px;
    }

    #captureButton,
    #uploadButton,
    #retakeButton {
      background-color: #3ca360;
      color: white;
      width: 150px;
    }

    #retakeButton {
      background-color: #e74c3c;
    }

    button:disabled {
      background-color: #cccccc;
    }

    /* Upload loading spinner on button */
    .button-loading {
      position: relative;
      opacity: 0.8;
    }

    .button-loading::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      width: 14px;
      height: 14px;
      margin-top: -7px;
      border-radius: 50%;
      border: 2px solid #fff;
      border-top-color: transparent;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #errorLog {
      color: white;
      margin-top: 10px;
      font-size: 11px;
    }

    .footer-text {
      font-size: 12px;
      color: black;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }

    .app-footer {
      font-size: 10px;
      color: white;
      margin-bottom: 10px;
      text-align: center;
    }

    .disclaimer {
      font-size: 10px;
      color: white;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 0;
      line-height: 1.4;
      width: 100%;
    }

    .disclaimer strong {
      text-decoration: underline;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .btn-slot {
      position: relative;
    }

    .btn-slot button {
      width: 150px;
    }

    .logo-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }

    #topLogo {
      width: 75%;
      max-width: 250px;
      height: auto;
      display: block;
    }

    @media (max-height: 750px) {
      #topLogo {
        width: 75%;
        max-width: 250px;
      }
    }

    @media (max-width: 600px) {
      button {
        font-size: 12px;
        padding: 8px 16px;
      }

      #switchCameraButton img {
        width: 16px;
      }
    }

    /* Intro overlay */
    @keyframes intro-shake {
      0%   { transform: translateX(0); }
      20%  { transform: translateX(-6px); }
      40%  { transform: translateX(6px); }
      60%  { transform: translateX(-4px); }
      80%  { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }

    .intro-box.shake {
      animation: intro-shake 0.35s ease;
    }

    #introModal {
      position: fixed;
      inset: 0;
      z-index: 999;
      display: flex;
    }

    .intro-backdrop {
      background: rgba(0, 0, 0, 0.75);
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .intro-box {
      background: #ffffff;
      border-radius: 12px;
      padding: 28px 22px;
      max-width: 340px;
      width: 85vw;
      text-align: center;
      display: flex;
      position: relative;
      flex-direction: column;
      justify-content: flex-start;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .intro-box h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .intro-box p {
      margin: 0 0 16px;
      font-size: 13px;
      color: #444;
    }

    .intro-close {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 20px;
      color: #888;
      cursor: pointer;
      font-weight: thin;
    }

    .intro-close:hover {
      color: #888888;
    }

    #countryInput,
    #lastNameInput,
    #emailInput {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .intro-buttons {
      display: flex;
      justify-content: center;
    }

    #submitIntroButton {
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      text-transform: uppercase;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      background: #3ca360;
      color: #fff;
      width: 100%;
    }

    .intro-error {
      margin-top: 8px;
      font-size: 12px;
      color: #d32f2f;
    }

    .upload-status {
      font-size: 11px;
      color: #ffffff;
      text-align: center;
      margin-top: 4px;
      min-height: 14px;
    }

    .newsletter-label {
      font-size: 12px;
      color: #444;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
      text-align: left;
    }

    .newsletter-label input {
      margin-top: 2px;
    }

    .thank-you-toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1000;
      text-align: center;
      max-width: 90vw;
    }

    .thank-you-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .controls-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    @media (orientation: landscape) {
      .container {
        max-width: 1000px;
        margin-top: 40px;
      }

      .camera-controls-wrapper {
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
        gap: 35px;
        margin-top: 20px;
      }

      .camera-area {
        flex: 0 0 auto;
        width: 65%;
        max-width: 700px;
        aspect-ratio: 3 / 2;
        margin: 0 auto;
      }

      .controls-column {
        flex: 0 0 auto;
        width: 25%;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 40px;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Intro overlay -->
  <div id="introModal">
    <div class="intro-backdrop">
      <div class="intro-box">
        <div class="intro-close" id="introClose">√ó</div>

        <h2>¬øDe qu√© pueblo nos visitas? üòä</h2>
        <p>Escribe tu municipio o pa√≠s y tus apellidos, luego contin√∫a a tu selfie.</p>

        <input type="text" id="countryInput" placeholder="Ej. Mayag√ºez, Puerto Rico">
        <input type="text" id="lastNameInput" placeholder="Ej. P√©rez Gonz√°lez">
        <input
          type="email"
          id="emailInput"
          placeholder="Correo electr√≥nico"
          required
          pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
        />

        <label class="newsletter-label">
          <input type="checkbox" id="newsletterOptIn">
          <span>
            Deseo recibir noticias y ofertas de
            <strong>Municipio de Mayag√ºez.</strong>
          </span>
        </label>

        <p style="font-size:9px; color:#666; margin:2px 0 12px;">
          Tu email ser√° utilizado √∫nicamente si autorizas recibir nuestro bolet√≠n.
        </p>

        <div class="intro-buttons">
          <button id="submitIntroButton">CONTINUAR</button>
        </div>
        <div id="introError" class="intro-error"></div>
      </div>
    </div>
  </div>

  <!-- Main container -->
  <div class="container">
    <div class="logo-wrapper">
      <img id="topLogo" src="Assets/Logo Mayaguez.png" alt="Logo Mayag√ºez">
    </div>

    <!-- Camera + controls wrapper for responsive layout -->
    <div class="camera-controls-wrapper">
      <div class="camera-area">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div class="controls-column">
        <div class="button-group">
          <div class="btn-slot">
            <button id="switchCameraButton">
              <img src="Assets/Camera Switch Icon.png" alt="Switch Icon">VOLTEAR
            </button>
            <button id="retakeButton" style="display:none;">RETOMAR</button>
          </div>

          <div class="btn-slot">
            <button id="captureButton">¬°TOMAR SELFIE!</button>
            <button id="uploadButton" style="display:none;">SUBIR FOTO</button>
          </div>
        </div>

        <div id="uploadStatus" class="upload-status"></div>
        <div id="errorLog"></div>
      </div>
    </div>

    <div class="footer-text">Municipio de Mayag√ºez.</div>

    <div class="disclaimer">
      Al tomar una foto, aceptas que ser√° mostrada p√∫blicamente en la pantalla durante el evento.
      <strong>Sube solo contenido apropiado para un ambiente familiar.</strong>
      Las im√°genes subidas podr√°n ser utilizadas en las redes sociales del Municipio de Mayag√ºez.
    </div>
  </div>

  <div class="footer-text app-footer">
    Luminar Apps<br>¬© 2025 LMNR Group LLC. All rights reserved.
  </div>

  <div id="thankYouToast" class="thank-you-toast"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('captureButton');
    const uploadButton = document.getElementById('uploadButton');
    const retakeButton = document.getElementById('retakeButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const errorLog = document.getElementById('errorLog');
    const introModal = document.getElementById('introModal');
    const introClose = document.getElementById('introClose');
    const countryInput = document.getElementById('countryInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const submitIntroButton = document.getElementById('submitIntroButton');
    const introError = document.getElementById('introError');
    const introBox = document.querySelector('.intro-box');
    const uploadStatus = document.getElementById('uploadStatus');
    const thankYouToast = document.getElementById('thankYouToast');

    let currentFacingMode = 'user';           // Start with front camera
    let currentStream = null;                 // Active MediaStream
    const BACKEND_URL = 'https://mayaguez-photoapp.vercel.app';
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    let photoCounter = 1;

    function getPRDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc - 4 * 60 * 60000);
    }

    function buildPhotoFileName() {
      const prNow = getPRDate();

      const dd = String(prNow.getDate()).padStart(2, '0');
      const mm = String(prNow.getMonth() + 1).padStart(2, '0');
      const yy = String(prNow.getFullYear()).slice(-2);
      const HH = String(prNow.getHours()).padStart(2, '0');
      const MM = String(prNow.getMinutes()).padStart(2, '0');
      const SS = String(prNow.getSeconds()).padStart(2, '0');

      const num = String(photoCounter).padStart(2, '0');
      photoCounter++;

      return `${num}_${dd}_${mm}_${yy}-${HH}_${MM}_${SS}.jpeg`;
    }

    function isLandscape() {
      return window.innerWidth > window.innerHeight;
    }

    function showThankYou(message) {
      if (!thankYouToast) return;
      thankYouToast.textContent = message;
      thankYouToast.classList.add('show');
      setTimeout(() => {
        thankYouToast.classList.remove('show');
      }, 2500);
    }

    async function setupCamera(facingMode = 'user') {
      try {
        // ANDROID/OTHERS: stop previous stream before opening new one.
        // iOS: KEEP previous stream (Safari can be picky with repeated stops).
        if (currentStream && !isIOS) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }

        const constraints = isIOS
          ? { video: { facingMode } }
          : {
              video: {
                facingMode: { ideal: facingMode },
                width: { ideal: 1080 },
                height: { ideal: 1440 }
              }
            };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;

        video.srcObject = stream;
        await video.play();

        // Toggle ‚Äúun-mirror‚Äù only for front camera
        if (facingMode === 'user') {
          video.classList.add('front-unmirror');
        } else {
          video.classList.remove('front-unmirror');
        }

        console.log('Actual video resolution:', video.videoWidth, video.videoHeight);
      } catch (error) {
        console.error('Camera error:', error);
        errorLog.textContent = `Camera error: ${error.message}`;
      }
    }

    function switchCamera() {
      currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
      setupCamera(currentFacingMode);
    }

    // Capture selfie
    captureButton.addEventListener('click', () => {
      const isLand = isLandscape();

      // 3:2 in landscape, 2:3 in portrait
      const targetWidth  = isLand ? 1500 : 1000;
      const targetHeight = isLand ? 1000 : 1500;

      canvas.width  = targetWidth;
      canvas.height = targetHeight;

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const vw = video.videoWidth;
      const vh = video.videoHeight;

      if (!vw || !vh) {
        errorLog.textContent = 'Error: Camera not ready';
        return;
      }

      const videoAspect  = vw / vh;
      const canvasAspect = targetWidth / targetHeight;

      let sx, sy, sWidth, sHeight;

      if (videoAspect > canvasAspect) {
        sHeight = vh;
        sWidth  = sHeight * canvasAspect;
        sx      = (vw - sWidth) / 2;
        sy      = 0;
      } else {
        sWidth  = vw;
        sHeight = sWidth / canvasAspect;
        sx      = 0;
        sy      = (vh - sHeight) / 2;
      }

      ctx.save();

      // Mirror the captured image only for the front camera
      if (currentFacingMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }

      ctx.drawImage(
        video,
        sx, sy, sWidth, sHeight,
        0, 0, canvas.width, canvas.height
      );

      ctx.restore();

      // Draw logo on top (not mirrored)
      const img = new Image();
      img.src = 'Assets/Logo Mayaguez.png';
      img.onload = () => {
        const logoWidth = 500;
        const logoHeight = (logoWidth / img.width) * img.height;
        const margin = 20;
        ctx.drawImage(
          img,
          (canvas.width - logoWidth) / 2,
          margin,
          logoWidth,
          logoHeight
        );
      };

      // Swap UI: VOLTEAR/TOMAR ‚Üí RETOMAR/SUBIR
      video.style.display = 'none';
      canvas.style.display = 'block';

      switchCameraButton.style.display = 'none';
      retakeButton.style.display = 'inline-block';

      captureButton.style.display = 'none';
      uploadButton.style.display = 'inline-block';
    });

    // Retake
    retakeButton.addEventListener('click', () => {
      video.style.display = 'block';
      canvas.style.display = 'none';

      switchCameraButton.style.display = 'inline-flex';
      retakeButton.style.display = 'none';

      uploadButton.style.display = 'none';
      captureButton.style.display = 'inline-block';

      uploadButton.disabled = false;
      uploadButton.textContent = 'SUBIR FOTO';
      uploadButton.classList.remove('button-loading');
      uploadStatus.textContent = '';
      errorLog.textContent = '';
    });

    // Upload
    uploadButton.addEventListener('click', async () => {
      if (uploadButton.disabled) return;

      uploadButton.disabled = true;
      uploadButton.textContent = 'SUBIENDO...';
      uploadButton.classList.add('button-loading');
      uploadStatus.textContent = 'Subiendo foto, por favor espera...';
      errorLog.textContent = '';

      canvas.toBlob(async (blob) => {
        try {
          const response = await fetch(`${BACKEND_URL}/upload`, {
            method: 'POST',
            headers: {
              'Content-Type': blob.type,
              'X-File-Name': buildPhotoFileName(),
              'x-session-id': getSessionId()
            },
            body: blob
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Upload successful:', result);

          uploadStatus.textContent = '¬°Foto subida correctamente!';
          uploadButton.textContent = 'SUBIDA';
          uploadButton.classList.remove('button-loading');
          showThankYou('¬°Gracias! Tu foto ha sido enviada.');
        } catch (error) {
          console.error('Upload error:', error);
          errorLog.textContent = `Error al subir la foto: ${error.message}`;

          uploadButton.disabled = false;
          uploadButton.textContent = 'SUBIR FOTO';
          uploadButton.classList.remove('button-loading');
          uploadStatus.textContent = 'Hubo un error. Intenta nuevamente.';
        }
      }, 'image/jpeg');
    });

    switchCameraButton.addEventListener('click', switchCamera);

    // Intro / registration
    function startCameraAfterIntro() {
      introModal.style.display = 'none';
      setupCamera(currentFacingMode);
    }

    introClose.addEventListener('click', () => {
      startCameraAfterIntro();
      showThankYou('Puedes tomar tu selfie cuando est√©s listo.');
    });

    submitIntroButton.addEventListener('click', async () => {
      if (submitIntroButton.disabled) return;

      const country = countryInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const newsletter = document.getElementById('newsletterOptIn').checked;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      // VALIDATION + SHAKE
      if (!emailRegex.test(email)) {
        introError.textContent = 'Por favor escribe un correo electr√≥nico v√°lido.';
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      if (!country || !lastName || !email) {
        introError.textContent = 'Por favor completa todos los campos para continuar.';
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      introError.textContent = '';

      const originalText = submitIntroButton.textContent;
      submitIntroButton.disabled = true;
      submitIntroButton.textContent = 'ENVIANDO...';
      submitIntroButton.classList.add('button-loading');

      try {
        await fetch(`${BACKEND_URL}/visit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': getSessionId()
          },
          body: JSON.stringify({
            country,
            lastName,
            email,
            newsletter,
            timestamp: new Date().toISOString()
          })
        });

        startCameraAfterIntro();
        showThankYou('¬°Gracias por registrarte! Ahora toma tu selfie.');
      } catch (err) {
        console.error('Error sending visit info:', err);
        introError.textContent = 'Hubo un error al enviar tus datos. Intenta de nuevo.';

        submitIntroButton.disabled = false;
        submitIntroButton.textContent = originalText;
        submitIntroButton.classList.remove('button-loading');
      }
    });
     // --- SESSION ID HELPERS ---

    // Keep the same ID for this user while the tab is open / reused
    function getSessionId() {
      let id = localStorage.getItem('lumi_session_id');
      if (!id) {
        id = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('lumi_session_id', id);
      }
      return id;
    }

    // Call this once on page load (logs a visit with session_id)
    function pingSession() {
      fetch(`${BACKEND_URL}/ping`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-session-id': getSessionId()
        },
        body: JSON.stringify({})
      }).catch(console.error);
    }

    // Run as soon as the page is ready
    window.addEventListener('load', () => {
      introModal.style.display = 'flex';
      pingSession();
    });
  </script>
</body>
</html>
