<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Mayag√ºez en Fitur!</title>
  <style>
    /* Custom font-face */
    @font-face {
      font-family: 'HelveticaNowTextExtraBold';
      src: url('Assets/HelveticaNowText-ExtraBold.ttf.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: url('Assets/PhotoApp_BG.png') center/cover no-repeat fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      color: #f8fafc;
    }

    .container {
      width: 85vw;
      max-width: 400px;
      padding: 20px 15px;
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(6px);
      position: relative;
      border-radius: 25px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      color: #0f172a;
    }

    /* GOLD OUTLINE AS FRAME, NO FILL */
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 25px;
      padding: 4px;
      background: linear-gradient(
        135deg,
        #b8860b,
        #ffd700,
        #fff3b0,
        #ffd700,
        #b8860b
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    @media (max-width: 375px) {
      .container {
        width: 90vw;
        max-width: none;
        padding: 15px 5px;
      }
    }

    /* Wrapper that holds camera + controls for responsive layout */
    .camera-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Camera frame: default 2:3 portrait box (live camera) */
    .camera-area {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 2 / 3;
      margin: 30px auto 15px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }

    /* When showing the captured preview, force horizontal 3:2 */
    .camera-area.preview-mode {
      aspect-ratio: 3 / 2;
      max-width: 100%;
    }

    /* Video & canvas fill the frame and are cropped */
    #video,
    #canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      display: block;
      object-fit: cover;
      background-color: #000;
    }

    /* Front camera ‚Äúun-mirror‚Äù ‚Äì added/removed from JS */
    #video.front-unmirror {
      transform: scaleX(-1);
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 999px;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(15, 23, 42, 0.2);
    }

    #switchCameraButton {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #0f172a;
      color: #f8fafc;
      width: 150px;
    }

    #switchCameraButton img {
      width: 20px;
      margin-right: 10px;
    }

    #captureButton,
    #uploadButton,
    #retakeButton {
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      color: #ffffff;
      width: 150px;
    }

    #retakeButton {
      background: linear-gradient(135deg, #f97316, #ef4444);
      color: #ffffff;
    }

    button:disabled {
      background-color: rgba(148, 163, 184, 0.8);
      color: #1f2937;
      box-shadow: none;
      transform: none;
    }

    /* Upload loading spinner on button */
    .button-loading {
      position: relative;
      opacity: 0.8;
    }

    .button-loading::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      width: 14px;
      height: 14px;
      margin-top: -7px;
      border-radius: 50%;
      border: 2px solid #fff;
      border-top-color: transparent;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #errorLog {
      color: #0f172a;
      margin-top: 10px;
      font-size: 11px;
    }

    .footer-text {
      font-size: 12px;
      color: #0f172a;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }

    .app-footer {
      font-size: 10px;
      color: #f8fafc;
      margin-bottom: 10px;
      text-align: center;
    }

    .disclaimer {
      font-size: 10px;
      color: #1f2937;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 0;
      line-height: 1.4;
      width: 100%;
    }

    .disclaimer strong {
      text-decoration: underline;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }

    .btn-slot {
      position: relative;
    }

    .btn-slot button {
      width: 150px;
    }

    .logo-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 8px;
    }

    #topLogo {
      width: 70%;
      max-width: 260px;
      max-height: 140px;
      height: auto;
      display: block;
      object-fit: contain;
    }

    @media (max-height: 750px) {
      #topLogo {
        width: 72%;
        max-width: 240px;
        max-height: 120px;
      }
    }

    @media (max-width: 600px) {
      button {
        font-size: 12px;
        padding: 8px 16px;
      }

      #switchCameraButton img {
        width: 16px;
      }

      .camera-area {
        margin-top: 18px;
      }
    }

    /* Intro overlay */
    @keyframes intro-shake {
      0%   { transform: translateX(0); }
      20%  { transform: translateX(-6px); }
      40%  { transform: translateX(6px); }
      60%  { transform: translateX(-4px); }
      80%  { transform: translateX(4px); }
      100% { transform: translateX(0); }
    }

    .intro-box.shake {
      animation: intro-shake 0.35s ease;
    }

    #introModal {
      position: fixed;
      inset: 0;
      z-index: 999;
      display: flex;
    }

    .intro-backdrop {
      background: rgba(0, 0, 0, 0.75);
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .intro-box {
      background: #ffffff;
      border-radius: 12px;
      padding: 28px 22px;
      max-width: 340px;
      width: 85vw;
      text-align: center;
      display: flex;
      position: relative;
      flex-direction: column;
      justify-content: flex-start;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .intro-logo {
      width: 120px;
      max-width: 50%;
      margin: 0 auto 12px auto;
      display: block;
    }

    .intro-box h2 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #0f172a;
    }

    .intro-box p {
      margin: 0 0 16px;
      font-size: 13px;
      color: #444;
    }

    .intro-close {
      position: absolute;
      top: 8px;
      right: 10px;
      font-size: 20px;
      color: #888;
      cursor: pointer;
      font-weight: thin;
    }

    .intro-close:hover {
      color: #888888;
    }

    .landing-modal {
      position: fixed;
      inset: 0;
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      background: #ffffff;
      padding: 24px;
    }

    .landing-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: min(360px, 90vw);
      text-align: center;
    }

    .landing-logo {
      width: 200px;
      max-width: 85%;
      height: auto;
    }

    .landing-logo.secondary {
      width: 120px;
      max-width: 55%;
      margin-top: 40px;
    }

    .landing-button {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      color: #ffffff;
    }

    .landing-button.secondary {
      background: #f3f4f6;
      color: #111827;
    }

    #countrySelect,
    #regionSelect,
    #lastNameInput,
    #emailInput {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    #countrySelect,
    #regionSelect {
      background: #fff;
    }

    #lastNameInput,
    #emailInput {
      margin-bottom: 0;
    }

    .intro-field {
      margin-bottom: 14px;
    }

    .intro-label {
      display: block;
      font-size: 12px;
      color: #444;
      margin-bottom: 6px;
      font-weight: 600;
    }

    #locationFields {
      margin-bottom: 14px;
    }

    .intro-buttons {
      display: flex;
      justify-content: center;
    }

    #submitIntroButton {
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      text-transform: uppercase;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      color: #fff;
      width: 100%;
    }

    .intro-error {
      margin-top: 8px;
      font-size: 12px;
      color: #d32f2f;
    }

    .upload-status {
      font-size: 11px;
      color: #0f172a;
      text-align: center;
      margin-top: 4px;
      min-height: 14px;
    }

    .newsletter-label {
      font-size: 12px;
      color: #444;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
      text-align: left;
    }

    .newsletter-label input {
      margin-top: 2px;
    }

    .thank-you-toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1000;
      text-align: center;
      max-width: 90vw;
    }

    .thank-you-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .controls-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .orientation-hint {
      font-size: 11px;
      color: #475569;
      text-align: center;
      margin-top: 6px;
      opacity: 0.85;
    }

    @media (orientation: landscape) {
      .container {
        max-width: 1000px;
        margin-top: 40px;
      }

      .camera-controls-wrapper {
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
        gap: 35px;
        margin-top: 20px;
      }

      .camera-area {
        flex: 0 0 auto;
        width: 65%;
        max-width: 700px;
        aspect-ratio: 3 / 2;
        margin: 0 auto;
      }

      .controls-column {
        flex: 0 0 auto;
        width: 25%;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 40px;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }
    }

    /* TICKET OVERLAY (turno de foto) */
    .ticket-overlay {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: none;
    }

    .ticket-backdrop {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .ticket-card {
      background: #f5e6c8;
      border-radius: 18px;
      padding: 20px 18px 18px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      position: relative;
      text-align: center;
      border: 2px dashed #b48a3a;
    }

    .ticket-tag {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #8a5a16;
      margin-bottom: 6px;
    }

    .ticket-number {
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      font-size: 40px;
      letter-spacing: 0.12em;
      color: #2b1a07;
      margin: 4px 0 8px;
    }

    .ticket-text {
      font-size: 13px;
      color: #3f2a11;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .ticket-note {
      font-size: 11px;
      color: #6b4a1e;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    .ticket-close-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #3ca360;
      color: #ffffff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
      cursor: pointer;
    }

    .ticket-close-button:active {
      transform: scale(0.98);
    }

    .app-offline-overlay {
      position: fixed;
      inset: 0;
      background: rgba(8, 16, 30, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #f8fafc;
      padding: 24px;
      z-index: 9999;
    }

    .app-offline-overlay h2 {
      font-size: 20px;
      margin-bottom: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .app-offline-overlay p {
      font-size: 14px;
      max-width: 520px;
      line-height: 1.5;
    }

    body.app-offline .app-offline-overlay {
      display: flex;
    }

    body.app-offline .container,
    body.app-offline #introModal,
    body.app-offline #ticketOverlay {
      pointer-events: none;
      filter: grayscale(0.6);
    }

    .language-modal {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(5, 10, 20, 0.9);
      padding: 24px;
    }

    .language-card {
      background: #ffffff;
      color: #111827;
      border-radius: 14px;
      padding: 24px 20px;
      width: min(360px, 90vw);
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .language-card h2 {
      margin: 0 0 16px;
      font-size: 18px;
    }

    .language-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .language-button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      color: #f8fafc;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: 'HelveticaNowTextExtraBold', Arial, sans-serif;
    }

    .language-button.secondary {
      background: #f3f4f6;
      color: #111827;
    }
  </style>
</head>
<body>
  <div id="offlineOverlay" class="app-offline-overlay">
    <div>
      <h2 id="offlineTitle">Servicio no disponible</h2>
      <p id="offlineMessage">
        Lo lamentamos, el servicio no est√° disponible en estos momentos. Favor intentarlo luego.
      </p>
    </div>
  </div>
  <div id="landingModal" class="landing-modal">
    <div class="landing-card">
      <img src="Assets/Somos Mayaguez Logo.png" alt="Somos Mayag√ºez" class="landing-logo" />
      <button class="landing-button" id="landingPhotoAppBtn">Mayag√ºez Photo App</button>
      <button class="landing-button secondary" id="landingWebsiteBtn">Visit Our Website</button>
      <img src="Assets/Fitur_Logo.png" alt="Fitur" class="landing-logo secondary" />
    </div>
  </div>
  <div id="languageModal" class="language-modal">
    <div class="language-card">
      <h2>Selecciona idioma / Select language</h2>
      <div class="language-actions">
        <button class="language-button" data-language="es">Espa√±ol</button>
        <button class="language-button secondary" data-language="en">English</button>
      </div>
    </div>
  </div>
  <!-- Intro overlay -->
  <div id="introModal" style="display:none;">
    <div class="intro-backdrop">
      <div class="intro-box">
        <div class="intro-close" id="introClose">√ó</div>
        <img src="Assets/Fitur_Logo.png" alt="Fitur" class="intro-logo" />

        <h2 id="introTitle">¬øDesde d√≥nde nos visitas? üòä</h2>
        <p id="introSubtitle">
          Selecciona tu pa√≠s y municipio/estado, escribe tus apellidos y contin√∫a a tu selfie.
        </p>

        <div id="locationFields">
          <select id="countrySelect">
            <option value="">Selecciona tu pa√≠s</option>
          </select>

          <select id="regionSelect" disabled>
            <option value="">Selecciona tu municipio/estado</option>
          </select>
        </div>

        <div class="intro-field" id="lastNameField">
          <label for="lastNameInput" class="intro-label" id="lastNameLabel">Apellidos de la familia</label>
          <input type="text" id="lastNameInput" placeholder="Apellidos de la familia (Ej. P√©rez Gonz√°lez)">
        </div>

        <div class="intro-field" id="emailField">
          <label for="emailInput" class="intro-label" id="emailLabel">Correo electr√≥nico</label>
          <input
            type="email"
            id="emailInput"
            placeholder="Correo electr√≥nico"
            required
            pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$"
          />
        </div>

        <div class="intro-field" id="newsletterField">
          <label class="newsletter-label" id="newsletterLabel">
            <input type="checkbox" id="newsletterOptIn">
            <span id="newsletterLabelText">Deseo recibir noticias y ofertas de Municipio de Mayag√ºez.</span>
          </label>

          <p id="newsletterHelper" style="font-size:9px; color:#666; margin:2px 0 12px;">
            Tu email ser√° utilizado √∫nicamente si autorizas recibir nuestro bolet√≠n.
          </p>
        </div>

        <div class="intro-buttons">
          <button id="submitIntroButton">CONTINUAR</button>
        </div>
        <div id="introError" class="intro-error"></div>
      </div>
    </div>
  </div>

  <!-- Main container -->
  <div class="container">
    <div class="logo-wrapper">
      <img id="topLogo" src="Assets/Somos Mayaguez Logo.png" alt="Somos Mayag√ºez">
    </div>

    <!-- Camera + controls wrapper for responsive layout -->
    <div class="camera-controls-wrapper">
      <div class="camera-area" id="cameraArea">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div class="controls-column">
        <div class="button-group">
          <div class="btn-slot">
            <button id="switchCameraButton">
              <img src="Assets/Camera Switch Icon.png" alt="Switch Icon">VOLTEAR
            </button>
            <button id="retakeButton" style="display:none;">RETOMAR</button>
          </div>

          <div class="btn-slot">
            <button id="captureButton">¬°TOMAR SELFIE!</button>
            <button id="uploadButton" style="display:none;">SUBIR FOTO</button>
          </div>
        </div>

        <div id="uploadStatus" class="upload-status"></div>
        <div id="orientationHint" class="orientation-hint">
          Para mejores resultados, gira tu tel√©fono a posici√≥n horizontal antes de tomar la foto.
        </div>
        <div id="errorLog"></div>
      </div>
    </div>

    <div class="footer-text" id="footerText">Municipio de Mayag√ºez.</div>

    <div class="disclaimer" id="disclaimerText">
      Al tomar una foto, aceptas que ser√° mostrada p√∫blicamente en la pantalla durante el evento.
      <strong>Sube solo contenido apropiado para un ambiente familiar.</strong>
      Las im√°genes subidas podr√°n ser utilizadas en las redes sociales del Municipio de Mayag√ºez.
    </div>
  </div>

  <div class="footer-text app-footer" id="appFooter">
    Luminar Apps<br>¬© 2025 LMNR Group LLC. All rights reserved.
  </div>

  <div id="thankYouToast" class="thank-you-toast"></div>

  <!-- Ticket overlay (turno de foto) -->
  <div id="ticketOverlay" class="ticket-overlay">
    <div class="ticket-backdrop">
      <div class="ticket-card">
        <div class="ticket-tag" id="ticketTag">FOTO RECIBIDA</div>
        <div id="ticketNumber" class="ticket-number">#000</div>
        <div id="ticketText" class="ticket-text">
          Tu n√∫mero de turno es el que ves en este boleto.
        </div>
        <div class="ticket-note" id="ticketNote">
          Tu foto ser√° mostrada en la pantalla principal en los pr√≥ximos minutos.
          Conserva este n√∫mero para verificar tu turno.
        </div>
        <div class="ticket-disclaimer" id="ticketDisclaimer" style="font-size:11px; color:#6b4a1e; margin-top:6px; line-height:1.4;">
          Nota: Tu foto ser√° mostrada en la pantalla principal <strong>una vez sea aprobada por el equipo del evento</strong>.  
          Algunas fotos podr√≠an no ser utilizadas.
        </div>
        <button id="ticketClose" class="ticket-close-button">
          LISTO
        </button>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('captureButton');
    const uploadButton = document.getElementById('uploadButton');
    const retakeButton = document.getElementById('retakeButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const errorLog = document.getElementById('errorLog');
    const introModal = document.getElementById('introModal');
    const introClose = document.getElementById('introClose');
    const introTitle = document.getElementById('introTitle');
    const introSubtitle = document.getElementById('introSubtitle');
    const countrySelect = document.getElementById('countrySelect');
    const regionSelect = document.getElementById('regionSelect');
    const locationFields = document.getElementById('locationFields');
    const lastNameField = document.getElementById('lastNameField');
    const lastNameInput = document.getElementById('lastNameInput');
    const lastNameLabel = document.getElementById('lastNameLabel');
    const emailField = document.getElementById('emailField');
    const emailInput = document.getElementById('emailInput');
    const emailLabel = document.getElementById('emailLabel');
    const newsletterField = document.getElementById('newsletterField');
    const newsletterLabel = document.getElementById('newsletterLabel');
    const newsletterLabelText = document.getElementById('newsletterLabelText');
    const newsletterHelper = document.getElementById('newsletterHelper');
    const submitIntroButton = document.getElementById('submitIntroButton');
    const introError = document.getElementById('introError');
    const introBox = document.querySelector('.intro-box');
    const uploadStatus = document.getElementById('uploadStatus');
    const thankYouToast = document.getElementById('thankYouToast');
    const cameraArea = document.getElementById('cameraArea');

    const ticketOverlay = document.getElementById('ticketOverlay');
    const ticketNumberEl = document.getElementById('ticketNumber');
    const ticketTextEl = document.getElementById('ticketText');
    const ticketCloseBtn = document.getElementById('ticketClose');
    const offlineOverlay = document.getElementById('offlineOverlay');
    const landingModal = document.getElementById('landingModal');
    const landingPhotoAppBtn = document.getElementById('landingPhotoAppBtn');
    const landingWebsiteBtn = document.getElementById('landingWebsiteBtn');
    const offlineTitle = document.getElementById('offlineTitle');
    const offlineMessage = document.getElementById('offlineMessage');
    const languageModal = document.getElementById('languageModal');
    const orientationHint = document.getElementById('orientationHint');
    const footerText = document.getElementById('footerText');
    const disclaimerText = document.getElementById('disclaimerText');
    const appFooter = document.getElementById('appFooter');
    const ticketTag = document.getElementById('ticketTag');
    const ticketNote = document.getElementById('ticketNote');
    const ticketDisclaimer = document.getElementById('ticketDisclaimer');

    let currentFacingMode = 'user';           // Start with front camera
    let currentStream = null;                 // Active MediaStream
    const BACKEND_URL = 'https://mayaguez-photoapp.vercel.app';
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent); // <<< NEW

    let photoCounter = 1;
    let lastCaptureWasPortrait = false;
    let hasShownPortraitWarning = false;
    let shouldShowIntro = true;
    let appIsEnabled = true;
    let currentLanguage = 'es';
    let currentServerSessionId = null;

    const LANGUAGE_STORAGE_KEY = 'lumi_language';
    const FORM_SUBMITTED_KEY = 'lumi_form_submitted';
    const SERVER_SESSION_KEY = 'lumi_server_session_id';

    function setAppAvailability(enabled) {
      appIsEnabled = enabled;
      document.body.classList.toggle('app-offline', !enabled);
      if (offlineOverlay) {
        offlineOverlay.setAttribute('aria-hidden', enabled ? 'true' : 'false');
      }
      if (!enabled && landingModal) {
        landingModal.style.display = 'none';
      }
      if (!enabled && introModal) {
        introModal.style.display = 'none';
      }
      if (!enabled && languageModal) {
        languageModal.style.display = 'none';
      }
      if (!enabled && currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }

    const COPY = {
      es: {
        pageTitle: '¬°Mayag√ºez en Fitur!',
        offlineTitle: 'Servicio no disponible',
        offlineMessage:
          'Lo lamentamos, el servicio no est√° disponible en estos momentos. Favor intentarlo luego.',
        introTitle: '¬øDesde d√≥nde nos visitas?',
        introSubtitle:
          'Selecciona tu pa√≠s y municipio/estado, escribe tus apellidos y contin√∫a a tu selfie.',
        countryPlaceholder: 'Selecciona tu pa√≠s',
        countryPR: 'Puerto Rico',
        countryUS: 'Estados Unidos',
        countrySpain: 'Espa√±a',
        regionPlaceholder: 'Selecciona tu municipio/estado',
        regionPlaceholderPR: 'Selecciona tu municipio',
        regionPlaceholderUS: 'Selecciona tu estado',
        lastNameLabel: 'Apellidos de la familia',
        lastNamePlaceholder: 'Apellidos de la familia (Ej. P√©rez Gonz√°lez)',
        emailLabel: 'Correo electr√≥nico',
        emailPlaceholder: 'Correo electr√≥nico',
        newsletterLabel: 'Deseo recibir noticias y ofertas de Municipio de Mayag√ºez.',
        newsletterHelper: 'Tu email ser√° utilizado √∫nicamente si autorizas recibir nuestro bolet√≠n.',
        submitIntro: 'CONTINUAR',
        submitIntroSending: 'ENVIANDO...',
        switchCamera: 'VOLTEAR',
        capture: '¬°TOMAR SELFIE!',
        upload: 'SUBIR FOTO',
        uploadingButton: 'SUBIENDO...',
        retake: 'RETOMAR',
        uploadSending: 'Subiendo foto, por favor espera...',
        uploadSuccess: '¬°Foto subida correctamente!',
        uploadDone: 'SUBIDA',
        uploadError: 'Hubo un error. Intenta nuevamente.',
        uploadErrorDetail: 'Error al subir la foto: ',
        uploadOffline:
          'Servicio no disponible en estos momentos. Intenta nuevamente m√°s tarde.',
        cameraError: 'Error de c√°mara: ',
        cameraNotReady: 'Error: C√°mara no lista',
        orientationHint:
          'Para mejores resultados, gira tu tel√©fono a posici√≥n horizontal antes de tomar la foto.',
        footerText: 'Municipio de Mayag√ºez.',
        disclaimer:
          'Al tomar una foto, aceptas que ser√° mostrada p√∫blicamente en la pantalla durante el evento. ' +
          '<strong>Sube solo contenido apropiado para un ambiente familiar.</strong> ' +
          'Las im√°genes subidas podr√°n ser utilizadas en las redes sociales del Municipio de Mayag√ºez.',
        appFooter: 'Luminar Apps<br>¬© 2025 LMNR Group LLC. Todos los derechos reservados.',
        thankYouIntro: '¬°Gracias por registrarte! Ahora toma tu selfie.',
        thankYouCloseIntro: 'Puedes tomar tu selfie cuando est√©s listo.',
        thankYouTicket: '¬°Gracias! Guarda tu n√∫mero de turno.',
        thankYouNoTicket: '¬°Gracias! Tu foto ha sido enviada.',
        portraitConfirm:
          'Tu foto se ve vertical y podr√≠a salir recortada en la pantalla.\n\n' +
          '¬øQuieres subirla as√≠ de todos modos?\n\n' +
          'Pulsa "Aceptar" para subirla as√≠, o "Cancelar" para volver y retomar la foto.',
        portraitCancel:
          'Te recomendamos girar tu tel√©fono a horizontal y volver a tomar la foto.',
        introOfflineError:
          'El servicio no est√° disponible en estos momentos. Intenta nuevamente m√°s tarde.',
        introEmailError: 'Por favor escribe un correo electr√≥nico v√°lido.',
        introFieldError: 'Por favor completa todos los campos para continuar.',
        introSubmitError: 'Hubo un error al enviar tus datos. Intenta de nuevo.',
        ticketTag: 'FOTO RECIBIDA',
        ticketText: 'Tu n√∫mero de turno es el que ves en este boleto.',
        ticketNote:
          'Tu foto ser√° mostrada en la pantalla principal en los pr√≥ximos minutos. Conserva este n√∫mero para verificar tu turno.',
        ticketDisclaimer:
          'Nota: Tu foto ser√° mostrada en la pantalla principal <strong>una vez sea aprobada por el equipo del evento</strong>. Algunas fotos podr√≠an no ser utilizadas.',
        ticketClose: 'LISTO'
      },
      en: {
        pageTitle: '¬°Mayag√ºez en Fitur!',
        offlineTitle: 'Service unavailable',
        offlineMessage:
          'We‚Äôre sorry, the service is not available right now. Please try again later.',
        introTitle: 'Where are you visiting us from?',
        introSubtitle:
          'Choose your country and city/state, enter your family name, and continue to your selfie.',
        countryPlaceholder: 'Select your country',
        countryPR: 'Puerto Rico',
        countryUS: 'United States',
        countrySpain: 'Spain',
        regionPlaceholder: 'Select your city/state',
        regionPlaceholderPR: 'Select your city',
        regionPlaceholderUS: 'Select your state',
        lastNameLabel: 'Family last name',
        lastNamePlaceholder: 'Family last name (Ex. Smith Johnson)',
        emailLabel: 'Email address',
        emailPlaceholder: 'Email address',
        newsletterLabel: 'I want to receive news and offers from the Municipality of Mayag√ºez.',
        newsletterHelper: 'Your email will only be used if you choose to receive our newsletter.',
        submitIntro: 'CONTINUE',
        submitIntroSending: 'SENDING...',
        switchCamera: 'SWITCH',
        capture: 'TAKE SELFIE!',
        upload: 'UPLOAD PHOTO',
        uploadingButton: 'UPLOADING...',
        retake: 'RETAKE',
        uploadSending: 'Uploading photo, please wait...',
        uploadSuccess: 'Photo uploaded successfully!',
        uploadDone: 'UPLOADED',
        uploadError: 'There was an error. Please try again.',
        uploadErrorDetail: 'Error uploading photo: ',
        uploadOffline: 'Service is unavailable right now. Please try again later.',
        cameraError: 'Camera error: ',
        cameraNotReady: 'Error: Camera not ready',
        orientationHint:
          'For best results, rotate your phone to landscape before taking the photo.',
        footerText: 'Municipality of Mayag√ºez.',
        disclaimer:
          'By taking a photo, you agree it may be shown publicly on the event screen. ' +
          '<strong>Please upload only family-friendly content.</strong> ' +
          'Uploaded images may be used on the Municipality of Mayag√ºez social media.',
        appFooter: 'Luminar Apps<br>¬© 2025 LMNR Group LLC. All rights reserved.',
        thankYouIntro: 'Thanks for registering! Now take your selfie.',
        thankYouCloseIntro: 'You can take your selfie whenever you are ready.',
        thankYouTicket: 'Thank you! Save your ticket number.',
        thankYouNoTicket: 'Thank you! Your photo has been sent.',
        portraitConfirm:
          'Your photo looks vertical and may be cropped on the screen.\n\n' +
          'Would you like to upload it anyway?\n\n' +
          'Press "OK" to upload, or "Cancel" to go back and retake.',
        portraitCancel:
          'We recommend rotating your phone to landscape and retaking the photo.',
        introOfflineError:
          'Service is unavailable right now. Please try again later.',
        introEmailError: 'Please enter a valid email address.',
        introFieldError: 'Please complete all fields to continue.',
        introSubmitError: 'There was an error sending your data. Please try again.',
        ticketTag: 'PHOTO RECEIVED',
        ticketText: 'Your ticket number is shown on this ticket.',
        ticketNote:
          'Your photo will appear on the main screen in the next few minutes. Keep this number to track your turn.',
        ticketDisclaimer:
          'Note: Your photo will appear on the main screen <strong>once approved by the event team</strong>. Some photos may not be used.',
        ticketClose: 'DONE'
      }
    };

    function t(key) {
      return COPY[currentLanguage]?.[key] || COPY.es[key] || '';
    }

    function applyLanguage(lang) {
      currentLanguage = lang;
      document.documentElement.lang = lang;
      document.title = t('pageTitle');

      const useSettings = currentLanguage === 'es' ? appSettings : null;
      const introTitleText = useSettings?.intro?.title || t('introTitle');
      const introSubtitleText = useSettings?.intro?.subtitle || t('introSubtitle');
      const lastNameLabelText = useSettings?.form?.lastName?.label || t('lastNameLabel');
      const lastNamePlaceholderText =
        useSettings?.form?.lastName?.placeholder || t('lastNamePlaceholder');
      const emailLabelText = useSettings?.form?.email?.label || t('emailLabel');
      const emailPlaceholderText =
        useSettings?.form?.email?.placeholder || t('emailPlaceholder');
      const newsletterLabelTextValue =
        useSettings?.form?.newsletter?.label || t('newsletterLabel');
      const newsletterHelperTextValue =
        useSettings?.form?.newsletter?.helper || t('newsletterHelper');

      if (offlineTitle) offlineTitle.textContent = t('offlineTitle');
      if (offlineMessage) offlineMessage.textContent = t('offlineMessage');
      if (introTitle) introTitle.textContent = introTitleText;
      if (introSubtitle) introSubtitle.textContent = introSubtitleText;
      if (lastNameLabel) lastNameLabel.textContent = lastNameLabelText;
      if (lastNameInput) lastNameInput.placeholder = lastNamePlaceholderText;
      if (emailLabel) emailLabel.textContent = emailLabelText;
      if (emailInput) emailInput.placeholder = emailPlaceholderText;
      if (newsletterLabelText) newsletterLabelText.textContent = newsletterLabelTextValue;
      if (newsletterHelper) newsletterHelper.textContent = newsletterHelperTextValue;
      if (submitIntroButton) submitIntroButton.textContent = t('submitIntro');
      if (switchCameraButton) {
        switchCameraButton.innerHTML =
          `<img src="Assets/Camera Switch Icon.png" alt="Switch Icon">${t('switchCamera')}`;
      }
      if (captureButton) captureButton.textContent = t('capture');
      if (uploadButton) {
        uploadButton.textContent = t('upload');
      }
      if (retakeButton) retakeButton.textContent = t('retake');
      if (orientationHint) orientationHint.textContent = t('orientationHint');
      if (footerText) footerText.textContent = t('footerText');
      if (disclaimerText) disclaimerText.innerHTML = t('disclaimer');
      if (appFooter) appFooter.innerHTML = t('appFooter');
      if (ticketTag) ticketTag.textContent = t('ticketTag');
      if (ticketTextEl) ticketTextEl.textContent = t('ticketText');
      if (ticketNote) ticketNote.textContent = t('ticketNote');
      if (ticketDisclaimer) ticketDisclaimer.innerHTML = t('ticketDisclaimer');
      if (ticketCloseBtn) ticketCloseBtn.textContent = t('ticketClose');

      if (countrySelect) {
        populateCountryOptions(countrySelect.value);
      }
      if (regionSelect) {
        populateRegionOptions(countrySelect.value, regionSelect.value);
      }
    }
    const DEFAULT_APP_SETTINGS = {
      ticketEnabled: true,
      intro: {
        title: '¬øDesde d√≥nde nos visitas? üòä',
        subtitle: 'Selecciona tu pa√≠s y municipio/estado, escribe tus apellidos y contin√∫a a tu selfie.'
      },
      form: {
        locationEnabled: true,
        lastName: {
          enabled: true,
          label: 'Apellidos de la familia',
          placeholder: 'Apellidos de la familia (Ej. P√©rez Gonz√°lez)'
        },
        email: {
          enabled: true,
          label: 'Correo electr√≥nico',
          placeholder: 'Correo electr√≥nico'
        },
        newsletter: {
          enabled: true,
          label: 'Deseo recibir noticias y ofertas de Municipio de Mayag√ºez.',
          helper: 'Tu email ser√° utilizado √∫nicamente si autorizas recibir nuestro bolet√≠n.'
        }
      }
    };

    let appSettings = JSON.parse(JSON.stringify(DEFAULT_APP_SETTINGS));

    function syncServerSession(sessionId) {
      if (!sessionId) return;
      const storedSession = localStorage.getItem(SERVER_SESSION_KEY);
      if (storedSession && storedSession !== sessionId) {
        localStorage.removeItem(LANGUAGE_STORAGE_KEY);
        localStorage.removeItem(FORM_SUBMITTED_KEY);
        localStorage.removeItem('lumi_session_id');
      }
      localStorage.setItem(SERVER_SESSION_KEY, sessionId);
      currentServerSessionId = sessionId;
    }

    function showLanguageModal() {
      if (languageModal) {
        languageModal.style.display = 'flex';
      }
    }

    function hideLanguageModal() {
      if (languageModal) {
        languageModal.style.display = 'none';
      }
    }

    function showLandingModal() {
      if (landingModal) {
        landingModal.style.display = 'flex';
      }
    }

    function hideLandingModal() {
      if (landingModal) {
        landingModal.style.display = 'none';
      }
    }

    function initializeLanguage() {
      const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY);
      if (storedLanguage) {
        applyLanguage(storedLanguage);
        return true;
      }
      return false;
    }

    function finalizeIntroFlow() {
      if (!appIsEnabled) return;
      const hasSubmitted = localStorage.getItem(FORM_SUBMITTED_KEY) === currentServerSessionId;
      if (shouldShowIntro && !hasSubmitted) {
        introModal.style.display = 'flex';
      } else {
        introModal.style.display = 'none';
        setupCamera(currentFacingMode);
      }
    }

    // Preload flag images
    const flagImages = {
      PR: new Image(),
      US: new Image()
    };
    flagImages.PR.src = 'Assets/pr_flag.png';
    flagImages.US.src = 'Assets/us_flag.png';

    const fiturLogoImage = new Image();
    fiturLogoImage.src = 'Assets/Fitur_Logo.png';

    // --- REGION DATA ---

    const PR_MUNICIPALITIES = [
      "Adjuntas","Aguada","Aguadilla","Aguas Buenas","Aibonito","A√±asco","Arecibo",
      "Arroyo","Barceloneta","Barranquitas","Bayam√≥n","Cabo Rojo","Caguas","Camuy",
      "Can√≥vanas","Carolina","Cata√±o","Cayey","Ceiba","Ciales","Cidra","Coamo",
      "Comer√≠o","Corozal","Culebra","Dorado","Fajardo","Florida","Gu√°nica","Guayama",
      "Guayanilla","Guaynabo","Gurabo","Hatillo","Hormigueros","Humacao","Isabela",
      "Jayuya","Juana D√≠az","Juncos","Lajas","Lares","Las Mar√≠as","Las Piedras",
      "Lo√≠za","Luquillo","Manat√≠","Maricao","Maunabo","Mayag√ºez","Moca","Morovis",
      "Naguabo","Naranjito","Orocovis","Patillas","Pe√±uelas","Ponce","Quebradillas",
      "Rinc√≥n","R√≠o Grande","Sabana Grande","Salinas","San Germ√°n","San Juan",
      "San Lorenzo","San Sebasti√°n","Santa Isabel","Toa Alta","Toa Baja","Trujillo Alto",
      "Utuado","Vega Alta","Vega Baja","Vieques","Villalba","Yabucoa","Yauco"
    ];

    const US_STATES = [
      "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut",
      "Delaware","Florida","Georgia","Hawaii","Idaho","Illinois","Indiana","Iowa",
      "Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts","Michigan",
      "Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
      "New Hampshire","New Jersey","New Mexico","New York","North Carolina",
      "North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island",
      "South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont",
      "Virginia","Washington","West Virginia","Wisconsin","Wyoming"
    ];

    const PINNED_COUNTRIES = ['Puerto Rico', 'United States', 'Spain'];
    const ALL_COUNTRIES = [
      'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina',
      'Armenia','Australia','Austria','Azerbaijan','Bahamas','Bahrain','Bangladesh','Barbados',
      'Belarus','Belgium','Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana',
      'Brazil','Brunei','Bulgaria','Burkina Faso','Burundi','Cabo Verde','Cambodia','Cameroon',
      'Canada','Central African Republic','Chad','Chile','China','Colombia','Comoros','Congo',
      'Costa Rica','Croatia','Cuba','Cyprus','Czech Republic','Denmark','Djibouti','Dominica',
      'Dominican Republic','Ecuador','Egypt','El Salvador','Equatorial Guinea','Eritrea','Estonia',
      'Eswatini','Ethiopia','Fiji','Finland','France','Gabon','Gambia','Georgia','Germany','Ghana',
      'Greece','Grenada','Guatemala','Guinea','Guinea-Bissau','Guyana','Haiti','Honduras','Hungary',
      'Iceland','India','Indonesia','Iran','Iraq','Ireland','Israel','Italy','Jamaica','Japan',
      'Jordan','Kazakhstan','Kenya','Kiribati','Kosovo','Kuwait','Kyrgyzstan','Laos','Latvia',
      'Lebanon','Lesotho','Liberia','Libya','Liechtenstein','Lithuania','Luxembourg','Madagascar',
      'Malawi','Malaysia','Maldives','Mali','Malta','Marshall Islands','Mauritania','Mauritius',
      'Mexico','Micronesia','Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique',
      'Myanmar','Namibia','Nauru','Nepal','Netherlands','New Zealand','Nicaragua','Niger',
      'Nigeria','North Korea','North Macedonia','Norway','Oman','Pakistan','Palau','Panama',
      'Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal','Qatar','Romania',
      'Russia','Rwanda','Saint Kitts and Nevis','Saint Lucia','Saint Vincent and the Grenadines',
      'Samoa','San Marino','Sao Tome and Principe','Saudi Arabia','Senegal','Serbia','Seychelles',
      'Sierra Leone','Singapore','Slovakia','Slovenia','Solomon Islands','Somalia','South Africa',
      'South Korea','South Sudan','Sri Lanka','Sudan','Suriname','Sweden','Switzerland','Syria',
      'Taiwan','Tajikistan','Tanzania','Thailand','Timor-Leste','Togo','Tonga','Trinidad and Tobago',
      'Tunisia','Turkey','Turkmenistan','Tuvalu','Uganda','Ukraine','United Arab Emirates',
      'United Kingdom','United States','Uruguay','Uzbekistan','Vanuatu','Vatican City','Venezuela',
      'Vietnam','Yemen','Zambia','Zimbabwe'
    ];

    function getCountryLabel(country) {
      if (country === 'Puerto Rico') return t('countryPR');
      if (country === 'United States') return t('countryUS');
      if (country === 'Spain') return t('countrySpain');
      return country;
    }

    function populateCountryOptions(selected) {
      if (!countrySelect) return;
      const selectedValue = selected || '';
      countrySelect.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = t('countryPlaceholder');
      countrySelect.appendChild(placeholder);

      const pinned = PINNED_COUNTRIES.map((country) => ({
        value: country,
        label: getCountryLabel(country)
      }));

      const rest = ALL_COUNTRIES.filter(
        (country) => !PINNED_COUNTRIES.includes(country)
      ).map((country) => ({
        value: country,
        label: getCountryLabel(country)
      }));

      [...pinned, ...rest].forEach((entry) => {
        const opt = document.createElement('option');
        opt.value = entry.value;
        opt.textContent = entry.label;
        countrySelect.appendChild(opt);
      });

      if (selectedValue) {
        countrySelect.value = selectedValue;
      }
    }

    function populateRegionOptions(country, preselected) {
      regionSelect.innerHTML = '';
      let list = [];

      if (country === 'Puerto Rico') {
        list = PR_MUNICIPALITIES;
      } else if (country === 'Estados Unidos' || country === 'United States') {
        list = US_STATES;
      }

      if (!country || list.length === 0) {
        regionSelect.disabled = true;
        regionSelect.innerHTML = `<option value="">${t('regionPlaceholder')}</option>`;
        return;
      }

      regionSelect.disabled = false;
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = country === 'Puerto Rico'
        ? t('regionPlaceholderPR')
        : t('regionPlaceholderUS');
      regionSelect.appendChild(placeholder);

      list.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        regionSelect.appendChild(opt);
      });

      if (preselected && list.includes(preselected)) {
        regionSelect.value = preselected;
      }
    }

    function applySettings(settings) {
      appSettings = JSON.parse(JSON.stringify({
        ...DEFAULT_APP_SETTINGS,
        ...settings,
        intro: {
          ...DEFAULT_APP_SETTINGS.intro,
          ...(settings?.intro || {})
        },
        form: {
          ...DEFAULT_APP_SETTINGS.form,
          ...(settings?.form || {}),
          lastName: {
            ...DEFAULT_APP_SETTINGS.form.lastName,
            ...(settings?.form?.lastName || {})
          },
          email: {
            ...DEFAULT_APP_SETTINGS.form.email,
            ...(settings?.form?.email || {})
          },
          newsletter: {
            ...DEFAULT_APP_SETTINGS.form.newsletter,
            ...(settings?.form?.newsletter || {})
          }
        }
      }));

      if (locationFields) {
        locationFields.style.display = appSettings.form.locationEnabled ? 'block' : 'none';
      }

      if (lastNameField) {
        lastNameField.style.display = appSettings.form.lastName.enabled ? 'block' : 'none';
      }

      if (emailField) {
        emailField.style.display = appSettings.form.email.enabled ? 'block' : 'none';
      }
      if (emailInput) {
        emailInput.required = appSettings.form.email.enabled;
      }

      if (newsletterField) {
        newsletterField.style.display = appSettings.form.newsletter.enabled ? 'block' : 'none';
      }

      shouldShowIntro = Boolean(
        appSettings.form.locationEnabled ||
        appSettings.form.lastName.enabled ||
        appSettings.form.email.enabled ||
        appSettings.form.newsletter.enabled
      );

      applyLanguage(currentLanguage);
    }

    async function loadAppSettings() {
      try {
        const res = await fetch(`${BACKEND_URL}/app-settings`, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`Settings HTTP ${res.status}`);
        }
        const data = await res.json();
        if (data && typeof data.enabled === 'boolean') {
          setAppAvailability(data.enabled);
        } else {
          setAppAvailability(true);
        }
        if (data && data.sessionId) {
          syncServerSession(data.sessionId);
        }
        if (data && data.settings) {
          applySettings(data.settings);
          return;
        }
      } catch (err) {
        console.warn('Could not load app settings, using defaults.', err);
      }
      setAppAvailability(true);
      if (!currentServerSessionId) {
        syncServerSession(localStorage.getItem(SERVER_SESSION_KEY) || 'default');
      }
      applySettings(DEFAULT_APP_SETTINGS);
    }

    countrySelect.addEventListener('change', () => {
      populateRegionOptions(countrySelect.value, null);
    });

    document.querySelectorAll('[data-language]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-language');
        if (!lang) return;
        localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);
        applyLanguage(lang);
        hideLanguageModal();
        finalizeIntroFlow();
      });
    });

    if (landingPhotoAppBtn) {
      landingPhotoAppBtn.addEventListener('click', () => {
        hideLandingModal();
        const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY) || 'es';
        applyLanguage(storedLanguage);
        showLanguageModal();
      });
    }

    if (landingWebsiteBtn) {
      landingWebsiteBtn.addEventListener('click', () => {
        window.location.href = 'https://www.somosmayaguez.com/';
      });
    }

    function getPRDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc - 4 * 60 * 60000);
    }

    function buildPhotoFileName() {
      const prNow = getPRDate();

      const dd = String(prNow.getDate()).padStart(2, '0');
      const mm = String(prNow.getMonth() + 1).padStart(2, '0');
      const yy = String(prNow.getFullYear()).slice(-2);
      const HH = String(prNow.getHours()).padStart(2, '0');
      const MM = String(prNow.getMinutes()).padStart(2, '0');
      const SS = String(prNow.getSeconds()).padStart(2, '0');

      const num = String(photoCounter).padStart(2, '0');
      photoCounter++;

      return `${num}_${dd}_${mm}_${yy}-${HH}_${MM}_${SS}.jpeg`;
    }

    function showThankYou(message) {
      if (!thankYouToast) return;
      thankYouToast.textContent = message;
      thankYouToast.classList.add('show');
      setTimeout(() => {
        thankYouToast.classList.remove('show');
      }, 2500);
    }

    // --- Ticket helpers ---

    function formatTicketLabel(ticketFromServer) {
      if (ticketFromServer == null) return '';

      // If server sends "T001", "T12", etc ‚Üí turn into "#001"
      if (typeof ticketFromServer === 'string') {
        const m = ticketFromServer.match(/T?(\d{1,})/i);
        if (m) {
          return '#' + m[1].padStart(3, '0');
        }
        // Fallback: show raw string
        return ticketFromServer;
      }

      const n = Number(ticketFromServer);
      if (!Number.isFinite(n)) return String(ticketFromServer);
      return '#' + String(n).padStart(3, '0');
    }

    function showTicketOverlay(ticketNumber) {
      if (!ticketOverlay) return;
      const label = formatTicketLabel(ticketNumber);

      if (ticketNumberEl && label) {
        ticketNumberEl.textContent = label;
      }

      if (ticketTextEl) {
        ticketTextEl.textContent = t('ticketText');
      }

      ticketOverlay.style.display = 'flex';
    }

    function hideTicketOverlay() {
      if (!ticketOverlay) return;
      ticketOverlay.style.display = 'none';
    }

    if (ticketCloseBtn) {
      ticketCloseBtn.addEventListener('click', hideTicketOverlay);
    }

    if (ticketOverlay) {
      ticketOverlay.addEventListener('click', (e) => {
        if (e.target === ticketOverlay || e.target.classList.contains('ticket-backdrop')) {
          hideTicketOverlay();
        }
      });
    }

    async function setupCamera(facingMode = 'user') {
      try {
        // ANDROID/OTHERS: stop previous stream before opening new one.
        // iOS: KEEP previous stream (Safari can be picky with repeated stops).
        if (currentStream && !isIOS) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }

        const constraints = isIOS
          ? { video: { facingMode } }
          : {
              video: {
                facingMode: { ideal: facingMode },
                width: { ideal: 1080 },
                height: { ideal: 1440 }
              }
            };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;

        video.srcObject = stream;
        await video.play();

        // ‚úÖ Always mirror preview for front camera
        if (facingMode === 'user') {
          video.classList.add('front-unmirror'); // CSS: transform: scaleX(-1);
        } else {
          video.classList.remove('front-unmirror');
        }

        console.log('Actual video resolution:', video.videoWidth, video.videoHeight);
      } catch (error) {
        console.error('Camera error:', error);
        errorLog.textContent = `${t('cameraError')}${error.message}`;
      }
    }

    function switchCamera() {
      currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
      setupCamera(currentFacingMode);
    }

    function drawLocationOverlay(ctx, width, height) {
      const country = localStorage.getItem('lumi_country') || '';
      const region = localStorage.getItem('lumi_region') || '';

      if (!country && !region) return;

      let label = '';
      if (country && region) {
        label = `${region}, ${country}`;
      } else {
        label = country || region;
      }

      if (!label) return;

      const padding = 24;
      const flagWidth = 60;
      const flagHeight = 40;
      const gapBetween = 12;

      let flagImg = null;
      if (country === 'Puerto Rico') flagImg = flagImages.PR;
      if (country === 'Estados Unidos') flagImg = flagImages.US;

      ctx.save();

      ctx.font = 'bold 24px Arial';
      ctx.textBaseline = 'middle';
      const textMetrics = ctx.measureText(label);
      const textWidth = textMetrics.width;

      const sidePadding = 12;
      const topPadding = 8;
      const boxHeight = flagHeight + topPadding * 2;
      const contentWidth = flagWidth + gapBetween + textWidth;
      const boxWidth = contentWidth + sidePadding * 2;

      const boxX = width - padding - boxWidth;
      const boxY = padding;

      ctx.globalAlpha = 0.75;
      ctx.fillStyle = '#000000';
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

      const flagX = boxX + sidePadding;
      const flagY = boxY + topPadding;

      if (flagImg && flagImg.complete) {
        ctx.drawImage(flagImg, flagX, flagY, flagWidth, flagHeight);
      }

      ctx.fillStyle = '#ffffff';
      const textX = flagX + flagWidth + gapBetween;
      const textY = boxY + boxHeight / 2;

      ctx.shadowColor = 'rgba(0,0,0,0.8)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;

      ctx.fillText(label, textX, textY);
      ctx.restore();
    }

    function drawFiturSticker(ctx, width, height) {
      const stickerWidth = 180;
      const aspect = fiturLogoImage.width && fiturLogoImage.height
        ? fiturLogoImage.height / fiturLogoImage.width
        : 0.35;
      const stickerHeight = stickerWidth * aspect;
      const padding = 24;

      const x = padding;
      const y = height - padding - stickerHeight;

      ctx.save();
      ctx.globalAlpha = 0.95;
      if (fiturLogoImage.complete && fiturLogoImage.naturalWidth) {
        ctx.drawImage(fiturLogoImage, x, y, stickerWidth, stickerHeight);
      }
      ctx.restore();
    }

   // Capture selfie
captureButton.addEventListener('click', () => {
  const targetWidth  = 1500;
  const targetHeight = 1000;

  canvas.width  = targetWidth;
  canvas.height = targetHeight;

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const vw = video.videoWidth;
  const vh = video.videoHeight;

  if (!vw || !vh) {
    errorLog.textContent = t('cameraNotReady');
    return;
  }

  lastCaptureWasPortrait = vh > vw;

  const videoAspect  = vw / vh;
  const canvasAspect = targetWidth / targetHeight;

  let sx, sy, sWidth, sHeight;

  if (videoAspect > canvasAspect) {
    sHeight = vh;
    sWidth  = sHeight * canvasAspect;
    sx      = (vw - sWidth) / 2;
    sy      = 0;
  } else {
    sWidth  = vw;
    sHeight = sWidth / canvasAspect;
    sx      = 0;
    sy      = (vh - sHeight) / 2;
  }

  ctx.save();

  // ‚úÖ Mirror the captured image for ALL front cameras (iOS + Android)
  if (currentFacingMode === 'user') {
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
  }

  ctx.drawImage(
    video,
    sx, sy, sWidth, sHeight,
    0, 0, canvas.width, canvas.height
  );

  ctx.restore();

  drawLocationOverlay(ctx, canvas.width, canvas.height);
  drawFiturSticker(ctx, canvas.width, canvas.height);

  video.style.display = 'none';
  canvas.style.display = 'block';
  cameraArea.classList.add('preview-mode');

  switchCameraButton.style.display = 'none';
  retakeButton.style.display = 'inline-block';

  captureButton.style.display = 'none';
  uploadButton.style.display = 'inline-block';
});

    // Retake
    retakeButton.addEventListener('click', () => {
      video.style.display = 'block';
      canvas.style.display = 'none';
      cameraArea.classList.remove('preview-mode');

      switchCameraButton.style.display = 'inline-flex';
      retakeButton.style.display = 'none';

      uploadButton.style.display = 'none';
      captureButton.style.display = 'inline-block';

      uploadButton.disabled = false;
      uploadButton.textContent = t('upload');
      uploadButton.classList.remove('button-loading');
      uploadStatus.textContent = '';
      errorLog.textContent = '';
      hideTicketOverlay();
    });

    // Upload
    uploadButton.addEventListener('click', async () => {
      if (uploadButton.disabled) return;
      if (!appIsEnabled) {
        uploadStatus.textContent = t('uploadOffline');
        return;
      }

      if (lastCaptureWasPortrait && !hasShownPortraitWarning) {
        const proceed = window.confirm(t('portraitConfirm'));
        if (!proceed) {
          uploadStatus.textContent = t('portraitCancel');
          return;
        }
        hasShownPortraitWarning = true;
      }

      uploadButton.disabled = true;
      uploadButton.textContent = t('uploadingButton');
      uploadButton.classList.add('button-loading');
      uploadStatus.textContent = t('uploadSending');
      errorLog.textContent = '';

      canvas.toBlob(async (blob) => {
        try {
          const response = await fetch(`${BACKEND_URL}/upload`, {
            method: 'POST',
            headers: {
              'Content-Type': blob.type,
              'X-File-Name': buildPhotoFileName(),
              'x-session-id': getSessionId()
            },
            body: blob
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Upload successful:', result);

          uploadStatus.textContent = t('uploadSuccess');
          uploadButton.textContent = t('uploadDone');
          uploadButton.classList.remove('button-loading');

          const ticketNumber =
            result.ticketLabel ??
            result.ticketIndex ??
            result.ticketNumber ??
            result.ticket ??
            result.photoIndex ??
            null;

          if (appSettings.ticketEnabled && ticketNumber !== null && ticketNumber !== undefined) {
            showTicketOverlay(ticketNumber);
            showThankYou(t('thankYouTicket'));
          } else {
            showThankYou(t('thankYouNoTicket'));
          }
        } catch (error) {
          console.error('Upload error:', error);
          errorLog.textContent = `${t('uploadErrorDetail')}${error.message}`;

          uploadButton.disabled = false;
          uploadButton.textContent = t('upload');
          uploadButton.classList.remove('button-loading');
          uploadStatus.textContent = t('uploadError');
        }
      }, 'image/jpeg');
    });

    switchCameraButton.addEventListener('click', switchCamera);

    // Intro / registration
    function startCameraAfterIntro() {
      if (!appIsEnabled) return;
      introModal.style.display = 'none';
      setupCamera(currentFacingMode);
    }

    introClose.addEventListener('click', () => {
      startCameraAfterIntro();
      showThankYou(t('thankYouCloseIntro'));
    });

    submitIntroButton.addEventListener('click', async () => {
      if (submitIntroButton.disabled) return;
      if (!appIsEnabled) {
        introError.textContent = t('introOfflineError');
        return;
      }

      const locationEnabled = appSettings.form.locationEnabled;
      const lastNameEnabled = appSettings.form.lastName.enabled;
      const emailEnabled = appSettings.form.email.enabled;
      const newsletterEnabled = appSettings.form.newsletter.enabled;

      const country = locationEnabled ? countrySelect.value : '';
      const needsRegion = locationEnabled && !regionSelect.disabled;
      const region = needsRegion ? regionSelect.value : '';
      const lastName = lastNameEnabled ? lastNameInput.value.trim() : '';
      const email = emailEnabled ? emailInput.value.trim() : '';
      const newsletterInput = document.getElementById('newsletterOptIn');
      const newsletter = newsletterEnabled && newsletterInput ? newsletterInput.checked : false;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (emailEnabled && !emailRegex.test(email)) {
        introError.textContent = t('introEmailError');
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      if (
        (locationEnabled && (!country || (needsRegion && !region))) ||
        (lastNameEnabled && !lastName) ||
        (emailEnabled && !email)
      ) {
        introError.textContent = t('introFieldError');
        introBox.classList.remove('shake');
        void introBox.offsetWidth;
        introBox.classList.add('shake');
        return;
      }

      introError.textContent = '';

      const originalText = submitIntroButton.textContent;
      submitIntroButton.disabled = true;
      submitIntroButton.textContent = t('submitIntroSending');
      submitIntroButton.classList.add('button-loading');

      if (locationEnabled) {
        localStorage.setItem('lumi_country', country);
        localStorage.setItem('lumi_region', region);
      } else {
        localStorage.removeItem('lumi_country');
        localStorage.removeItem('lumi_region');
      }

      if (lastNameEnabled) {
        localStorage.setItem('lumi_lastname', lastName);
      } else {
        localStorage.removeItem('lumi_lastname');
      }

      if (emailEnabled) {
        localStorage.setItem('lumi_email', email);
      } else {
        localStorage.removeItem('lumi_email');
      }

      if (newsletterEnabled) {
        localStorage.setItem('lumi_newsletter', newsletter ? '1' : '0');
      } else {
        localStorage.removeItem('lumi_newsletter');
      }

      try {
        await fetch(`${BACKEND_URL}/visit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-session-id': getSessionId()
          },
          body: JSON.stringify({
            country: locationEnabled
              ? (region ? `${region}, ${country}` : country)
              : '',
            lastName: lastNameEnabled ? lastName : '',
            email: emailEnabled ? email : '',
            newsletter: newsletterEnabled ? newsletter : '',
            timestamp: new Date().toISOString()
          })
        });

        startCameraAfterIntro();
        showThankYou(t('thankYouIntro'));
        if (currentServerSessionId) {
          localStorage.setItem(FORM_SUBMITTED_KEY, currentServerSessionId);
        }
      } catch (err) {
        console.error('Error sending visit info:', err);
        introError.textContent = t('introSubmitError');

        submitIntroButton.disabled = false;
        submitIntroButton.textContent = originalText || t('submitIntro');
        submitIntroButton.classList.remove('button-loading');
      }
    });

    // SESSION ID HELPERS

    function getSessionId() {
      let id = localStorage.getItem('lumi_session_id');
      if (!id) {
        id = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('lumi_session_id', id);
      }
      return id;
    }

    function pingSession() {
      if (!appIsEnabled) return;
      fetch(`${BACKEND_URL}/ping`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-session-id': getSessionId()
        },
        body: JSON.stringify({})
      }).catch(console.error);
    }

    function prefillIntroFromStorage() {
      const storedCountryRaw = localStorage.getItem('lumi_country') || '';
      const storedRegion = localStorage.getItem('lumi_region') || '';
      const storedLast = localStorage.getItem('lumi_lastname') || '';
      const storedEmail = localStorage.getItem('lumi_email') || '';
      const storedNewsletter = localStorage.getItem('lumi_newsletter') === '1';
      let storedCountry = storedCountryRaw;

      if (storedCountryRaw === 'Estados Unidos') storedCountry = 'United States';
      if (storedCountryRaw === 'Espa√±a') storedCountry = 'Spain';

      populateCountryOptions(storedCountry);

      if (appSettings.form.locationEnabled && storedCountry) {
        countrySelect.value = storedCountry;
        populateRegionOptions(storedCountry, storedRegion);
      } else {
        populateRegionOptions('', '');
      }

      if (appSettings.form.lastName.enabled && storedLast) {
        lastNameInput.value = storedLast;
      }
      if (appSettings.form.email.enabled && storedEmail) {
        emailInput.value = storedEmail;
      }
      if (appSettings.form.newsletter.enabled) {
        const newsletterInput = document.getElementById('newsletterOptIn');
        if (newsletterInput) {
          newsletterInput.checked = storedNewsletter;
        }
      }
    }

    window.addEventListener('load', async () => {
      await loadAppSettings();
      prefillIntroFromStorage();
      if (!appIsEnabled) {
        return;
      }
      showLandingModal();
      pingSession();
    });
  </script>
</body>
</html>
