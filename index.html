<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureButton = document.getElementById('captureButton');
  const uploadButton = document.getElementById('uploadButton');
  const retakeButton = document.getElementById('retakeButton');
  const switchCameraButton = document.getElementById('switchCameraButton');
  const errorLog = document.getElementById('errorLog');
  const introModal = document.getElementById('introModal');
  const introClose = document.getElementById('introClose');
  const countryInput = document.getElementById('countryInput');
  const lastNameInput = document.getElementById('lastNameInput');
  const submitIntroButton = document.getElementById('submitIntroButton');
  const introError = document.getElementById('introError');
  const introBox = document.querySelector('.intro-box');
  const uploadStatus = document.getElementById('uploadStatus');
  const thankYouToast = document.getElementById('thankYouToast');

  let currentFacingMode = 'user'; // Start with front camera
  const BACKEND_URL = 'https://mayaguez-photoapp.vercel.app';

  let photoCounter = 1;

  function getPRDate() {
    const now = new Date();
    const utc = now.getTime() + now.getTimezoneOffset() * 60000;
    return new Date(utc - 4 * 60 * 60000);
  }

  function buildPhotoFileName() {
    const prNow = getPRDate();

    const dd = String(prNow.getDate()).padStart(2, '0');
    const mm = String(prNow.getMonth() + 1).padStart(2, '0');
    const yy = String(prNow.getFullYear()).slice(-2);
    const HH = String(prNow.getHours()).padStart(2, '0');
    const MM = String(prNow.getMinutes()).padStart(2, '0');
    const SS = String(prNow.getSeconds()).padStart(2, '0');

    const num = String(photoCounter).padStart(2, '0');
    photoCounter++;

    return `${num}_${dd}_${mm}_${yy}-${HH}_${MM}_${SS}.jpeg`;
  }

  function showThankYou(message) {
    if (!thankYouToast) return;
    thankYouToast.textContent = message;
    thankYouToast.classList.add('show');
    setTimeout(() => {
      thankYouToast.classList.remove('show');
    }, 2500);
  }

  async function setupCamera(facingMode = 'user') {
    try {
      const constraints = {
        video: {
          facingMode,
          width: { ideal: 1080 },
          height: { ideal: 1440 }
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      console.log('Actual video resolution:', video.videoWidth, video.videoHeight);
    } catch (error) {
      errorLog.textContent = `Camera error: ${error.message}`;
    }
  }

  function switchCamera() {
    currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
    setupCamera(currentFacingMode);
  }

  // --- Capture selfie ---
  captureButton.addEventListener('click', () => {
    const targetWidth = 1080;
    const targetHeight = 1440; // 3:4 portrait

    canvas.width = targetWidth;
    canvas.height = targetHeight;

    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const vw = video.videoWidth;
    const vh = video.videoHeight;

    if (!vw || !vh) {
      errorLog.textContent = 'Error: Camera not ready';
      return;
    }

    const videoAspect = vw / vh;
    const canvasAspect = targetWidth / targetHeight;

    let sx, sy, sWidth, sHeight;

    if (videoAspect > canvasAspect) {
      sHeight = vh;
      sWidth = sHeight * canvasAspect;
      sx = (vw - sWidth) / 2;
      sy = 0;
    } else {
      sWidth = vw;
      sHeight = sWidth / canvasAspect;
      sx = 0;
      sy = (vh - sHeight) / 2;
    }

    ctx.save();

    if (currentFacingMode === 'user') {
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(
        video,
        sx, sy, sWidth, sHeight,
        0, 0, canvas.width, canvas.height
      );
    } else {
      ctx.drawImage(
        video,
        sx, sy, sWidth, sHeight,
        0, 0, canvas.width, canvas.height
      );
    }

    ctx.restore();

    const img = new Image();
    img.src = 'Assets/Logo Mayaguez.png';
    img.onload = () => {
      const logoWidth = 500;
      const logoHeight = (logoWidth / img.width) * img.height;
      const margin = 20;
      ctx.drawImage(
        img,
        (canvas.width - logoWidth) / 2,
        margin,
        logoWidth,
        logoHeight
      );
    };

    // Swap UI: VOLTEAR/TOMAR → RETOMAR/SUBIR
    video.style.display = 'none';
    canvas.style.display = 'block';

    switchCameraButton.style.display = 'none';
    retakeButton.style.display = 'inline-block';

    captureButton.style.display = 'none';
    uploadButton.style.display = 'inline-block';
  });

  // --- Retake selfie ---
  retakeButton.addEventListener('click', () => {
    video.style.display = 'block';
    canvas.style.display = 'none';

    // show VOLTEAR again, hide RETOMAR
    switchCameraButton.style.display = 'inline-flex';
    retakeButton.style.display = 'none';

    // hide upload, show TOMAR SELFIE
    uploadButton.style.display = 'none';
    captureButton.style.display = 'inline-block';

    uploadButton.disabled = false;
    uploadButton.textContent = 'SUBIR FOTO';
    uploadButton.classList.remove('button-loading');
    uploadStatus.textContent = '';
    errorLog.textContent = '';
  });

  // --- Upload selfie ---
  uploadButton.addEventListener('click', async () => {
    if (uploadButton.disabled) return;

    uploadButton.disabled = true;
    uploadButton.textContent = 'SUBIENDO...';
    uploadButton.classList.add('button-loading');
    uploadStatus.textContent = 'Subiendo foto, por favor espera...';
    errorLog.textContent = '';

    canvas.toBlob(async (blob) => {
      try {
        const response = await fetch(`${BACKEND_URL}/upload`, {
          method: 'POST',
          headers: {
            'Content-Type': blob.type,
            'X-File-Name': buildPhotoFileName()
          },
          body: blob
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Upload successful:', result);

        uploadStatus.textContent = '¡Foto subida correctamente!';
        uploadButton.textContent = 'SUBIDA';
        uploadButton.classList.remove('button-loading');
        showThankYou('¡Gracias! Tu foto ha sido enviada.');
      } catch (error) {
        console.error('Upload error:', error);
        errorLog.textContent = `Error al subir la foto: ${error.message}`;

        uploadButton.disabled = false;
        uploadButton.textContent = 'SUBIR SELFIE';
        uploadButton.classList.remove('button-loading');
        uploadStatus.textContent = 'Hubo un error. Intenta nuevamente.';
      }
    }, 'image/jpeg');
  });

  switchCameraButton.addEventListener('click', switchCamera);

  // --- Intro modal / registration ---
  function startCameraAfterIntro() {
    introModal.style.display = 'none';
    setupCamera(currentFacingMode);
  }

  introClose.addEventListener('click', () => {
    startCameraAfterIntro();
    showThankYou('Puedes tomar tu selfie cuando estés listo.');
  });

  submitIntroButton.addEventListener('click', async () => {
    const country = countryInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const email = document.getElementById('emailInput').value.trim();
    const newsletter = document.getElementById('newsletterOptIn').checked;

    if (!country || !lastName || !email) {
      introError.textContent = 'Por favor completa todos los campos para continuar.';
      introBox.classList.remove('shake');
      void introBox.offsetWidth;
      introBox.classList.add('shake');
      return;
    }

    introError.textContent = '';

    try {
      await fetch(`${BACKEND_URL}/visit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          country,
          lastName,
          email,
          newsletter,
          timestamp: new Date().toISOString()
        })
      });
    } catch (err) {
      console.error('Error sending visit info:', err);
    }

    startCameraAfterIntro();
    showThankYou('¡Gracias por registrarte! Ahora toma tu selfie.');
  });

  window.addEventListener('load', () => {
    introModal.style.display = 'flex';
  });
</script>
