<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TriviaApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --navy:#0A192F;
      --gold:#D4AF37;
      --dark:#020617;
      --panel:#020b1b;
      --light:#F4F4F4;
      --muted:#9CA3AF;
      --danger:#F97373;
      --success:#10B981;
      --line:rgba(212,175,55,0.35);
      --line2:rgba(55,65,81,0.75);
      --shadow:0 18px 45px rgba(0,0,0,0.75);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--light);
      background: var(--navy);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at top, #0f172a, var(--navy));
      overflow:hidden; /* big screen: no scroll */
    }

    /* 1920x1080 fixed stage */
    .stage{
      width:1920px;
      height:1080px;
      position:relative;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* Header pill */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-radius:999px;
      background: var(--panel);
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,0.55);
      gap:12px;
      flex:0 0 auto;
    }
    .header-left, .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand{
      font-size:14px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color:var(--gold);
      white-space:nowrap;
    }
    .title{
      flex:1;
      text-align:center;
      font-size:22px;
      letter-spacing:0.28em;
      text-transform:uppercase;
      color:var(--gold);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size:11px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.6);
      background: rgba(10,25,47,0.9);
      color:var(--light);
      letter-spacing:0.16em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .pill.danger{
      border-color: var(--danger);
      color:#fecaca;
    }
    .pill.success{
      border-color: rgba(16,185,129,0.9);
      color:#a7f3d0;
    }

    /* Main card */
    .card{
      flex:1 1 auto;
      background: rgba(2,11,27,0.96);
      border-radius:20px;
      box-shadow: var(--shadow);
      border:1px solid rgba(15,23,42,0.9);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 4px 2px;
    }
    .meta-left{
      display:flex;
      align-items:baseline;
      gap:12px;
      min-width:0;
    }
    .qprogress{
      font-size:14px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--gold);
      white-space:nowrap;
    }
    .score{
      font-size:14px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--light);
      white-space:nowrap;
    }
    .timer{
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .timer-label{
      font-size:12px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .timer-value{
      font-size:18px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--light);
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: #020617;
      min-width:84px;
      text-align:center;
    }
    .timer-value.low{
      border-color: rgba(249,115,115,0.85);
      color:#fecaca;
    }

    .question{
      flex:0 0 auto;
      background: radial-gradient(circle at top, #020617, #020b1b);
      border-radius:16px;
      border:1px solid rgba(31,41,55,0.9);
      padding:18px 18px 16px;
      box-shadow:0 18px 40px rgba(0,0,0,0.55);
    }
    .question h2{
      margin:0 0 10px;
      font-size:28px;
      line-height:1.22;
      letter-spacing:0.02em;
      color:var(--light);
      font-weight:650;
    }
    .subline{
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.12em;
      text-transform:uppercase;
    }

    .answers{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      min-height:0;
    }

    .ans{
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.9);
      background:#020617;
      color:var(--light);
      padding:18px 18px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:flex-start;
      box-shadow:0 14px 35px rgba(0,0,0,0.45);
      position:relative;
      overflow:hidden;
    }
    .ans::after{
      content:"";
      position:absolute;
      inset:0;
      opacity:0;
      transition: opacity 0.16s ease;
      pointer-events:none;
      background: linear-gradient(to right, rgba(212,175,55,0.14), transparent);
    }
    .ans.active::after{ opacity:1; }
    .badge{
      flex:0 0 auto;
      width:44px;
      height:44px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(212,175,55,0.55);
      color:var(--gold);
      letter-spacing:0.12em;
      font-weight:750;
      background: rgba(10,25,47,0.75);
    }
    .ans-text{
      flex:1 1 auto;
      font-size:22px;
      line-height:1.22;
      letter-spacing:0.01em;
      color:var(--light);
      word-break:break-word;
      overflow-wrap:anywhere;
    }

    /* highlight states after answer */
    .ans.correct{
      border-color: rgba(16,185,129,0.95);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.45), 0 18px 45px rgba(0,0,0,0.6);
    }
    .ans.correct .badge{
      border-color: rgba(16,185,129,0.95);
      color:#a7f3d0;
    }
    .ans.incorrect{
      border-color: rgba(249,115,115,0.95);
      box-shadow: 0 0 0 1px rgba(249,115,115,0.35), 0 18px 45px rgba(0,0,0,0.6);
    }
    .ans.incorrect .badge{
      border-color: rgba(249,115,115,0.95);
      color:#fecaca;
    }

    /* Splash overlay */
    .overlay{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at top, rgba(2,6,23,0.96), rgba(2,6,23,0.98));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      z-index:50;
    }
    .overlay.hidden{ display:none; }
    .overlay-card{
      width:100%;
      max-width:920px;
      background: #020617;
      border-radius:20px;
      border:1px solid rgba(212,175,55,0.55);
      box-shadow:0 22px 55px rgba(0,0,0,0.85);
      padding:22px 22px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      text-align:center;
    }
    .overlay-title{
      margin:0;
      font-size:28px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--gold);
      font-weight:700;
    }
    .overlay-sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      letter-spacing:0.08em;
      line-height:1.55;
    }
    .code-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .code{
      font-size:44px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--light);
      padding:12px 18px;
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.9);
      background: rgba(2,11,27,0.98);
      min-width:360px;
      text-align:center;
    }
    .hint{
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.14em;
      text-transform:uppercase;
    }
    .overlay-footer{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.12em;
      text-transform:uppercase;
    }

    /* End overlay */
    .end-score{
      font-size:68px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--light);
      margin: 8px 0 0;
    }
    .end-sub{
      font-size:13px;
      color:var(--muted);
      letter-spacing:0.10em;
      margin: 4px 0 0;
      text-transform:uppercase;
    }

    /* Tiny top-right hint */
    .corner-hint{
      position:absolute;
      right:26px;
      bottom:18px;
      font-size:10px;
      color:rgba(156,163,175,0.85);
      letter-spacing:0.12em;
      text-transform:uppercase;
      z-index:5;
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="stage">
    <header class="header">
      <div class="header-left">
        <div class="brand">LMNR TRIVIA</div>
      </div>

      <div class="title">TRIVIA APP</div>

      <div class="header-right">
        <span id="statusPill" class="pill">STATUS: LOADING…</span>
      </div>
    </header>

    <main class="card">
      <div class="toprow">
        <div class="meta-left">
          <div id="qProgress" class="qprogress">QUESTION 1 / 20</div>
          <div id="scoreLine" class="score">SCORE: 0</div>
        </div>
        <div class="timer">
          <div class="timer-label">Timer</div>
          <div id="timerValue" class="timer-value">30s</div>
        </div>
      </div>

      <section class="question">
        <div class="subline" id="subline">WAITING FOR CONTROLLER…</div>
        <h2 id="questionText">Create a session to begin.</h2>
      </section>

      <section class="answers" id="answersGrid">
        <div class="ans" id="ansA">
          <div class="badge">A</div>
          <div class="ans-text" id="ansAText">—</div>
        </div>
        <div class="ans" id="ansB">
          <div class="badge">B</div>
          <div class="ans-text" id="ansBText">—</div>
        </div>
        <div class="ans" id="ansC">
          <div class="badge">C</div>
          <div class="ans-text" id="ansCText">—</div>
        </div>
        <div class="ans" id="ansD">
          <div class="badge">D</div>
          <div class="ans-text" id="ansDText">—</div>
        </div>
      </section>
    </main>

    <div class="corner-hint">Open user.html on phone • enter passkey • type session code</div>

    <!-- Splash / Session overlay -->
    <div id="splashOverlay" class="overlay">
      <div class="overlay-card">
        <h1 class="overlay-title">READY</h1>
        <p class="overlay-sub">
          Open <b>user.html</b> on your phone, enter the passkey, and type this session code:
        </p>

        <div class="code-row">
          <div id="roomCodeEl" class="code">—</div>
        </div>
        <div class="hint">This code changes every session</div>

        <div id="overlayFooter" class="overlay-footer">Creating session…</div>
      </div>
    </div>

    <!-- End overlay -->
    <div id="endOverlay" class="overlay hidden">
      <div class="overlay-card">
        <h1 class="overlay-title">FINISHED</h1>
        <div id="endScore" class="end-score">SCORE: 0 / 20</div>
        <div class="end-sub">Returning to splash for next player…</div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Big Screen logic
     * - Creates room/session in KV via /api/create-room
     * - Displays roomCode on splash
     * - Waits for controller to join (via /api/poll-answer returning controllerConnected or via /api/host-state + /api/poll-answer)
     * - Runs timer locally
     * - Polls /api/poll-answer for answers
     * - Highlights chosen answer, updates score, advances
     * - After Q20 -> show final -> reset room -> return to splash
     */

    // ====== Embedded questions (20) ======
    // Replace these with your real 20 questions anytime.
    const QUESTIONS = [
      { q: "Which color is used as the main accent in this UI style?", a:"Gold", b:"Purple", c:"Orange", d:"Pink", correct:"A" },
      { q: "What is 5 + 7?", a:"10", b:"12", c:"13", d:"14", correct:"B" },
      { q: "Which one is a web browser?", a:"Photoshop", b:"Illustrator", c:"Chrome", d:"Figma", correct:"C" },
      { q: "Which planet is known as the Red Planet?", a:"Venus", b:"Mars", c:"Jupiter", d:"Mercury", correct:"B" },
      { q: "What does CPU stand for?", a:"Central Processing Unit", b:"Computer Power Utility", c:"Control Panel User", d:"Core Processing Umbrella", correct:"A" },
      { q: "How many seconds are in one minute?", a:"30", b:"45", c:"60", d:"90", correct:"C" },
      { q: "Which is a primary color?", a:"Green", b:"Purple", c:"Orange", d:"Blue", correct:"D" },
      { q: "What is the capital of Puerto Rico?", a:"Ponce", b:"San Juan", c:"Mayagüez", d:"Arecibo", correct:"B" },
      { q: "Which is a JavaScript framework?", a:"Next.js", b:"Excel", c:"Word", d:"PowerPoint", correct:"A" },
      { q: "What is 9 × 3?", a:"18", b:"21", c:"27", d:"30", correct:"C" },
      { q: "Which animal barks?", a:"Cat", b:"Dog", c:"Cow", d:"Fish", correct:"B" },
      { q: "What does HTML stand for?", a:"HyperText Markup Language", b:"HighText Machine Language", c:"Hyper Tool Multi Language", d:"Home Text Markup Link", correct:"A" },
      { q: "What is the opposite of 'hot'?", a:"Warm", b:"Boiling", c:"Cold", d:"Spicy", correct:"C" },
      { q: "Which is larger: KB or MB?", a:"KB", b:"MB", c:"Same", d:"Neither", correct:"B" },
      { q: "How many days are in a week?", a:"5", b:"6", c:"7", d:"8", correct:"C" },
      { q: "Which one is a fruit?", a:"Carrot", b:"Potato", c:"Apple", d:"Lettuce", correct:"C" },
      { q: "What is 100 / 4?", a:"20", b:"25", c:"30", d:"40", correct:"B" },
      { q: "Which is an ocean?", a:"Sahara", b:"Amazon", c:"Pacific", d:"Himalaya", correct:"C" },
      { q: "Which device is used to take photos?", a:"Camera", b:"Toaster", c:"Blender", d:"Printer", correct:"A" },
      { q: "End question: select D", a:"A", b:"B", c:"C", d:"D", correct:"D" },
    ];

    // ====== Config ======
    const QUESTION_SECONDS = 30;
    const POLL_MS = 650;
    const REVEAL_MS = 250; // tiny flash before advancing

    // ====== Elements ======
    const statusPill = document.getElementById("statusPill");
    const splashOverlay = document.getElementById("splashOverlay");
    const endOverlay = document.getElementById("endOverlay");
    const roomCodeEl = document.getElementById("roomCodeEl");
    const overlayFooter = document.getElementById("overlayFooter");

    const qProgress = document.getElementById("qProgress");
    const scoreLine = document.getElementById("scoreLine");
    const timerValue = document.getElementById("timerValue");
    const subline = document.getElementById("subline");
    const questionText = document.getElementById("questionText");

    const ansA = document.getElementById("ansA");
    const ansB = document.getElementById("ansB");
    const ansC = document.getElementById("ansC");
    const ansD = document.getElementById("ansD");
    const ansAText = document.getElementById("ansAText");
    const ansBText = document.getElementById("ansBText");
    const ansCText = document.getElementById("ansCText");
    const ansDText = document.getElementById("ansDText");
    const endScore = document.getElementById("endScore");

    const answerEls = { A: ansA, B: ansB, C: ansC, D: ansD };

    // ====== State ======
    let roomCode = null;
    let hostToken = null;

    let qIndex = 0;
    let score = 0;
    let questionEndsAt = 0;
    let timerTickId = null;

    let lastEventId = 0; // for poll-answer dedupe
    let pollId = null;

    let controllerConnected = false;
    let isRunning = false;
    let isAdvancing = false;

    // ====== Helpers ======
    function setStatus(text, type=null){
      statusPill.textContent = text;
      statusPill.classList.remove("danger","success");
      if(type === "danger") statusPill.classList.add("danger");
      if(type === "success") statusPill.classList.add("success");
    }

    function resetAnswerClasses(){
      [ansA, ansB, ansC, ansD].forEach(el=>{
        el.classList.remove("correct","incorrect","active");
      });
    }

    function renderQuestion(){
      const total = QUESTIONS.length;
      const q = QUESTIONS[qIndex];

      qProgress.textContent = `QUESTION ${qIndex + 1} / ${total}`;
      scoreLine.textContent = `SCORE: ${score}`;
      subline.textContent = controllerConnected ? "ANSWER ON YOUR PHONE" : "WAITING FOR CONTROLLER…";
      questionText.textContent = q.q;

      ansAText.textContent = q.a;
      ansBText.textContent = q.b;
      ansCText.textContent = q.c;
      ansDText.textContent = q.d;

      resetAnswerClasses();
    }

    function startTimer(){
      clearInterval(timerTickId);
      questionEndsAt = Date.now() + QUESTION_SECONDS * 1000;
      tickTimer();
      timerTickId = setInterval(tickTimer, 250);
    }

    function tickTimer(){
      const msLeft = Math.max(0, questionEndsAt - Date.now());
      const sLeft = Math.ceil(msLeft / 1000);
      timerValue.textContent = `${sLeft}s`;
      timerValue.classList.toggle("low", sLeft <= 7);

      if(msLeft <= 0){
        clearInterval(timerTickId);
        timerTickId = null;
        // timeout => incorrect +0, auto-advance
        if(isRunning && !isAdvancing){
          handleAnswer({ choice: null, timeout: true });
        }
      }
    }

    async function api(url, opts={}){
      const res = await fetch(url, {
        ...opts,
        headers: {
          "Content-Type":"application/json",
          ...(opts.headers || {})
        }
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch(_) {}
      if(!res.ok){
        const msg = data && data.error ? data.error : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    async function createRoom(){
      setStatus("STATUS: CREATING SESSION…");
      overlayFooter.textContent = "Creating session…";
      roomCodeEl.textContent = "—";
      splashOverlay.classList.remove("hidden");
      endOverlay.classList.add("hidden");

      const data = await api("/api/create-room", { method:"POST" });
      roomCode = data.roomCode;
      hostToken = data.hostToken;

      qIndex = 0;
      score = 0;
      lastEventId = 0;
      controllerConnected = false;
      isRunning = false;
      isAdvancing = false;

      roomCodeEl.textContent = roomCode;
      overlayFooter.textContent = "Waiting for phone to join…";
      setStatus("STATUS: WAITING FOR PHONE…", "danger");

      // write initial host state snapshot (optional but good for resume)
      await pushHostState({ phase:"splash" });
    }

    async function pushHostState(extra={}){
      if(!roomCode || !hostToken) return;
      const payload = {
        roomCode,
        hostToken,
        state: {
          qIndex,
          score,
          total: QUESTIONS.length,
          questionEndsAt,
          isRunning,
          controllerConnected,
          ...extra
        }
      };
      try{
        await api("/api/host-state", { method:"POST", body: JSON.stringify(payload) });
      }catch(e){
        // keep silent; UI should not crash if host-state fails temporarily
        console.warn("host-state failed:", e.message);
      }
    }

    function startGame(){
      splashOverlay.classList.add("hidden");
      isRunning = true;
      isAdvancing = false;
      renderQuestion();
      startTimer();
      setStatus("STATUS: LIVE", "success");
      pushHostState({ phase:"live" });
    }

    async function endGame(){
      isRunning = false;
      clearInterval(timerTickId);
      timerTickId = null;

      endScore.textContent = `SCORE: ${score} / ${QUESTIONS.length}`;
      endOverlay.classList.remove("hidden");
      setStatus("STATUS: FINISHED", "success");
      await pushHostState({ phase:"finished" });

      // short pause then reset
      setTimeout(async ()=>{
        try{
          await api("/api/host-state", {
            method:"POST",
            body: JSON.stringify({
              roomCode,
              hostToken,
              state: { qIndex: 0, score: 0, total: QUESTIONS.length, isRunning:false, controllerConnected:false, phase:"reset" }
            })
          });
        }catch(_){}
        // Create a fresh room for next player (simplest lock reset)
        await createRoom();
      }, 1800);
    }

    async function handleAnswer({ choice, timeout=false }){
      if(isAdvancing) return;
      isAdvancing = true;

      clearInterval(timerTickId);
      timerTickId = null;

      const q = QUESTIONS[qIndex];
      const correct = q.correct;

      resetAnswerClasses();

      if(choice){
        answerEls[choice]?.classList.add("active");
      }

      // Determine correctness
      const isCorrect = choice && (choice === correct);

      // highlight chosen answer red/green, and (optionally) also show correct
      if(choice){
        answerEls[choice]?.classList.add(isCorrect ? "correct" : "incorrect");
      } else {
        // timeout: no choice — briefly flash correct answer as active/correct (optional)
        answerEls[correct]?.classList.add("active","correct");
      }

      if(isCorrect) score += 1;

      scoreLine.textContent = `SCORE: ${score}`;

      await pushHostState({
        phase: "reveal",
        lastChoice: choice || null,
        lastWasCorrect: !!isCorrect,
        lastWasTimeout: !!timeout,
      });

      // advance quickly
      setTimeout(async ()=>{
        qIndex += 1;

        if(qIndex >= QUESTIONS.length){
          await endGame();
          return;
        }

        isAdvancing = false;
        renderQuestion();
        startTimer();
        await pushHostState({ phase:"live" });
      }, REVEAL_MS);
    }

    async function pollAnswers(){
      if(!roomCode || !hostToken) return;

      try{
        const data = await api("/api/poll-answer", {
          method:"POST",
          body: JSON.stringify({ roomCode, hostToken, since: lastEventId })
        });

        // controller connection signal
        if(data.controllerConnected && !controllerConnected){
          controllerConnected = true;
          overlayFooter.textContent = "Phone connected. Starting…";
          setStatus("STATUS: PHONE CONNECTED", "success");
          await pushHostState({ controllerConnected:true });

          // start immediately
          setTimeout(()=> startGame(), 350);
        }

        // new answer event
        if(data.event && data.event.id){
          if(data.event.id > lastEventId){
            lastEventId = data.event.id;
          }
          if(isRunning && !isAdvancing){
            const choice = data.event.choice; // "A"|"B"|"C"|"D"
            handleAnswer({ choice, timeout:false });
          }
        }

      }catch(e){
        // network blip: keep polling
        console.warn("poll failed:", e.message);
        setStatus("STATUS: NETWORK…", "danger");
      }
    }

    function startPolling(){
      if(pollId) clearInterval(pollId);
      pollId = setInterval(pollAnswers, POLL_MS);
    }

    // ====== Boot ======
    (async function boot(){
      try{
        await createRoom();
        startPolling();
        setStatus("STATUS: READY", "danger");
      }catch(e){
        console.error(e);
        overlayFooter.textContent = "Failed to create session. Check Vercel KV + API routes.";
        setStatus("STATUS: ERROR", "danger");
      }
    })();
  </script>
</body>
</html>
