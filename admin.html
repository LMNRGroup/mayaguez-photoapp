<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LuminarApps - ADMIN Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <style>
  /* PIXY BRAND FONT */
  @font-face {
    font-family: 'Pixy';
    src: url('Assets/PIXY.woff2') format('woff2'),
         url('Assets/PIXY.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  /* PIXY FONT ON "Lock Admin" */
  #lockAdminBtn {
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif !important;
    letter-spacing: 0.20em;
    text-transform: uppercase;
    color: #f87171;
  }

  #lockAdminBtn:hover {
    color: #fecaca;
  }

  @font-face {
    font-family: 'FuturaBT-Light';
    src: url('Assets/FuturaBT-Light.woff2') format('woff2'),
         url('Assets/FuturaBT-Light.woff') format('woff');
    font-weight: 300;
    font-style: normal;
    font-display: swap;
  }

  :root {
    --navy: #0A192F;
    --gold: #D4AF37;
    --dark-grey: #1C1C1C;
    --light-grey: #F4F4F4;
    --muted-grey: #9CA3AF;
    --danger: #F97373;
    --success: #10B981;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Arial, sans-serif;
    color: var(--light-grey);
    background: var(--navy);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 24px;
    background: radial-gradient(circle at top, #0f172a, var(--navy));
    color: var(--light-grey);
    overflow-x: hidden;
  }

  .page-wrapper {
    width: 100%;
    max-width: 1360px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* TOP HEADER BAR (logo + title + server status) */
  .admin-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 18px;
    border-radius: 999px;
    background: #020b1b;
    border: 1px solid rgba(212, 175, 55, 0.4);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    gap: 12px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .header-logo {
    height: 24px;
    width: auto;
    object-fit: contain;
  }

  .header-title {
    flex: 1;
    text-align: center;
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    font-size: 22px;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: var(--gold);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .status-pill {
    font-size: 11px;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid rgba(212, 175, 55, 0.6);
    background: rgba(10, 25, 47, 0.9);
    color: var(--light-grey);
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .status-pill.offline {
    border-color: var(--danger);
    color: #fecaca;
  }

  .app-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    background: #ef4444;
    box-shadow: none;
    flex-shrink: 0;
    display: inline-block;
  }

  .status-dot.on {
    background: var(--success);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.9);
  }

  .status-dot.off {
    background: #ef4444;
    box-shadow: none;
  }

  .toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 46px;
    height: 24px;
    border-radius: 999px;
    background: #020b1b;
    border: 1px solid rgba(212, 175, 55, 0.4);
    cursor: pointer;
    flex-shrink: 0;
  }

  .toggle input {
    display: none;
  }

  .toggle-slider {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
    border-radius: inherit;
  }

  .toggle-slider::before {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: #9ca3af;
    transition: transform 0.18s ease, background 0.18s ease;
  }

  .toggle.is-on {
    border-color: var(--success);
    background: #022c22;
  }

  .toggle.is-on .toggle-slider::before {
    transform: translateX(20px);
    background: var(--success);
  }

  .toggle input:checked + .toggle-slider::before {
    transform: translateX(20px);
    background: var(--success);
  }

  .toggle input:checked + .toggle-slider {
    background: #022c22;
  }

  .toggle.disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* LAYOUT CARD (NAV + PHOTO + LOGS) */

  .card {
    margin-top: 8px;
    background: rgba(2, 11, 27, 0.96);
    border-radius: 20px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
    padding: 18px 18px 16px;
    display: flex;
    flex-direction: column;
    color: var(--light-grey);
    border: 1px solid rgba(15, 23, 42, 0.9);
  }

  .card-main {
    display: grid;
    grid-template-columns: 190px minmax(0, 1fr) 250px;
    gap: 18px;
    align-items: stretch;
  }

  /* LEFT NAV */

  .sidebar-left {
    border-right: 1px solid rgba(55, 65, 81, 0.7);
    padding-right: 14px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .nav-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .nav-label {
    font-size: 14px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    color: var(--gold);
    margin-bottom: 8px;
  }

  .nav-item {
    text-align: left;
    border: none;
    background: transparent;
    color: var(--light-grey);
    font-size: 16px;
    padding: 6px 0;
    cursor: pointer;
    letter-spacing: 0.03em;
    position: relative;
  }

  /* Futura ONLY on the four main nav items */
  #navDashboard,
  #navApproved,
  #navReports,
  #navResetLogs {
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  .nav-item::before {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 2px;
    background: var(--gold);
    transition: width 0.18s ease;
  }

  .nav-item:hover {
    color: var(--gold);
  }

  .nav-item:hover::before,
  .nav-item.active::before {
    width: 22px;
  }

  .nav-item.active {
    color: var(--gold);
  }

  .nav-item-lock {
    margin-top: 24px;
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #fca5a5;
  }

  .nav-item-lock:hover {
    color: #fecaca;
  }

  /* CENTER PANEL (PHOTO AREA) */

  .center-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .photo-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 14px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    color: var(--gold);
  }

  .photo-label {
    white-space: nowrap;
  }

  .pending-count {
    font-size: 18px;
    letter-spacing: 0.16em;
    color: var(--light-grey);
  }

  .photo-frame {
    position: relative;
    background: #020617;
    border-radius: 14px;
    overflow: hidden;
    min-height: 260px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: pan-y;
    border: 1px solid rgba(55, 65, 81, 0.9);
  }

  .photo-frame.empty {
    border-style: dashed;
    border-color: rgba(55, 65, 81, 0.8);
  }

  .photo-frame img {
    max-width: 100%;
    max-height: 520px;
    display: block;
    object-fit: contain;
    transition: transform 0.18s ease, opacity 0.18s ease;
  }

  .empty-text {
    font-size: 13px;
    color: var(--muted-grey);
    text-align: center;
    padding: 24px 16px;
  }

  .buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  button {
    font-family: inherit;
  }

  .btn-reject,
  .btn-approve {
    flex: 1;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 400;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  }

  .btn-reject {
    background: #111827;
    color: #f9fafb;
  }

  .btn-reject:hover {
    background: #1f2937;
  }

  .btn-approve {
    background: var(--success);
    color: #022c22;
    border-color: rgba(16, 185, 129, 0.9);
  }

  .btn-approve:hover {
    filter: brightness(1.05);
  }

  button:disabled {
    opacity: 0.5;
    cursor: default;
  }

  .helper {
    font-size: 11px;
    color: var(--muted-grey);
    text-align: center;
    margin-top: 2px;
  }

  /* RIGHT PANEL (EVENT LOGS + ACTIVITY) */

  .sidebar-right {
    display: flex;
    flex-direction: column;
    gap: 18px;
    border-left: 1px solid rgba(55, 65, 81, 0.7);
    padding-left: 14px;
  }

  .panel-box {
    background: radial-gradient(circle at top, #020617, #020b1b);
    border-radius: 14px;
    border: 1px solid rgba(31, 41, 55, 0.9);
    padding: 10px 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-height: 0;
  }

  .panel-title {
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    font-size: 13px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--gold);
  }

  .event-log-list {
    margin: 4px 0 0;
    padding: 0;
    list-style: none;
    font-size: 11px;
    color: var(--light-grey);
    max-height: 200px;
    overflow-y: auto;
  }

  .event-log-item {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    padding: 3px 0;
    opacity: 0.9;
  }

  .event-log-time {
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing: 0.14em;
    font-size: 10px;
    color: var(--gold);
    white-space: nowrap;
  }

  .event-log-text {
    flex: 1;
    text-align: right;
  }

  .activity-bars {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 6px;
    padding-top: 4px;
  }

  .activity-chart {
    position: relative;
    height: 180px;
    background: #020617;
    border-radius: 12px;
    border: 1px solid #1f2937;
    padding: 8px 8px 12px 36px;
  }

  .activity-chart svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  .activity-axis {
    font-size: 9px;
    color: var(--muted-grey);
  }

  .activity-axis.y {
    position: absolute;
    top: 8px;
    left: 6px;
    bottom: 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;
  }

  .activity-axis.x {
    display: grid;
    grid-template-columns: repeat(24, minmax(0, 1fr));
    gap: 2px;
    padding-left: 36px;
  }

  .activity-axis.x span {
    text-align: center;
    white-space: nowrap;
  }

  .activity-line {
    fill: none;
    stroke: var(--gold);
    stroke-width: 2;
  }

  .activity-line-fill {
    fill: rgba(212, 175, 55, 0.15);
  }

  .activity-point {
    fill: var(--gold);
  }

  .activity-grid-line {
    stroke: rgba(148, 163, 184, 0.2);
    stroke-dasharray: 3 3;
  }

  /* SMALL ICON BUTTONS (kept for logic but hidden from UI) */

  .kebab-button,
  .approved-button {
    display: none;
  }

  /* APPROVED OVERLAY (grid) â€“ restyled but same IDs/classes */

  .approved-overlay {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, rgba(2, 6, 23, 0.98), rgba(2, 6, 23, 0.98));
    z-index: 30;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .approved-panel {
    background: #020617;
    border-radius: 18px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    padding: 14px 16px 16px;
    box-shadow: 0 20px 45px rgba(0, 0, 0, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.5);
  }

  .approved-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 4px;
  }

  .approved-title {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .approved-subtitle {
    font-size: 11px;
    color: var(--muted-grey);
    margin-bottom: 4px;
  }

  .approved-close-btn {
    border: none;
    background: transparent;
    color: var(--light-grey);
    font-size: 20px;
    cursor: pointer;
    padding: 0 4px;
  }

  .approved-close-btn:hover {
    color: var(--gold);
  }

  .approved-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 8px;
    padding-top: 4px;
    padding-bottom: 6px;
    overflow-y: auto;
    flex: 1;
  }

  .approved-empty {
    font-size: 13px;
    color: var(--muted-grey);
    padding: 16px 4px 8px;
    text-align: center;
  }

  .approved-thumb {
    position: relative;
    border-radius: 10px;
    border: 1px solid #374151;
    padding: 0;
    overflow: hidden;
    background: #020617;
    cursor: pointer;
    flex: 0 0 auto;
  }

  .approved-thumb img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .approved-thumb.busy {
    opacity: 0.4;
    cursor: default;
  }

  .approved-thumb-actions {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 4px 4px 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.16s ease, transform 0.16s ease;
    pointer-events: none;
    background: linear-gradient(
      to top,
      rgba(15, 23, 42, 0.95),
      rgba(15, 23, 42, 0.6),
      transparent
    );
  }

  .approved-thumb:hover .approved-thumb-actions {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .thumb-action-btn {
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: rgba(2, 6, 23, 0.9);
    color: #e5e7eb;
    font-size: 9px;
    padding: 3px 7px 4px;
    text-transform: none;
    letter-spacing: 0;
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 3px;
    cursor: pointer;
  }

  .thumb-action-btn span.icon {
    font-size: 10px;
    line-height: 1;
  }

  .thumb-action-btn.danger {
    border-color: #f97373;
    color: #fecaca;
  }

  .approved-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-top: 6px;
    font-size: 10px;
    color: var(--muted-grey);
  }

  .approved-footer-controls {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .approved-footer button {
    flex: 0 0 auto;
    min-width: 64px;
    font-size: 10px;
    padding: 5px 9px;
  }

  /* APPROVED VIEWER */

  .approved-viewer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.96);
    z-index: 40;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  .approved-viewer-panel {
    position: relative;
    background: #020617;
    border-radius: 18px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    padding: 10px 10px 12px;
    box-shadow: 0 22px 50px rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    gap: 8px;
    border: 1px solid rgba(212, 175, 55, 0.6);
  }

  .approved-viewer-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    padding: 2px 2px 0;
  }

  .viewer-toolbar-left {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .viewer-icon-btn {
    border-radius: 999px;
    border: 1px solid #4b5563;
    background: #020617;
    color: #e5e7eb;
    font-size: 13px;
    padding: 6px 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    text-transform: none;
    letter-spacing: 0;
    flex: 0 0 auto;
  }

  .viewer-icon-btn span.icon {
    font-size: 14px;
    line-height: 1;
  }

  .viewer-icon-btn.danger {
    border-color: #f97373;
    color: #fecaca;
  }

  .viewer-icon-btn.close-only {
    padding: 0 6px;
    font-size: 20px;
    border: none;
    background: transparent;
  }

  .viewer-icon-btn.close-only:hover {
    color: var(--gold);
    background: transparent;
  }

  .viewer-icon-btn:hover {
    background: #111827;
  }

  .approved-viewer-image-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
  }

  .approved-viewer-img {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.75);
    background: #020617;
  }

  .approved-viewer-nav {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 2px 4px 0;
  }

  .viewer-nav-btn {
    flex: 0 0 auto;
    min-width: 70px;
    font-size: 11px;
    padding: 5px 10px;
    border-radius: 999px;
    border: 1px solid #374151;
    background: #020617;
    color: #e5e7eb;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .viewer-nav-btn.primary {
    border-color: var(--success);
    color: #a7f3d0;
  }

  .viewer-nav-btn:disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* REPORT MODAL (for Event Reports menu) */

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.96);
    display: none;
    align-items: flex-start;
    justify-content: center;
    z-index: 35;
    padding: 24px 16px;
    overflow-y: auto;
  }

  .modal-panel {
    background: #020617;
    border-radius: 16px;
    max-width: 640px;
    width: 100%;
    padding: 14px 16px 16px;
    border: 1px solid rgba(212, 175, 55, 0.6);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
  }

  .modal-title {
    font-size: 15px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .modal-close {
    border: none;
    background: transparent;
    color: var(--light-grey);
    font-size: 20px;
    cursor: pointer;
    padding: 0 4px;
  }

  .modal-close:hover {
    color: var(--gold);
  }

  .modal-body {
    font-size: 13px;
    color: var(--muted-grey);
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    margin-bottom: 8px;
  }

  /* SETTINGS MODAL */

  .settings-panel {
    max-width: 760px;
    max-height: calc(100vh - 48px);
    overflow-y: auto;
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  .settings-panel .modal-title,
  .settings-panel .settings-section-title,
  .settings-panel .settings-help,
  .settings-panel .settings-status {
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  .settings-section {
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 12px;
    padding: 12px;
    background: rgba(2, 8, 23, 0.7);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .settings-section-title {
    font-size: 12px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--gold);
  }

  .settings-grid {
    display: grid;
    gap: 12px;
  }

  .settings-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
  }

  .settings-label {
    font-size: 12px;
    color: var(--light-grey);
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  .settings-input {
    width: 100%;
    background: #0f172a;
    border: 1px solid rgba(148, 163, 184, 0.4);
    border-radius: 8px;
    padding: 8px 10px;
    color: var(--light-grey);
    font-size: 12px;
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  .settings-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 6px;
  }

  .settings-status {
    min-height: 16px;
    font-size: 12px;
    color: var(--muted-grey);
  }

  .settings-help {
    font-size: 11px;
    color: var(--muted-grey);
  }

  .btn-ghost,
  .btn-primary {
    border-radius: 999px;
    padding: 8px 14px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    cursor: pointer;
    font-family: 'FuturaBT-Light', system-ui, -apple-system,
      BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    font-weight: 300;
  }

  @media (max-width: 720px) {
    .settings-panel {
      max-width: 100%;
    }

    .settings-row {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid #4b5563;
    color: var(--light-grey);
    flex: 0 0 auto;
  }

  .btn-ghost:hover {
    background: #111827;
  }

  .btn-primary {
    background: var(--gold);
    border: 1px solid rgba(212, 175, 55, 0.8);
    color: #111827;
    flex: 0 0 auto;
  }

  .btn-primary:hover {
    filter: brightness(1.05);
  }

  .report-preview {
    margin: 0;
    margin-top: 4px;
    max-height: 200px;
    overflow-y: auto;
    background: #020617;
    border-radius: 10px;
    border: 1px solid #1f2937;
    padding: 8px 10px;
    font-size: 11px;
    color: var(--light-grey);
    white-space: pre-wrap;
  }

  /* Report loading container for Lottie */
  .report-loading {
    display: none;
    align-items: center;
    justify-content: center;
    height: 120px;
  }

  /* LOCK SCREEN */

  .lock-screen {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .lock-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
    max-width: 420px;
    padding: 0 24px;
  }

  .lock-header-id {
    text-align: center;
    margin-bottom: 6px;
  }

  .lock-app-name {
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Arial, sans-serif;
    font-size: 34px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: #f9fafb;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .lock-location {
    margin-top: 2px;
    font-size: 12px;
    color: var(--muted-grey);
  }

  .lock-card {
    background: #020617;
    border-radius: 18px;
    padding: 20px 20px 18px;
    width: 100%;
    max-width: 340px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
    color: #f9fafb;
    border: 1px solid rgba(212, 175, 55, 0.5);
  }

  .lock-title {
    font-size: 19px;
    font-weight: 700;
    margin-bottom: 6px;
    text-align: center;
    color: var(--danger);
    transition: color 0.2s ease;
  }

  .lock-input {
    width: 100%;
    border-radius: 999px;
    border: 1px solid #374151;
    background: #020617;
    padding: 10px 16px;
    color: #e5e7eb;
    font-size: 20px;
    letter-spacing: 0.35em;
    outline: none;
  }

  .lock-input::placeholder {
    font-size: 14px;
    letter-spacing: 0.04em;
    color: #4b5563;
  }

  .lock-input:focus {
    border-color: var(--success);
    box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.5);
  }

  .lock-button {
    margin-top: 12px;
    width: 100%;
    border-radius: 999px;
    border: none;
    background: var(--success);
    color: #022c22;
    font-size: 13px;
    font-weight: 600;
    padding: 10px 14px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .lock-button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  .lock-error {
    margin-top: 8px;
    font-size: 11px;
    color: var(--danger);
    min-height: 14px;
    text-align: center;
  }

  .lock-meta {
    margin-top: 8px;
    font-size: 10px;
    color: var(--muted-grey);
    text-align: center;
    line-height: 1.4;
  }

  @keyframes lock-shake {
    0%   { transform: translateX(0); }
    20%  { transform: translateX(-6px); }
    40%  { transform: translateX(6px); }
    60%  { transform: translateX(-4px); }
    80%  { transform: translateX(4px); }
    100% { transform: translateX(0); }
  }

  .lock-card.shake {
    animation: lock-shake 0.35s ease;
  }

  @keyframes lock-pulse {
    0% { transform: scale(1); box-shadow: 0 18px 45px rgba(0,0,0,0.7); }
    50% { transform: scale(1.01); box-shadow: 0 22px 55px rgba(16,185,129,0.7); }
    100% { transform: scale(1); box-shadow: 0 18px 45px rgba(0,0,0,0.7); }
  }

  .lock-card.success {
    animation: lock-pulse 0.3s ease;
  }

  .lock-brand {
    font-family: 'Pixy', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Arial, sans-serif;
    font-size: 11px;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #f9fafb;
    opacity: 0.9;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    margin-top: 10px;
  }

  /* RESPONSIVE */

  /* Tablets / small laptops */
  @media (max-width: 1024px) {
    body {
      padding: 12px;
    }

    .card-main {
      grid-template-columns: 170px minmax(0, 1fr);
      grid-template-rows: auto auto;
      grid-template-areas:
        "nav center"
        "nav right";
    }

    .sidebar-left { grid-area: nav; }
    .center-panel { grid-area: center; }
    .sidebar-right { grid-area: right; }
  }

  /* Phones â€“ stacked vertical layout, mobile-friendly nav + header */
  @media (max-width: 768px) {
    body {
      padding: 12px 10px;
    }

    .page-wrapper {
      gap: 12px;
    }

    .admin-header {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
      border-radius: 24px;
      padding: 10px 14px 12px;
      gap: 8px;
    }

    .header-left,
    .header-right {
      width: 100%;
      justify-content: center;
    }

    .header-left {
      justify-content: center;
      gap: 8px;
    }

    .header-title {
      font-size: 16px;
      letter-spacing: 0.18em;
      white-space: normal;
      line-height: 1.3;
    }

    .header-right {
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .status-pill {
      font-size: 9px;
      padding: 4px 10px;
    }

    .card {
      padding: 12px 10px 12px;
      border-radius: 18px;
    }

    .card-main {
      grid-template-columns: minmax(0, 1fr);
      grid-template-rows: auto auto auto;
      grid-template-areas:
        "nav"
        "center"
        "right";
      gap: 12px;
    }

    .sidebar-left {
      grid-area: nav;
      border-right: none;
      border-bottom: 1px solid rgba(55, 65, 81, 0.7);
      padding: 4px 0 10px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-label {
      display: none;
    }

    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      padding: 8px 12px;
      text-align: center;
      border-radius: 999px;
      background: #020b1b;
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 14px;
      width: 100%;
    }

    .nav-item::before {
      display: none;
    }

    .nav-item.active {
      background: #111827;
      color: var(--gold);
      border-color: rgba(212, 175, 55, 0.7);
    }

    .nav-item-lock {
      align-self: center;
      margin-top: 4px;
      font-size: 14px;
      letter-spacing: 0.18em;
    }

    .center-panel {
      grid-area: center;
    }

    .photo-meta-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      font-size: 12px;
    }

    .pending-count {
      font-size: 14px;
    }

    .photo-frame {
      min-height: 260px;
    }

    .sidebar-right {
      grid-area: right;
      border-left: none;
      padding-left: 0;
      border-top: 1px solid rgba(55, 65, 81, 0.7);
      padding-top: 10px;
      margin-top: -4px;
    }

    .panel-box {
      min-height: 0;
    }

    .event-log-list {
      max-height: 160px;
    }

    .activity-bars {
      gap: 4px;
    }

    .activity-bar-graph {
      height: 34px;
    }
  }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js" integrity="sha512-tB17y8UnF6R45OZyeP+fM4x6hzFH6qC1t1PmiJdWWYV7eonbbyrcF0av8RyzZkjIl95QoUiG+2l3OjVhL7Jqmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- LOCK OVERLAY -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-wrapper">
      <div class="lock-header-id">
        <div class="lock-app-name">PHOTO APP</div>
        <div class="lock-location">Pantalla Plaza ColÃ³n</div>
      </div>

      <div class="lock-card" id="lockCard">
        <div id="lockTitle" class="lock-title">Restricted access</div>

                <input
          id="accessCode"
          class="lock-input"
          type="password"
          placeholder="Access code"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        />

        <button id="accessSubmit" class="lock-button">ENTER</button>

        <div id="accessError" class="lock-error"></div>

        <div class="lock-meta">
          This tool is for internal use by Luminar Apps and Municipio de MayagÃ¼ez.
        </div>
      </div>

      <div class="lock-brand">LMNR GROUP X MUNICIPIO DE MAYAGUEZ</div>
    </div>
  </div>

  <div class="page-wrapper">
    <!-- TOP HEADER -->
    <header class="admin-header">
      <div class="header-left">
        <img
          src="Assets/Luminar.Apps-Light.png"
          alt="Luminar Apps"
          class="header-logo"
        />
      </div>

      <div class="header-title">ADMIN PORTAL</div>

      <div class="header-right">
        <div class="app-toggle">
          <span id="appStatusDot" class="status-dot off"></span>
          <label class="toggle" id="appToggleWrapper">
            <input type="checkbox" id="appToggle" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <span id="statusPill" class="status-pill">SERVER STATUS: LOADINGâ€¦</span>
      </div>
    </header>

    <!-- MAIN CARD -->
    <div class="card">
      <div class="card-main">
        <!-- LEFT NAV -->
        <aside class="sidebar-left">
          <div class="nav-group">
            <div class="nav-label">Dashboard</div>
            <button class="nav-item active" id="navDashboard">DASHBOARD</button>
            <button class="nav-item" id="navApproved">APPROVED PHOTOS</button>
            <button class="nav-item" id="navReports">EVENT REPORTS</button>
            <button class="nav-item" id="navSettings">APP SETTINGS</button>
            <button class="nav-item" id="navResetLogs">RESET LOGS</button>
          </div>
          <button class="nav-item nav-item-lock" id="lockAdminBtn">Lock Admin</button>
        </aside>

        <!-- CENTER PANEL (PHOTO REVIEW) -->
        <section class="center-panel">
          <div class="photo-meta-row">
            <div id="photoLabel" class="photo-label">PHOTO</div>
            <div id="pendingCount" class="pending-count">AWAITING APPROVAL: 0</div>
          </div>

          <div id="photoFrame" class="photo-frame empty">
            <div id="emptyText" class="empty-text">
              Loading next pending photoâ€¦
            </div>
            <img id="photoImg" alt="Pending photo" style="display:none;" />
          </div>

          <div class="buttons">
            <button id="rejectBtn" class="btn-reject" disabled>Reject</button>
            <button id="approveBtn" class="btn-approve" disabled>Approve</button>
          </div>
        </section>

        <!-- RIGHT PANEL (EVENT LOGS + ACTIVITY) -->
        <aside class="sidebar-right">
          <div class="panel-box">
            <div class="panel-title">Event logs:</div>
            <ul id="eventLogList" class="event-log-list">
              <!-- Static placeholder entries; backend can replace later -->
              <li class="event-log-item">
                <span class="event-log-time">08:19 PM</span>
                <span class="event-log-text">User submitted a form</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:18 PM</span>
                <span class="event-log-text">User uploaded a photo</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:16 PM</span>
                <span class="event-log-text">User visited the web app</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:15 PM</span>
                <span class="event-log-text">User subscribed to newsletter</span>
              </li>
            </ul>
          </div>

          <div class="panel-box">
          <div class="panel-title">Activity</div>
            <div id="activityBars" class="activity-bars">
              <div class="activity-chart">
                <div id="activityYAxis" class="activity-axis y"></div>
                <svg id="activityChart" viewBox="0 0 300 140" preserveAspectRatio="none"></svg>
              </div>
              <div id="activityXAxis" class="activity-axis x"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- HIDDEN BUTTONS (kept for existing JS logic, but not shown in UI) -->
  <button id="moreButton" class="kebab-button" type="button">âš™ï¸Ž</button>
  <button id="approvedButton" class="approved-button" type="button">â–¦</button>

  <!-- DROPDOWN MENU (logic kept, but mostly triggered from left nav now) -->
  <div id="moreMenu" class="dropdown-menu" style="display:none;">
    <div id="menuViewApproved" class="dropdown-item">
      <span>View approved photos</span>
    </div>
    <div id="menuGenerateReport" class="dropdown-item">
      <span>Generate event report</span>
      <span class="helper-label">(send email)</span>
    </div>
    <div id="menuGenerateReportYesterday" class="dropdown-item">
      <span>Generate yesterday's report</span>
      <span class="helper-label">(send email)</span>
    </div>
    <div class="dropdown-separator"></div>
    <div id="menuResetLogs" class="dropdown-item">
      <span>Reset logs</span>
      <span class="helper-label">(clear event logs)</span>
    </div>
    <div id="menuClearApproved" class="dropdown-item">
      <span>Clear drive (pending + approved)</span>
    </div>
  </div>

  <!-- APPROVED PHOTOS OVERLAY -->
  <div id="approvedOverlay" class="approved-overlay">
    <div class="approved-panel">
      <div class="approved-header">
        <div>
          <div class="approved-title">Approved photos</div>
          <div class="approved-subtitle">
            Tap a thumbnail to view it. Hover to download or delete.
          </div>
        </div>
        <button
          type="button"
          class="approved-close-btn"
          data-close-approved="1"
        >Ã—</button>
      </div>

      <div id="approvedEmpty" class="approved-empty">
        Loading approved photosâ€¦
      </div>
      <div id="approvedGrid" class="approved-grid"></div>

      <div class="approved-footer">
        <div id="approvedFooterText">
          Changes may take a few seconds to appear on the public screen.
        </div>
        <div class="approved-footer-controls">
          <button type="button" id="approvedPrevBtn" class="btn-reject">
            Prev
          </button>
          <button type="button" id="approvedNextBtn" class="btn-approve">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SINGLE APPROVED PHOTO VIEWER -->
  <div id="approvedViewer" class="approved-viewer-overlay">
    <div class="approved-viewer-panel">
      <div class="approved-viewer-toolbar">
        <div class="viewer-toolbar-left">
          <button id="viewerDownloadBtn" type="button" class="viewer-icon-btn">
            <span class="icon">â¬‡</span>
            <span>Download</span>
          </button>
          <button id="viewerDeleteBtn" type="button" class="viewer-icon-btn danger">
            <span class="icon">ðŸ—‘</span>
            <span>Delete</span>
          </button>
        </div>
        <button id="viewerCloseBtn" type="button" class="viewer-icon-btn close-only">
          <span class="icon">Ã—</span>
        </button>
      </div>
      <div class="approved-viewer-image-wrap">
        <img
          id="approvedViewerImg"
          class="approved-viewer-img"
          alt="Approved photo preview"
        />
      </div>
      <div class="approved-viewer-nav">
        <button id="viewerPrevBtn" type="button" class="viewer-nav-btn">
          â€¹ Prev
        </button>
        <button id="viewerNextBtn" type="button" class="viewer-nav-btn primary">
          Next â€º
        </button>
      </div>
    </div>
  </div>

  <!-- EVENT REPORT MODAL -->
<div id="reportOverlay" class="modal-overlay">
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-title">Event reports</div>
      <button id="reportCloseBtn" class="modal-close">Ã—</button>
    </div>
    <div class="modal-body">
      <p>
        View the current session summary or generate a full report that will be
        delivered to your configured email.
      </p>
      <div class="modal-actions">
        <button id="reportViewBtn" class="btn-ghost">View report (preview)</button>
        <button id="reportGenerateBtn" class="btn-primary">Generate &amp; email</button>
      </div>

      <!-- NEW: Lottie loader container -->
      <div id="reportLoading" class="report-loading" style="display:none;"></div>

      <pre id="reportPreview" class="report-preview">
Report preview will appear here once the backend preview endpoint is configured.
      </pre>
    </div>
  </div>
</div>

  <!-- APP SETTINGS MODAL -->
  <div id="settingsOverlay" class="modal-overlay">
    <div class="modal-panel settings-panel">
      <div class="modal-header">
        <div class="modal-title">App settings</div>
        <button id="settingsCloseBtn" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="settings-help">
          Customize the public form and ticket experience without editing code.
        </p>

        <div class="settings-section">
          <div class="settings-section-title">Ticket overlay</div>
          <div class="settings-row">
            <span class="settings-label">Show ticket number after upload</span>
            <label class="toggle">
              <input type="checkbox" id="settingsTicketEnabled" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Intro copy</div>
          <div class="settings-grid">
            <label class="settings-label" for="settingsIntroTitle">Intro title</label>
            <input id="settingsIntroTitle" class="settings-input" type="text" />
            <label class="settings-label" for="settingsIntroSubtitle">Intro subtitle</label>
            <input id="settingsIntroSubtitle" class="settings-input" type="text" />
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Form fields</div>
          <div class="settings-grid">
            <div class="settings-row">
              <span class="settings-label">Enable location (country/region)</span>
              <label class="toggle">
                <input type="checkbox" id="settingsLocationEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="settings-row">
              <span class="settings-label">Enable last name</span>
              <label class="toggle">
                <input type="checkbox" id="settingsLastNameEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsLastNameLabel">Last name label</label>
            <input id="settingsLastNameLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsLastNamePlaceholder">Last name placeholder</label>
            <input id="settingsLastNamePlaceholder" class="settings-input" type="text" />

            <div class="settings-row">
              <span class="settings-label">Enable email</span>
              <label class="toggle">
                <input type="checkbox" id="settingsEmailEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsEmailLabel">Email label</label>
            <input id="settingsEmailLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsEmailPlaceholder">Email placeholder</label>
            <input id="settingsEmailPlaceholder" class="settings-input" type="text" />

            <div class="settings-row">
              <span class="settings-label">Enable newsletter opt-in</span>
              <label class="toggle">
                <input type="checkbox" id="settingsNewsletterEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsNewsletterLabel">Newsletter label</label>
            <input id="settingsNewsletterLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsNewsletterHelper">Newsletter helper text</label>
            <input id="settingsNewsletterHelper" class="settings-input" type="text" />
          </div>
        </div>

        <div class="settings-actions">
          <span id="settingsStatus" class="settings-status"></span>
          <button id="settingsSaveBtn" class="btn-primary">Save settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Backend origin â€“ this is where your Node/Express lives
    const BASE_URL = "https://mayaguez-photoapp.vercel.app";
    const ADMIN_TOKEN_KEY = "lumi_admin_token_v1";
    const INACTIVITY_MS = 10 * 60 * 1000; // 10 minutes

    // Frame template used in gallery & downloads
    const FRAME_IMAGE_URL = "Assets/Photo App Template Image.png";

    // Stage + window specs (same as gallery CSS)
    const STAGE_WIDTH = 1920;
    const STAGE_HEIGHT = 1080;
    // photo-window = 1350x900 inside 1920x1080, 20px from top, 550px from left
    const WINDOW_X = (550 / 1920) * STAGE_WIDTH;
    const WINDOW_Y = (20 / 1080) * STAGE_HEIGHT;
    const WINDOW_WIDTH = (1350 / 1920) * STAGE_WIDTH;
    const WINDOW_HEIGHT = (900 / 1080) * STAGE_HEIGHT;

    // Reusable offscreen canvas for framed downloads
    const downloadCanvas = document.createElement("canvas");
    const downloadCtx = downloadCanvas.getContext("2d");

    // Preloaded frame image promise (to reduce errors)
    let frameImageCache = null;
    let frameImagePromise = null;

    function preloadFrameImage() {
      if (frameImagePromise) return frameImagePromise;
      frameImagePromise = new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          frameImageCache = img;
          resolve(img);
        };
        img.onerror = () => reject(new Error("Error loading frame PNG"));
        img.src = FRAME_IMAGE_URL;
      });
      return frameImagePromise;
    }
let globalLottie = null;

function ensureGlobalLottie() {
  if (!globalLottie) {
    globalLottie = lottie.loadAnimation({
      container: document.getElementById("globalLottie"),
      renderer: "svg",
      loop: true,
      autoplay: false,
      path: "Assets/Material wave loading.json",
    });
  }
}

function showGlobalLoader() {
  ensureGlobalLottie();
  const el = document.getElementById("globalLoader");
  el.style.display = "flex";
  globalLottie.goToAndPlay(0);
}

function hideGlobalLoader() {
  const el = document.getElementById("globalLoader");
  el.style.display = "none";
  if (globalLottie) globalLottie.stop();
}
    // Will store the admin session token returned by /admin/auth
    let adminToken = null;

    // Lock / auth elements
    const lockScreen = document.getElementById("lockScreen");
    const lockCard = document.getElementById("lockCard");
    const lockTitle = document.getElementById("lockTitle");
    const accessCodeInput = document.getElementById("accessCode");
    const accessSubmitBtn = document.getElementById("accessSubmit");
    const accessError = document.getElementById("accessError");

    // Admin UI elements
    const photoFrame = document.getElementById("photoFrame");
    const photoImg = document.getElementById("photoImg");
    const emptyText = document.getElementById("emptyText");
    const statusPill = document.getElementById("statusPill");
    const approveBtn = document.getElementById("approveBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    const appToggleInput = document.getElementById("appToggle");
    const appToggleWrapper = document.getElementById("appToggleWrapper");
    const appStatusDot = document.getElementById("appStatusDot");

    // NEW: photo meta elements
    const photoLabel = document.getElementById("photoLabel");
    const pendingCountEl = document.getElementById("pendingCount");
    const eventLogList = document.getElementById("eventLogList");
    const activityBars = document.getElementById("activityBars");
    const activityChart = document.getElementById("activityChart");
    const activityXAxis = document.getElementById("activityXAxis");
    const activityYAxis = document.getElementById("activityYAxis");
    // Pending counter state (frontend)
    let pendingCountState = 0;
    // Delta we expect after our own actions (approve/reject)
    let pendingCountDelta = 0;

    function updatePendingDisplay() {
      if (!pendingCountEl) return;
      pendingCountEl.textContent = `AWAITING APPROVAL: ${pendingCountState}`;
    }

    // Use backend count, but adjust if we know we just removed some items
    function applyPendingFromServer(rawPendingCount, isEmptyFlag) {
      if (!pendingCountEl) return;

      let serverCount = null;
      if (typeof rawPendingCount === "number") {
        serverCount = rawPendingCount;
      } else if (isEmptyFlag) {
        serverCount = 0;
      }

      // If backend didn't send anything, don't touch the current display
      if (serverCount === null) return;

      // If backend returns the SAME number we had before, but we know we just
      // approved/rejected items (pendingCountDelta != 0), adjust it by that delta.
      if (pendingCountDelta !== 0 && pendingCountState === serverCount) {
        pendingCountState = Math.max(0, serverCount + pendingCountDelta);
        pendingCountDelta = 0;
      } else {
        // Normal case: trust the backend
        pendingCountState = serverCount;
        pendingCountDelta = 0;
      }

      updatePendingDisplay();
    }
        // --- EVENT LOGS (right sidebar) ---

    function renderEventLogs(events) {
      if (!eventLogList) return;

      eventLogList.innerHTML = "";

      if (!events || !events.length) {
        const li = document.createElement("li");
        li.className = "event-log-item";

        const timeSpan = document.createElement("span");
        timeSpan.className = "event-log-time";
        timeSpan.textContent = "--:--";

        const textSpan = document.createElement("span");
        textSpan.className = "event-log-text";
        textSpan.textContent = "No recent events.";

        li.appendChild(timeSpan);
        li.appendChild(textSpan);
        eventLogList.appendChild(li);
        return;
      }

      events.forEach((evt) => {
        const li = document.createElement("li");
        li.className = "event-log-item";

        const timeSpan = document.createElement("span");
        timeSpan.className = "event-log-time";
        timeSpan.textContent = evt.time || "--:--";

        const textSpan = document.createElement("span");
        textSpan.className = "event-log-text";
        textSpan.textContent = evt.text || "";

        li.appendChild(timeSpan);
        li.appendChild(textSpan);
        eventLogList.appendChild(li);
      });
    }

    async function fetchEventLogs() {
      if (!adminToken) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/event-logs?limit=12`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          // auth will be handled by other flows; don't spam the lock
          return;
        }

        const data = await res.json();
        if (data && Array.isArray(data.events)) {
          renderEventLogs(data.events);
        }
      } catch (err) {
        console.error("Error fetching event logs", err);
      }
    }

    function formatHourLabel(hour) {
      const normalized = ((hour % 24) + 24) % 24;
      const period = normalized >= 12 ? "PM" : "AM";
      const hour12 = normalized % 12 || 12;
      return `${hour12}${period}`;
    }
    function getYAxisStep(maxCount) {
      if (maxCount <= 10) return 1;
      if (maxCount <= 100) return 10;
      if (maxCount <= 500) return 50;
      const rough = Math.ceil(maxCount / 9 / 50) * 50;
      return rough || 50;
    }

    function renderActivityBars(counts, currentHour) {
      if (!activityBars || !activityChart || !activityXAxis || !activityYAxis) return;
      if (!Array.isArray(counts) || counts.length !== 24) return;

      const displayHours = 6;
      const hours = [];
      for (let offset = displayHours - 1; offset >= 0; offset -= 1) {
        hours.push((currentHour - offset + 24) % 24);
      }
      const displayCounts = hours.map((hour) => counts[hour] || 0);

      const maxCount = Math.max(...displayCounts, 0);
      const step = getYAxisStep(maxCount);
      const maxTick = step * 9;
      const svgWidth = 300;
      const svgHeight = 140;
      const paddingTop = 8;
      const paddingBottom = 8;
      const paddingLeft = 8;
      const paddingRight = 8;
      const usableHeight = svgHeight - paddingTop - paddingBottom;
      const usableWidth = svgWidth - paddingLeft - paddingRight;

      activityYAxis.innerHTML = "";
      for (let i = 9; i >= 0; i -= 1) {
        const label = document.createElement("span");
        label.textContent = `${i * step}`;
        activityYAxis.appendChild(label);
      }

      activityXAxis.innerHTML = "";
      activityXAxis.style.gridTemplateColumns = `repeat(${hours.length}, minmax(0, 1fr))`;
      hours.forEach((hour) => {
        const label = document.createElement("span");
        label.textContent = formatHourLabel(hour);
        activityXAxis.appendChild(label);
      });

      const points = displayCounts.map((count, index) => {
        const denominator = displayCounts.length - 1 || 1;
        const x = paddingLeft + (usableWidth * index) / denominator;
        const ratio = maxTick ? Math.min(count / maxTick, 1) : 0;
        const y = paddingTop + usableHeight - ratio * usableHeight;
        return { x, y, count };
      });

      const linePoints = points.map((pt) => `${pt.x},${pt.y}`).join(" ");
      const fillPoints = `${paddingLeft},${paddingTop + usableHeight} ${linePoints} ${paddingLeft + usableWidth},${paddingTop + usableHeight}`;

      const currentX = paddingLeft + usableWidth;

      activityChart.innerHTML = `
        <line class="activity-grid-line" x1="${paddingLeft}" x2="${paddingLeft + usableWidth}" y1="${paddingTop + usableHeight}" y2="${paddingTop + usableHeight}" />
        ${Array.from({ length: 9 }, (_, i) => {
          const y = paddingTop + usableHeight - ((i + 1) / 9) * usableHeight;
          return `<line class="activity-grid-line" x1="${paddingLeft}" x2="${paddingLeft + usableWidth}" y1="${y}" y2="${y}" />`;
        }).join("")}
        <polygon class="activity-line-fill" points="${fillPoints}" />
        <polyline class="activity-line" points="${linePoints}" />
        ${points.map((pt) => `<circle class="activity-point" cx="${pt.x}" cy="${pt.y}" r="2" />`).join("")}
        <line class="activity-grid-line" x1="${currentX}" x2="${currentX}" y1="${paddingTop}" y2="${paddingTop + usableHeight}" />
      `;
    }

    async function fetchActivityStats() {
      if (!adminToken) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/activity-stats`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          return;
        }

        const data = await res.json();
        if (data && Array.isArray(data.counts)) {
          const currentHour = Number.isInteger(data.currentHour)
            ? data.currentHour
            : new Date().getHours();
          renderActivityBars(data.counts, currentHour);
        }
      } catch (err) {
        console.error("Error fetching activity stats", err);
      }
    }
    // LEFT NAV
    const navDashboard = document.getElementById("navDashboard");
    const navApproved = document.getElementById("navApproved");
    const navReports = document.getElementById("navReports");
    const navSettings = document.getElementById("navSettings");
    const navResetLogs = document.getElementById("navResetLogs");
    const lockAdminBtn = document.getElementById("lockAdminBtn");

    // Menu + approved overlay
    const moreButton = document.getElementById("moreButton");
    const moreMenu = document.getElementById("moreMenu");
    const approvedButton = document.getElementById("approvedButton");
    const menuViewApproved = document.getElementById("menuViewApproved");
    const menuGenerateReport = document.getElementById("menuGenerateReport");
    const menuGenerateReportYesterday = document.getElementById("menuGenerateReportYesterday");
    const menuResetLogs = document.getElementById("menuResetLogs");
    const menuClearApproved = document.getElementById("menuClearApproved");

    const approvedOverlay = document.getElementById("approvedOverlay");
    const approvedGrid = document.getElementById("approvedGrid");
    const approvedEmpty = document.getElementById("approvedEmpty");
    const approvedFooterText = document.getElementById("approvedFooterText");
    const approvedPrevBtn = document.getElementById("approvedPrevBtn");
    const approvedNextBtn = document.getElementById("approvedNextBtn");

    // Viewer overlay elements
    const approvedViewer = document.getElementById("approvedViewer");
    const approvedViewerImg = document.getElementById("approvedViewerImg");
    const viewerDownloadBtn = document.getElementById("viewerDownloadBtn");
    const viewerDeleteBtn = document.getElementById("viewerDeleteBtn");
    const viewerCloseBtn = document.getElementById("viewerCloseBtn");
    const viewerPrevBtn = document.getElementById("viewerPrevBtn");
    const viewerNextBtn = document.getElementById("viewerNextBtn");

    // REPORT MODAL ELEMENTS
    const reportOverlay = document.getElementById("reportOverlay");
    const reportCloseBtn = document.getElementById("reportCloseBtn");
    const reportViewBtn = document.getElementById("reportViewBtn");
    const reportGenerateBtn = document.getElementById("reportGenerateBtn");
    const reportPreview = document.getElementById("reportPreview");
    const reportLoading = document.getElementById("reportLoading");

    // SETTINGS MODAL ELEMENTS
    const settingsOverlay = document.getElementById("settingsOverlay");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const settingsSaveBtn = document.getElementById("settingsSaveBtn");
    const settingsStatus = document.getElementById("settingsStatus");
    const settingsTicketEnabled = document.getElementById("settingsTicketEnabled");
    const settingsIntroTitle = document.getElementById("settingsIntroTitle");
    const settingsIntroSubtitle = document.getElementById("settingsIntroSubtitle");
    const settingsLocationEnabled = document.getElementById("settingsLocationEnabled");
    const settingsLastNameEnabled = document.getElementById("settingsLastNameEnabled");
    const settingsLastNameLabel = document.getElementById("settingsLastNameLabel");
    const settingsLastNamePlaceholder = document.getElementById("settingsLastNamePlaceholder");
    const settingsEmailEnabled = document.getElementById("settingsEmailEnabled");
    const settingsEmailLabel = document.getElementById("settingsEmailLabel");
    const settingsEmailPlaceholder = document.getElementById("settingsEmailPlaceholder");
    const settingsNewsletterEnabled = document.getElementById("settingsNewsletterEnabled");
    const settingsNewsletterLabel = document.getElementById("settingsNewsletterLabel");
    const settingsNewsletterHelper = document.getElementById("settingsNewsletterHelper");

// Lottie loader for the report modal
let reportLottie = null;

function ensureReportLottie() {
  if (reportLottie || !window.lottie || !reportLoading) return;
  reportLottie = lottie.loadAnimation({
    container: reportLoading,
    renderer: "svg",
    loop: true,
    autoplay: false,
    path: "Assets/Material wave loading.json", // ðŸ”¥ your file
  });
}

function showReportLoading() {
  ensureReportLottie();
  if (reportLoading) {
    reportLoading.style.display = "flex";
  }
  if (reportLottie) {
    reportLottie.play();
  }
  // lock buttons while we load
  if (reportViewBtn) reportViewBtn.disabled = true;
  if (reportGenerateBtn) reportGenerateBtn.disabled = true;
  if (reportPreview) reportPreview.textContent = "";
}

function hideReportLoading() {
  if (reportLottie) {
    reportLottie.stop();
  }
  if (reportLoading) {
    reportLoading.style.display = "none";
  }
  if (reportViewBtn) reportViewBtn.disabled = false;
  if (reportGenerateBtn) reportGenerateBtn.disabled = false;
}

    let currentFileId = null;
    let isBusy = false;
    let autoRefreshId = null;
    let inactivityTimer = null;

    // Currently viewed approved file in zoom viewer
    let viewerCurrentFileId = null;
    let viewerCurrentImgUrl = null;
    let viewerCurrentIndex = -1;

    // App/server status
    let appServerEnabled = true;

    // Approved gallery paging
    let approvedFilesCache = [];
    let approvedPageIndex = 0;
    const APPROVED_PAGE_SIZE = 24;

    // --- Toggle UI (frontend) ---
    function updateStatusPill() {
      if (appServerEnabled) {
        statusPill.textContent = "SERVER STATUS: READY";
        statusPill.classList.remove("offline");
      } else {
        statusPill.textContent = "SERVER STATUS: OFFLINE";
        statusPill.classList.add("offline");
      }
    }

    function updateAppToggleUI(enabled) {
      appServerEnabled = enabled;
      if (enabled) {
        appToggleWrapper.classList.add("is-on");
        appToggleWrapper.classList.remove("disabled");
        appStatusDot.classList.add("on");
        appStatusDot.classList.remove("off");
      } else {
        appToggleWrapper.classList.remove("is-on");
        appStatusDot.classList.remove("on");
        appStatusDot.classList.add("off");
      }
      updateStatusPill();
    }

    function disableAdminControlsForOffline() {
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      statusPill.textContent = "SERVER STATUS: OFFLINE";
      statusPill.classList.add("offline");
      stopAutoRefresh();
    }

    // Load server app status from backend
    async function fetchAppStatus() {
      if (!adminToken) return;
      try {
        const res = await fetch(`${BASE_URL}/admin/app-status`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Enter the access code to continue.");
          return;
        }

        const data = await res.json();
        if (data && typeof data.enabled === "boolean") {
          updateAppToggleUI(data.enabled);
          appToggleInput.checked = data.enabled;
          if (!data.enabled) {
            disableAdminControlsForOffline();
          }
        } else {
          updateAppToggleUI(true);
          appToggleInput.checked = true;
        }
      } catch (err) {
        console.error("Error fetching app status", err);
        updateAppToggleUI(true);
        appToggleInput.checked = true;
      }
    }

    // --- Inactivity handling ---
    function clearAdminToken() {
      adminToken = null;
      localStorage.removeItem(ADMIN_TOKEN_KEY);
    }

    function resetInactivityTimer() {
      if (!adminToken) return;
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        clearAdminToken();
        showLock("Session closed due to inactivity.");
      }, INACTIVITY_MS);
    }

    ["click", "keydown", "mousemove", "touchstart"].forEach((evt) => {
      window.addEventListener(evt, resetInactivityTimer, { passive: true });
    });

    // --- Lock helpers ---
    function shakeLockCard() {
      lockCard.classList.remove("shake");
      void lockCard.offsetWidth; // force reflow
      lockCard.classList.add("shake");
    }

    function showLock(message) {
      if (message) {
        accessError.textContent = message;
      } else {
        accessError.textContent = "";
      }

      lockTitle.textContent = "Restricted access";
      lockTitle.style.color = "#f97373";
      lockCard.classList.remove("success");

      lockScreen.style.display = "flex";
      stopAutoRefresh();
      currentFileId = null;
      clearAdminToken();
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      accessCodeInput.value = "";
    }

    function hideLock() {
      accessError.textContent = "";
      lockScreen.style.display = "none";
      resetInactivityTimer();
    }

    // Helper: headers with admin token when available
    function withAdminHeaders(extra = {}) {
      const headers = { ...extra };
      if (adminToken) {
        headers["x-admin-token"] = adminToken;
      }
      return headers;
    }

    async function attemptLogin() {
      const code = accessCodeInput.value.trim();
      if (!code) {
        accessError.textContent = "Enter the access code.";
        shakeLockCard();
        return;
      }

      accessSubmitBtn.disabled = true;
      accessError.textContent = "";

      try {
        const res = await fetch(`${BASE_URL}/admin/auth`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (res.ok && data.ok && data.token) {
          adminToken = data.token;
          localStorage.setItem(ADMIN_TOKEN_KEY, adminToken);

          lockTitle.textContent = "Access granted";
          lockTitle.style.color = "#22c55e";
          lockCard.classList.add("success");
          accessCodeInput.value = "";

          setTimeout(async () => {
            hideLock();
            lockTitle.textContent = "Restricted access";
            lockTitle.style.color = "#f97373";
            lockCard.classList.remove("success");

            await fetchAppStatus();
            await loadNextPhoto();
            await fetchEventLogs();
            await fetchActivityStats();
            startAutoRefresh();
          }, 850);
        } else if (res.status === 401 && data.remainingAttempts != null) {
          accessError.textContent = `Incorrect code. Remaining attempts: ${data.remainingAttempts}.`;
          accessCodeInput.value = "";
          accessCodeInput.focus();
          shakeLockCard();
        } else if (res.status === 403 && data.error === "blocked") {
          const minutes = Math.ceil(data.blockedMinutes || 30);
          accessError.textContent = `Access blocked for ${minutes} minutes. Contact the administrator.`;
          accessCodeInput.value = "";
          shakeLockCard();
        } else if (data.error === "admin_code_not_configured") {
          accessError.textContent = "Access code is not configured on the server.";
          accessCodeInput.value = "";
          shakeLockCard();
        } else {
          accessError.textContent = "Authentication error. Please try again.";
          accessCodeInput.value = "";
          shakeLockCard();
        }
      } catch (err) {
        console.error(err);
        accessError.textContent = "Network error. Please try again.";
        shakeLockCard();
      } finally {
        accessSubmitBtn.disabled = false;
      }
    }

    accessSubmitBtn.addEventListener("click", attemptLogin);
    accessCodeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") attemptLogin();
    });

    // --- Busy + admin logic ---
    function setBusy(busy) {
      isBusy = busy;
      approveBtn.disabled = busy || !currentFileId || !appServerEnabled;
      rejectBtn.disabled = busy || !currentFileId || !appServerEnabled;
      if (busy) {
        statusPill.textContent = "PROCESSINGâ€¦";
      } else {
        updateStatusPill();
      }
    }

    async function loadNextPhoto() {
        if (!appServerEnabled) {
        disableAdminControlsForOffline();
        photoImg.style.display = "none";
        emptyText.style.display = "block";
        emptyText.textContent = "Server is offline for this event.";
        photoFrame.classList.add("empty");
        if (pendingCountEl) {
          pendingCountState = 0;
          pendingCountDelta = 0;
          updatePendingDisplay();
        }
        if (photoLabel) photoLabel.textContent = "PHOTO";
        return;
      }

      setBusy(true);
      photoImg.style.display = "none";
      emptyText.style.display = "block";
      emptyText.textContent = "Loading next pending photoâ€¦";
      photoFrame.classList.add("empty");

      try {
        const res = await fetch(`${BASE_URL}/admin/next-photo`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Enter the access code to continue.");
          return;
        }

        const data = await res.json();

        // NEW: handle pending counter & photo number using helper
        applyPendingFromServer(data.pendingCount, data.empty);

        if (photoLabel) {
          if (data.photoNumber != null) {
            photoLabel.textContent = `PHOTO #${data.photoNumber}`;
          } else if (data.fileId) {
            photoLabel.textContent = "PHOTO";
          } else {
            photoLabel.textContent = "PHOTO";
          }
        }

        if (data.empty) {
          currentFileId = null;
          emptyText.textContent = "There are no pending photos at this moment.";
          statusPill.textContent = appServerEnabled
            ? "SERVER STATUS: READY Â· NO PENDING"
            : "SERVER STATUS: OFFLINE";
          approveBtn.disabled = true;
          rejectBtn.disabled = true;
          return;
        }

        currentFileId = data.fileId;

        const imgUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
          currentFileId
        )}?token=${encodeURIComponent(adminToken || "")}`;

        photoImg.src = imgUrl;
        photoImg.onload = () => {
          photoFrame.classList.remove("empty");
          emptyText.style.display = "none";
          photoImg.style.display = "block";
        };

        statusPill.textContent = "SERVER STATUS: READY";
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
      } catch (err) {
        console.error(err);
        emptyText.textContent = "Error loading photo. Reload the page.";
        statusPill.textContent = "ERROR";
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
      } finally {
        setBusy(false);
      }
    }

    async function sendAction(endpoint) {
      if (!currentFileId || isBusy) return;
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      if (!appServerEnabled) {
        alert("Server is offline for this event.");
        return;
      }

      setBusy(true);

      try {
        const res = await fetch(`${BASE_URL}${endpoint}`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ fileId: currentFileId }),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          console.error("Action failed", res.status);
          statusPill.textContent = "ERROR";
          return;
        }

        // If the action actually succeeded, we know ONE item left the pending queue.
        if (endpoint === "/admin/approve" || endpoint === "/admin/reject") {
          pendingCountDelta -= 1; // accumulate in case of multiple quick actions
          if (pendingCountEl) {
            const previewCount = Math.max(0, pendingCountState + pendingCountDelta);
            pendingCountEl.textContent = `AWAITING APPROVAL: ${previewCount}`;
          }
        }
      } catch (err) {
        console.error(err);
        statusPill.textContent = "ERROR";
      } finally {
        await loadNextPhoto();
      }
    }

    approveBtn.addEventListener("click", () =>
      sendAction("/admin/approve")
    );
    rejectBtn.addEventListener("click", () =>
      sendAction("/admin/reject")
    );

    // --- Swipe logic ---
    let startX = null;

    function onStart(e) {
      const touch = e.touches ? e.touches[0] : e;
      startX = touch.clientX;
    }

    function onEnd(e) {
      if (startX == null || !currentFileId || isBusy) return;
      const touch = e.changedTouches ? e.changedTouches[0] : e;
      const dx = touch.clientX - startX;

      const threshold = 50;
      if (dx > threshold) {
        sendAction("/admin/approve");
      } else if (dx < -threshold) {
        sendAction("/admin/reject");
      }
      startX = null;
    }

    photoFrame.addEventListener("mousedown", onStart);
    photoFrame.addEventListener("mouseup", onEnd);
    photoFrame.addEventListener("touchstart", onStart);
    photoFrame.addEventListener("touchend", onEnd);

    // --- Auto-refresh / live updates ---
    async function checkForUpdates() {
      if (isBusy) return;
      if (!adminToken) return;
      if (!appServerEnabled) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/next-photo`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        const data = await res.json();

        // update counters if present (respecting our local delta)
        applyPendingFromServer(data.pendingCount, data.empty);
        
        if (photoLabel && data.photoNumber != null && !data.empty) {
          photoLabel.textContent = `PHOTO #${data.photoNumber}`;
        }

        if (data.empty) {
          if (currentFileId !== null) {
            await loadNextPhoto();
          }
          return;
        }

                if (currentFileId === null || data.fileId !== currentFileId) {
          await loadNextPhoto();
        }

        // also refresh event logs on the same cadence
        await fetchEventLogs();
        await fetchActivityStats();
      } catch (err) {
        console.error("Auto-refresh error", err);
      }
    }

    function startAutoRefresh() {
      if (autoRefreshId) return;
      autoRefreshId = setInterval(checkForUpdates, 10000);
    }

    function stopAutoRefresh() {
      if (!autoRefreshId) return;
      clearInterval(autoRefreshId);
      autoRefreshId = null;
    }

    // --- MENU LOGIC (kept mostly for compatibility) ---
    function closeMoreMenu() {
      moreMenu.style.display = "none";
    }

    function toggleMoreMenu() {
      if (moreMenu.style.display === "block") {
        closeMoreMenu();
      } else {
        moreMenu.style.display = "block";
      }
    }

    moreButton.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMoreMenu();
    });

    approvedButton.addEventListener("click", (e) => {
      e.stopPropagation();
      openApprovedOverlay();
    });

    document.addEventListener("click", (e) => {
      if (!moreMenu.contains(e.target) && e.target !== moreButton) {
        closeMoreMenu();
      }
    });

    // --- APPROVED GRID FUNCTIONS ---
    function openApprovedOverlay() {
      closeMoreMenu();
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      approvedOverlay.style.display = "flex";
      loadApprovedGrid();
    }

    function closeApprovedOverlay() {
      approvedOverlay.style.display = "none";
    }

    document.querySelectorAll("[data-close-approved]").forEach((btn) => {
      btn.addEventListener("click", closeApprovedOverlay);
    });

    function updateViewerNavButtons() {
      const total = approvedFilesCache.length;
      if (viewerCurrentIndex < 0 || total === 0) {
        viewerPrevBtn.disabled = true;
        viewerNextBtn.disabled = true;
        return;
      }
      viewerPrevBtn.disabled = viewerCurrentIndex <= 0;
      viewerNextBtn.disabled = viewerCurrentIndex >= total - 1;
    }

    function openApprovedViewer(fileId, imgUrl) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      viewerCurrentFileId = fileId;
      viewerCurrentImgUrl = imgUrl;
      approvedViewerImg.src = imgUrl;
      approvedViewer.style.display = "flex";

      viewerCurrentIndex = approvedFilesCache.findIndex(
        (item) => String(item.fileId) === String(fileId)
      );
      updateViewerNavButtons();
    }

    function closeApprovedViewer() {
      viewerCurrentFileId = null;
      viewerCurrentImgUrl = null;
      viewerCurrentIndex = -1;
      approvedViewer.style.display = "none";
    }

    approvedViewer.addEventListener("click", (e) => {
      if (e.target === approvedViewer) {
        closeApprovedViewer();
      }
    });

    viewerCloseBtn.addEventListener("click", closeApprovedViewer);

    function findThumbByFileId(fileId) {
      const thumbs = approvedGrid.querySelectorAll(".approved-thumb");
      for (const el of thumbs) {
        if (el.dataset.id === String(fileId)) return el;
      }
      return null;
    }

    function buildApprovedThumb(fileId, imgUrl) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "approved-thumb";
      btn.dataset.id = fileId;

      const img = document.createElement("img");
      img.src = imgUrl;
      img.alt = "Approved photo";

      const actions = document.createElement("div");
      actions.className = "approved-thumb-actions";

      const dlBtn = document.createElement("button");
      dlBtn.type = "button";
      dlBtn.className = "thumb-action-btn";
      dlBtn.innerHTML = '<span class="icon">â¬‡</span><span>DL</span>';

      dlBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        downloadApprovedWithFrame(fileId);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "thumb-action-btn danger";
      delBtn.innerHTML = '<span class="icon">ðŸ—‘</span><span>Del</span>';

      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        confirmDeleteApproved(fileId, btn);
      });

      actions.appendChild(dlBtn);
      actions.appendChild(delBtn);

      btn.appendChild(img);
      btn.appendChild(actions);

      btn.addEventListener("click", () => {
        openApprovedViewer(fileId, imgUrl);
      });

      return btn;
    }

    function renderApprovedPage() {
      approvedGrid.innerHTML = "";

      const total = approvedFilesCache.length;
      if (!total) {
        approvedEmpty.style.display = "block";
        approvedEmpty.textContent = "There are no approved photos at this moment.";
        approvedFooterText.textContent = "0 photos";
        approvedPrevBtn.disabled = true;
        approvedNextBtn.disabled = true;
        return;
      }

      approvedEmpty.style.display = "none";

      const start = approvedPageIndex * APPROVED_PAGE_SIZE;
      const end = Math.min(start + APPROVED_PAGE_SIZE, total);
      const slice = approvedFilesCache.slice(start, end);

      slice.forEach((item) => {
        const { fileId, imgUrl } = item;
        if (!imgUrl) return;
        const thumb = buildApprovedThumb(fileId, imgUrl);
        approvedGrid.appendChild(thumb);
      });

      approvedFooterText.textContent = `Showing ${start + 1}â€“${end} of ${total} photos`;
      approvedPrevBtn.disabled = approvedPageIndex === 0;
      approvedNextBtn.disabled = end >= total;
    }

    approvedPrevBtn.addEventListener("click", () => {
      if (approvedPageIndex === 0) return;
      approvedPageIndex -= 1;
      renderApprovedPage();
    });

    approvedNextBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(approvedFilesCache.length / APPROVED_PAGE_SIZE);
      if (approvedPageIndex >= totalPages - 1) return;
      approvedPageIndex += 1;
      renderApprovedPage();
    });

    async function loadApprovedGrid() {
      approvedGrid.innerHTML = "";
      approvedEmpty.style.display = "block";
      approvedEmpty.textContent = "Loading approved photosâ€¦";

      if (!adminToken) {
        approvedEmpty.textContent = "Session expired. Log in again.";
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}/admin/approved-list`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          approvedEmpty.textContent = "Session expired. Log in again.";
          showLock("Session expired. Enter the access code.");
          return;
        }

        const data = await res.json();
        const files = data.files || [];

        if (!files.length) {
          approvedFilesCache = [];
          approvedEmpty.textContent = "There are no approved photos at this moment.";
          approvedFooterText.textContent = "0 photos";
          return;
        }

        approvedFilesCache = [];

        files.forEach((f) => {
          let fileId = null;
          let imgUrl = "";

          if (typeof f === "string") {
            if (f.startsWith("http://") || f.startsWith("https://")) {
              imgUrl = f;
              fileId = f;
            } else {
              fileId = f;
            }
          } else if (f && typeof f === "object") {
            fileId = f.id || f.fileId || f.name || null;
            imgUrl =
              f.url ||
              f.thumbnailUrl ||
              f.thumbnailLink ||
              f.webViewLink ||
              "";
          }

          if (!imgUrl && fileId) {
            imgUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
              fileId
            )}?token=${encodeURIComponent(adminToken || "")}`;
          }

          if (!imgUrl) return;
          if (!fileId) fileId = imgUrl;

          approvedFilesCache.push({ fileId, imgUrl });
        });

        approvedPageIndex = 0;
        renderApprovedPage();
      } catch (err) {
        console.error("Error loading approved list", err);
        approvedEmpty.style.display = "block";
        approvedEmpty.textContent =
          "Error loading approved photos. Please try again.";
      }
    }

    function confirmDeleteApproved(fileId, thumbEl) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      const ok = window.confirm(
        "Are you sure you want to remove this approved photo from the gallery?\n\nThis action cannot be undone."
      );
      if (!ok) return;
      deleteApprovedPhoto(fileId, thumbEl);
    }

    async function deleteApprovedPhoto(fileId, thumbEl) {
      if (!fileId) return;
      if (thumbEl) thumbEl.classList.add("busy");

      try {
        const res = await fetch(`${BASE_URL}/admin/delete-approved`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ fileId }),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        approvedFilesCache = approvedFilesCache.filter(
          (item) => item.fileId !== fileId
        );

        renderApprovedPage();
      } catch (err) {
        console.error("Error deleting approved photo", err);
        if (thumbEl) thumbEl.classList.remove("busy");
        alert("Could not delete the approved photo. Please try again.");
      }
    }

    async function clearApprovedFolder() {
      closeMoreMenu();
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const ok = window.confirm(
        "Clear ALL photos from Pending + Approved?\n\n" +
          "This will permanently delete all images from both folders."
      );
      if (!ok) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/clear-drive`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({}),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        if (approvedOverlay.style.display === "flex") {
          approvedFilesCache = [];
          approvedGrid.innerHTML = "";
          approvedEmpty.style.display = "block";
          approvedEmpty.textContent = "There are no approved photos at this moment.";
          approvedFooterText.textContent = "0 photos";
        }

        alert("Pending + approved folders cleared.");
      } catch (err) {
        console.error("Error clearing approved folder", err);
        alert("Could not clear the folder. Please try again.");
      }
    }

    async function resetLogs() {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const ok = window.confirm(
        "Clear all event logs?\n\nThis keeps the header row but erases all event entries."
      );
      if (!ok) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/reset-logs`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({}),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        if (eventLogList) {
          eventLogList.innerHTML = "";
        }
        renderActivityBars(new Array(24).fill(0), new Date().getHours());

        alert("Event logs cleared.");
      } catch (err) {
        console.error("Error clearing logs", err);
        alert("Could not clear the logs. Please try again.");
      }
    }

    async function downloadApprovedWithFrame(fileId) {
      if (!fileId) return;
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const photoUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
        fileId
      )}?token=${encodeURIComponent(adminToken || "")}`;

      try {
        const photoImgEl = new Image();
        photoImgEl.crossOrigin = "anonymous";

        const frameImg = await preloadFrameImage();

        const photoPromise = new Promise((resolve, reject) => {
          photoImgEl.onload = resolve;
          photoImgEl.onerror = () => reject(new Error("Error loading photo"));
        });

        photoImgEl.src = photoUrl;

        await Promise.all([photoPromise]);

        const fw = STAGE_WIDTH;
        const fh = STAGE_HEIGHT;

        downloadCanvas.width = fw;
        downloadCanvas.height = fh;
        downloadCtx.clearRect(0, 0, fw, fh);

        const pw = photoImgEl.width;
        const ph = photoImgEl.height;

        if (!pw || !ph) {
          alert("Photo dimensions are invalid.");
          return;
        }

        const photoAspect = pw / ph;
        const windowAspect = WINDOW_WIDTH / WINDOW_HEIGHT;

        let sx, sy, sWidth, sHeight;

        if (photoAspect > windowAspect) {
          sHeight = ph;
          sWidth = sHeight * windowAspect;
          sx = (pw - sWidth) / 2;
          sy = 0;
        } else {
          sWidth = pw;
          sHeight = sWidth / windowAspect;
          sx = 0;
          sy = (ph - sHeight) / 2;
        }

        downloadCtx.drawImage(
          photoImgEl,
          sx,
          sy,
          sWidth,
          sHeight,
          WINDOW_X,
          WINDOW_Y,
          WINDOW_WIDTH,
          WINDOW_HEIGHT
        );

        if (frameImg) {
          downloadCtx.drawImage(frameImg, 0, 0, fw, fh);
        }

        function triggerDownloadFromBlob(blob) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `mayaguez_selfie_${fileId}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        if (typeof downloadCanvas.toBlob === "function") {
          downloadCanvas.toBlob(async (blob) => {
            if (blob) {
              triggerDownloadFromBlob(blob);
            } else {
              const dataUrl = downloadCanvas.toDataURL("image/png");
              const resp = await fetch(dataUrl);
              const fallbackBlob = await resp.blob();
              triggerDownloadFromBlob(fallbackBlob);
            }
          }, "image/png");
        } else {
          const dataUrl = downloadCanvas.toDataURL("image/png");
          const resp = await fetch(dataUrl);
          const blob = await resp.blob();
          triggerDownloadFromBlob(blob);
        }
      } catch (err) {
        console.error("Error generating framed download:", err);
        alert("Could not create the framed image. Please try again.");
      }
    }

    viewerDownloadBtn.addEventListener("click", () => {
      if (!viewerCurrentFileId) return;
      downloadApprovedWithFrame(viewerCurrentFileId);
    });

    viewerDeleteBtn.addEventListener("click", () => {
      if (!viewerCurrentFileId) return;
      const thumbEl = findThumbByFileId(viewerCurrentFileId);
      confirmDeleteApproved(viewerCurrentFileId, thumbEl);
      closeApprovedViewer();
    });

    viewerPrevBtn.addEventListener("click", () => {
      if (viewerCurrentIndex <= 0) return;
      viewerCurrentIndex -= 1;
      const item = approvedFilesCache[viewerCurrentIndex];
      if (!item) return;
      openApprovedViewer(item.fileId, item.imgUrl);
    });

    viewerNextBtn.addEventListener("click", () => {
      if (viewerCurrentIndex < 0) return;
      if (viewerCurrentIndex >= approvedFilesCache.length - 1) return;
      viewerCurrentIndex += 1;
      const item = approvedFilesCache[viewerCurrentIndex];
      if (!item) return;
      openApprovedViewer(item.fileId, item.imgUrl);
    });

    function getYesterdayDateString() {
      const now = new Date();
      now.setDate(now.getDate() - 1);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // --- MENU ITEM HANDLERS ---
    menuViewApproved.addEventListener("click", openApprovedOverlay);

   async function generateReportNow() {
  if (!adminToken) {
    showLock("Session expired. Enter the access code.");
    return;
  }

  // If the modal is open, we show the animation there.
  // If it's not open (called from kebab menu), it still runs fine.
  if (reportOverlay.style.display === "flex") {
    showGlobalLoader();
  }

  try {
    const res = await fetch(`${BASE_URL}/session-report-now`, {
      method: "POST",
      headers: withAdminHeaders({ "Content-Type": "application/json" }),
      body: JSON.stringify({}),
    });

    if (res.status === 401 || res.status === 403) {
      showLock("Session expired. Enter the access code.");
      return;
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }

    let data = {};
    try {
      data = await res.json();
    } catch (_) {}

    const text =
      (data && data.reportText) ||
      "Event report generated and sent to the configured email.";

    if (reportPreview) {
      reportPreview.textContent = text;
    }

    alert("Event report generated and sent to the configured email.");
  } catch (err) {
    console.error("Error generating event report", err);
    if (reportPreview) {
      reportPreview.textContent =
        "Could not generate the event report. Please try again.";
    }
    alert("Could not generate the event report. Please try again.");
  } finally {
    hideGlobalLoader();
  }
}

    menuResetLogs.addEventListener("click", () => {
      closeMoreMenu();
      resetLogs();
    });

    menuClearApproved.addEventListener("click", clearApprovedFolder);

    // --- SHUTDOWN FLOW (toggle) ---
    async function handleToggleChange(e) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      if (!appToggleInput.checked) {
        appToggleInput.checked = true;

        const confirmShutdown = window.confirm(
          "Would you like to shut down the server and generate the event report?"
        );
        if (!confirmShutdown) {
          appToggleInput.checked = true;
          return;
        }

        const code = window.prompt("Enter the access code to confirm:");
        if (!code) {
          appToggleInput.checked = true;
          return;
        }

        try {
          showGlobalLoader();
          const res = await fetch(`${BASE_URL}/admin/shutdown`, {
            method: "POST",
            headers: withAdminHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ accessCode: code }),
          });

          let data = {};
          try {
            data = await res.json();
          } catch (_) {}

          if (res.status === 401 && data.error === "invalid_access_code") {
            alert("Access code is incorrect.");
            return;
          }

          if (!res.ok || !data.ok) {
            const message = data.error
              ? `Could not shut down the server (${data.error}). Please try again.`
              : "Could not shut down the server. Please try again.";
            alert(message);
            return;
          }

          const reportText = data.reportText || "Event report generated.";

          const blob = new Blob([reportText], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "selfieapp_event_report.txt";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          updateAppToggleUI(false);
          appToggleInput.checked = false;
          disableAdminControlsForOffline();
          photoImg.style.display = "none";
          emptyText.style.display = "block";
          emptyText.textContent = "Server is offline for this event.";
          photoFrame.classList.add("empty");

          if (pendingCountEl) {
            pendingCountState = 0;
            pendingCountDelta = 0;
            updatePendingDisplay();
          }

          alert("Server has been shut down and the event report was generated.");
        } catch (err) {
          console.error("Error calling /admin/shutdown", err);
          alert("Could not shut down the server. Please try again.");
        } finally {
          hideGlobalLoader();
          await fetchAppStatus();
        }
      } else {
        const confirmStart = window.confirm(
          "Start a new session and bring the server online?"
        );
        if (!confirmStart) {
          appToggleInput.checked = false;
          return;
        }

        async function clearDriveForStart() {
          if (!adminToken) {
            showLock("Session expired. Enter the access code.");
            return false;
          }

          const ok = window.confirm(
            "Clear ALL photos from Pending + Approved before starting?\n\n" +
              "This will send every file to trash so the session can start clean."
          );
          if (!ok) return false;

          try {
            const res = await fetch(`${BASE_URL}/admin/clear-drive`, {
              method: "POST",
              headers: withAdminHeaders({ "Content-Type": "application/json" }),
              body: JSON.stringify({}),
            });

            if (res.status === 401 || res.status === 403) {
              showLock("Session expired. Enter the access code.");
              return false;
            }

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }

            return true;
          } catch (err) {
            console.error("Error clearing drive before start", err);
            alert("Could not clear the pending + approved folders. Please try again.");
            return false;
          }
        }

        async function attemptStartServer(allowRetry = true) {
          showGlobalLoader();
          try {
            const res = await fetch(`${BASE_URL}/admin/app-status`, {
              method: "POST",
              headers: withAdminHeaders({ "Content-Type": "application/json" }),
              body: JSON.stringify({ enabled: true }),
            });

            let data = {};
            try {
              data = await res.json();
            } catch (_) {}

            if (res.status === 401 || res.status === 403) {
              showLock("Session expired. Enter the access code.");
              appToggleInput.checked = false;
              return;
            }

            if (!res.ok || !data.ok) {
              const message = data.error
                ? `Could not start the server (${data.error}). Please try again.`
                : "Could not start the server. Please try again.";
              alert(message);
              appToggleInput.checked = false;

              if (allowRetry) {
                const cleared = await clearDriveForStart();
                if (cleared) {
                  await attemptStartServer(false);
                }
              }
              return;
            }

            updateAppToggleUI(true);
            appToggleInput.checked = true;
            appToggleWrapper.classList.remove("disabled");
            emptyText.style.display = "block";
            emptyText.textContent = "No pending photos.";
            photoFrame.classList.add("empty");

            if (pendingCountEl) {
              pendingCountState = 0;
              pendingCountDelta = 0;
              updatePendingDisplay();
            }

            await fetchEventLogs();
            await fetchActivityStats();
            await loadNextPhoto();
            startAutoRefresh();

            if (data.warning === "settings_persist_failed") {
              alert(
                "Server is online, but the status could not be saved to the Settings sheet. " +
                  "Please confirm Sheets permissions and try again."
              );
            } else {
              alert("Server is online and ready for a new session.");
            }
          } catch (err) {
            console.error("Error enabling server", err);
            alert("Could not start the server. Please try again.");
            appToggleInput.checked = false;
          } finally {
            hideGlobalLoader();
            await fetchAppStatus();
          }
        }

        try {
          await attemptStartServer();
        } catch (err) {
          console.error("Error enabling server", err);
          alert("Could not start the server. Please try again.");
          appToggleInput.checked = false;
          hideGlobalLoader();
        }
      }
    }

    appToggleInput.addEventListener("change", handleToggleChange);

    // --- LEFT NAV BEHAVIOR ---

    function setActiveNav(button) {
      [navDashboard, navApproved, navReports, navSettings, navResetLogs].forEach((btn) => {
        if (!btn) return;
        btn.classList.toggle("active", btn === button);
      });
    }

    if (navDashboard) {
      navDashboard.addEventListener("click", () => {
        setActiveNav(navDashboard);
        // Dashboard is the default view; nothing extra to show/hide right now
      });
    }

    if (navApproved) {
      navApproved.addEventListener("click", () => {
        setActiveNav(navApproved);
        openApprovedOverlay();
      });
    }

    if (navReports) {
      navReports.addEventListener("click", () => {
        setActiveNav(navReports);
        if (!adminToken) {
          showLock("Session expired. Enter the access code.");
          return;
        }
        openReportOverlay();
      });
    }

    if (navSettings) {
      navSettings.addEventListener("click", () => {
        setActiveNav(navSettings);
        openSettingsOverlay();
      });
    }

    if (navResetLogs) {
      navResetLogs.addEventListener("click", () => {
        setActiveNav(navResetLogs);
        menuResetLogs.click();
      });
    }

    if (lockAdminBtn) {
      lockAdminBtn.addEventListener("click", () => {
        clearAdminToken();
        showLock("Session locked. Enter the access code to continue.");
      });
    }

    // --- REPORT MODAL LOGIC ---

function openReportOverlay() {
  reportOverlay.style.display = "flex";
  reportPreview.textContent = "Tap â€œView report (preview)â€ to load the current summary.";
  hideReportLoading(); // make sure loader is off when you first open
}

    function closeReportOverlay() {
      reportOverlay.style.display = "none";
    }

    reportCloseBtn.addEventListener("click", closeReportOverlay);
    reportOverlay.addEventListener("click", (e) => {
      if (e.target === reportOverlay) {
        closeReportOverlay();
      }
    });

reportViewBtn.addEventListener("click", async () => {
  if (!adminToken) {
    showLock("Session expired. Enter the access code.");
    return;
  }

  showReportLoading();

  try {
    const res = await fetch(`${BASE_URL}/session-report-preview`, {
      method: "GET",
      headers: withAdminHeaders(),
    });

    if (res.status === 401 || res.status === 403) {
      showLock("Session expired. Enter the access code.");
      return;
    }

    if (!res.ok) {
      reportPreview.textContent =
        "Could not load the report preview. Please try again.";
      return;
    }

    const data = await res.json();

    if (data && data.reportText) {
      reportPreview.textContent = data.reportText;
    } else {
      reportPreview.textContent =
        "No report text was returned by the server.";
    }
  } catch (err) {
    console.error("Error fetching report preview", err);
    reportPreview.textContent =
      "Error loading the report preview. Please try again.";
  } finally {
    hideReportLoading();
  }
});

    reportGenerateBtn.addEventListener("click", async () => {
      await generateReportNow();
    });

    // --- Try to restore existing session on load ---

    function setSettingsStatus(message, tone = "muted") {
      if (!settingsStatus) return;
      settingsStatus.textContent = message || "";
      if (tone === "success") {
        settingsStatus.style.color = "#86efac";
      } else if (tone === "error") {
        settingsStatus.style.color = "#fca5a5";
      } else {
        settingsStatus.style.color = "var(--muted-grey)";
      }
    }

    function fillSettingsForm(settings) {
      if (!settings) return;
      settingsTicketEnabled.checked = Boolean(settings.ticketEnabled);
      settingsIntroTitle.value = settings.intro?.title || "";
      settingsIntroSubtitle.value = settings.intro?.subtitle || "";
      settingsLocationEnabled.checked = Boolean(settings.form?.locationEnabled);
      settingsLastNameEnabled.checked = Boolean(settings.form?.lastName?.enabled);
      settingsLastNameLabel.value = settings.form?.lastName?.label || "";
      settingsLastNamePlaceholder.value = settings.form?.lastName?.placeholder || "";
      settingsEmailEnabled.checked = Boolean(settings.form?.email?.enabled);
      settingsEmailLabel.value = settings.form?.email?.label || "";
      settingsEmailPlaceholder.value = settings.form?.email?.placeholder || "";
      settingsNewsletterEnabled.checked = Boolean(settings.form?.newsletter?.enabled);
      settingsNewsletterLabel.value = settings.form?.newsletter?.label || "";
      settingsNewsletterHelper.value = settings.form?.newsletter?.helper || "";
    }

    function collectSettingsPayload() {
      return {
        ticketEnabled: settingsTicketEnabled.checked,
        intro: {
          title: settingsIntroTitle.value.trim(),
          subtitle: settingsIntroSubtitle.value.trim(),
        },
        form: {
          locationEnabled: settingsLocationEnabled.checked,
          lastName: {
            enabled: settingsLastNameEnabled.checked,
            label: settingsLastNameLabel.value.trim(),
            placeholder: settingsLastNamePlaceholder.value.trim(),
          },
          email: {
            enabled: settingsEmailEnabled.checked,
            label: settingsEmailLabel.value.trim(),
            placeholder: settingsEmailPlaceholder.value.trim(),
          },
          newsletter: {
            enabled: settingsNewsletterEnabled.checked,
            label: settingsNewsletterLabel.value.trim(),
            helper: settingsNewsletterHelper.value.trim(),
          },
        },
      };
    }

    async function openSettingsOverlay() {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      settingsOverlay.style.display = "flex";
      setSettingsStatus("Loading settingsâ€¦");

      try {
        const res = await fetch(`${BASE_URL}/admin/settings`, {
          headers: withAdminHeaders(),
        });
        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }
        const data = await res.json();
        if (data && data.settings) {
          fillSettingsForm(data.settings);
          setSettingsStatus("");
        } else {
          setSettingsStatus("No settings were returned from the server.", "error");
        }
      } catch (err) {
        console.error("Error loading settings", err);
        setSettingsStatus("Failed to load settings.", "error");
      }
    }

    function closeSettingsOverlay() {
      settingsOverlay.style.display = "none";
      setSettingsStatus("");
    }

    if (settingsCloseBtn) {
      settingsCloseBtn.addEventListener("click", closeSettingsOverlay);
    }

    if (settingsOverlay) {
      settingsOverlay.addEventListener("click", (e) => {
        if (e.target === settingsOverlay) {
          closeSettingsOverlay();
        }
      });
    }

    if (settingsSaveBtn) {
      settingsSaveBtn.addEventListener("click", async () => {
        if (!adminToken) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        setSettingsStatus("Saving settingsâ€¦");

        try {
          const payload = collectSettingsPayload();
          const res = await fetch(`${BASE_URL}/admin/settings`, {
            method: "POST",
            headers: withAdminHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify(payload),
          });

          if (res.status === 401 || res.status === 403) {
            showLock("Session expired. Enter the access code.");
            return;
          }

          const data = await res.json();
          if (data && data.ok) {
            fillSettingsForm(data.settings);
            setSettingsStatus("Settings saved.", "success");
          } else {
            setSettingsStatus("Could not save settings.", "error");
          }
        } catch (err) {
          console.error("Error saving settings", err);
          setSettingsStatus("Error saving settings.", "error");
        }
      });
    }
    (function bootstrapAdmin() {
      preloadFrameImage().catch(() => {
        console.warn("Frame image preload failed (will retry on demand).");
      });

      const saved = localStorage.getItem(ADMIN_TOKEN_KEY);
      if (!saved) {
        showLock();
        return;
      }

      adminToken = saved;
      hideLock();

      fetchAppStatus()
        .then(() => loadNextPhoto())
        .then(() => fetchEventLogs())
        .then(() => fetchActivityStats())
        .then(() => startAutoRefresh())
        .catch(() => {
          showLock();
        });
    })();
  </script>
  <div id="globalLoader" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(10,17,30,0.75);
  z-index:99999;
  align-items:center;
  justify-content:center;
">
  <div id="globalLottie" style="width:180px;height:180px;"></div>
</div>
</body>
</html>
