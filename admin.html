<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LuminarApps - ADMIN Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <style>
  /* PIXY BRAND FONT */
  @font-face {
    font-family: 'Pixy';
    src: url('Assets/PIXY.woff2') format('woff2'),
         url('Assets/PIXY.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  /* PIXY FONT ON "Lock Admin" */
  #lockAdminBtn {
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif !important;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--destructive);
    font-weight: 600;
  }

  #lockAdminBtn:hover {
    color: hsl(0, 84%, 50%);
  }

  @font-face {
    font-family: 'FuturaBT-Light';
    src: url('Assets/FuturaBT-Light.woff2') format('woff2'),
         url('Assets/FuturaBT-Light.woff') format('woff');
    font-weight: 300;
    font-style: normal;
    font-display: swap;
  }

  :root {
    /* QR Code Studio HSL Theme Tokens - DARK MODE (default) - EXACT from style guide */
    --background: hsl(225, 10%, 8%);
    --foreground: hsl(210, 40%, 98%);
    --primary: hsl(268, 85%, 70%);
    --primary-foreground: hsl(225, 10%, 8%);
    --secondary: hsl(225, 12%, 16%);
    --secondary-foreground: hsl(210, 40%, 98%);
    --accent: hsl(197, 90%, 60%);
    --accent-foreground: hsl(225, 10%, 8%);
    --muted: hsl(225, 10%, 16%);
    --muted-foreground: hsl(215, 20%, 72%);
    --border: hsl(225, 12%, 24%);
    --input: hsl(225, 12%, 24%);
    --ring: hsl(268, 85%, 70%);
    --destructive: hsl(0, 62%, 30%);
    --destructive-foreground: hsl(210, 40%, 98%);
    --card: hsl(225, 12%, 12%);
    --card-foreground: hsl(210, 40%, 98%);
    --glass: hsl(225, 12%, 12% / 0.75);
    --glass-border: hsl(225, 12%, 22% / 0.6);
    --gradient-start: hsl(197, 90%, 60%);
    --gradient-end: hsl(268, 85%, 70%);
    
    /* Border radius system */
    --radius: 0.75rem; /* 12px */
    
    /* Amber/Gold accents for premium emphasis */
    --amber-200: #fde68a;
    --amber-300: #fcd34d;
    --amber-400: #fbbf24;
    --amber-500: #f59e0b;
    --yellow-400: #facc15;
    
    /* Default font stack (QRC) - keep Pixy where explicitly used */
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    color: var(--foreground);
    background: var(--background);
  }

  :root[data-theme="light"] {
    /* QR Code Studio HSL Theme Tokens - LIGHT MODE - EXACT from style guide */
    --background: hsl(220, 33%, 97%);
    --foreground: hsl(222, 47%, 11%);
    --primary: hsl(268, 85%, 55%);
    --primary-foreground: hsl(0, 0%, 100%);
    --secondary: hsl(220, 20%, 94%);
    --secondary-foreground: hsl(222, 47%, 11%);
    --accent: hsl(197, 90%, 45%);
    --accent-foreground: hsl(0, 0%, 100%);
    --muted: hsl(220, 16%, 92%);
    --muted-foreground: hsl(215, 16%, 45%);
    --border: hsl(220, 16%, 86%);
    --input: hsl(220, 16%, 86%);
    --ring: hsl(268, 85%, 55%);
    --destructive: hsl(0, 84%, 60%);
    --destructive-foreground: hsl(0, 0%, 100%);
    --card: hsl(0, 0%, 100%);
    --card-foreground: hsl(222, 47%, 11%);
    --glass: hsl(0, 0%, 100% / 0.7);
    --glass-border: hsl(220, 16%, 86% / 0.7);
    --gradient-start: hsl(197, 90%, 45%);
    --gradient-end: hsl(268, 85%, 55%);
  }

  * {
    box-sizing: border-box;
  }

  /* Glass panel utility - EXACT from style guide */
  .glass-panel {
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    opacity: 0.95;
  }

  /* Gradient text utility (sparingly used) */
  .gradient-text {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end), var(--amber-400));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  body {
    margin: 0;
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 2rem;
    background: var(--background);
    color: var(--foreground);
    overflow-x: hidden;
    max-width: 100vw;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .page-wrapper {
    width: 100%;
    max-width: 1280px;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* TOP HEADER BAR (logo + title + server status) */
  .admin-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.25rem;
    border-radius: calc(var(--radius) + 4px);
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    gap: 1rem;
    min-width: 0;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    min-width: 0;
  }

  .header-logo {
    height: 24px;
    width: auto;
    object-fit: contain;
  }

  .header-title {
    flex: 1;
    text-align: center;
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-size: 1.25rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--foreground);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    min-width: 0;
  }

  .status-pill {
    font-size: 0.6875rem;
    padding: 0.375rem 0.875rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--foreground);
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    white-space: nowrap;
    min-width: 0;
    font-weight: 500;
  }

  .status-pill.offline {
    border-color: var(--destructive);
    color: var(--destructive);
  }

  .theme-toggle {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .theme-toggle-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--foreground);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    padding: 0;
  }

  .theme-toggle-btn:hover {
    background: var(--muted);
    border-color: var(--primary);
    color: var(--primary);
    transform: scale(1.05);
  }

  .theme-toggle-btn:active {
    transform: scale(0.95);
  }

  .theme-toggle-btn svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: all 0.2s ease;
  }

  .theme-toggle-btn .icon-moon,
  .theme-toggle-btn .icon-sun {
    display: block;
  }

  .app-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    background: var(--destructive);
    box-shadow: none;
    flex-shrink: 0;
    display: inline-block;
  }

  .status-dot.on {
    background: var(--accent);
    box-shadow: 0 0 10px hsla(197, 90%, 45%, 0.6);
  }

  .status-dot.off {
    background: var(--destructive);
    box-shadow: none;
  }

  .toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 46px;
    height: 24px;
    border-radius: 999px;
    background: var(--muted);
    border: 1px solid var(--border);
    cursor: pointer;
    flex-shrink: 0;
  }

  .toggle input {
    display: none;
  }

  .toggle-slider {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
    border-radius: inherit;
  }

  .toggle-slider::before {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: #9ca3af;
    transition: transform 0.18s ease, background 0.18s ease;
  }

  .toggle.is-on {
    border-color: var(--accent);
    background: var(--accent);
  }

  .toggle.is-on .toggle-slider::before {
    transform: translateX(20px);
    background: white;
  }

  .toggle input:checked + .toggle-slider::before {
    transform: translateX(20px);
    background: white;
  }

  .toggle input:checked + .toggle-slider {
    background: var(--accent);
  }

  .toggle.disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* LAYOUT CARD (NAV + PHOTO + LOGS) */

  .card {
    margin-top: 0.5rem;
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-radius: calc(var(--radius) + 4px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    color: var(--card-foreground);
    border: 1px solid var(--glass-border);
    min-width: 0;
    transition: all 0.2s ease;
  }

  .card:hover {
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.15);
  }

  .card-main {
    display: grid;
    grid-template-columns: 190px minmax(0, 1fr) 250px;
    gap: 1.5rem;
    align-items: stretch;
    min-width: 0;
  }

  /* LEFT NAV */

  .sidebar-left {
    border-right: 1px solid var(--border);
    padding-right: 0.875rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-width: 0;
  }

  .nav-group {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .nav-label {
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    color: var(--muted-foreground);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .nav-item {
    text-align: left;
    border: none;
    background: transparent;
    color: var(--foreground);
    font-size: 0.875rem;
    padding: 0.5rem 0;
    cursor: pointer;
    letter-spacing: 0.1em;
    position: relative;
    font-weight: 500;
    transition: color 0.2s ease;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  /* Futura ONLY on the main nav items */
  #navDashboard,
  #navApproved,
  #navReports,
  #navSettings,
  #navResetLogs {
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 300;
  }

  .nav-item::before {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 2px;
    background: var(--primary);
    transition: width 0.18s ease;
  }

  .nav-item:hover {
    color: var(--primary);
  }

  .nav-item:hover::before,
  .nav-item.active::before {
    width: 22px;
  }

  .nav-item.active {
    color: var(--primary);
    font-weight: 600;
  }

  .nav-item-lock {
    margin-top: 1.5rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: var(--destructive);
    font-weight: 600;
  }

  .nav-item-lock:hover {
    color: hsl(0, 84%, 50%);
  }

  /* CENTER PANEL (PHOTO AREA) */

  .center-panel {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .photo-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    color: var(--muted-foreground);
    font-weight: 600;
    min-width: 0;
    gap: 0.75rem;
  }

  .photo-label {
    white-space: nowrap;
    min-width: 0;
  }

  .pending-count {
    font-size: 0.875rem;
    letter-spacing: 0.3em;
    color: var(--foreground);
    font-weight: 600;
    white-space: nowrap;
    min-width: 0;
  }

  .photo-frame {
    position: relative;
    background: var(--secondary);
    border-radius: var(--radius);
    overflow: hidden;
    min-height: 260px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: pan-y;
    border: 1px solid var(--border);
    min-width: 0;
  }

  .photo-frame.empty {
    border-style: dashed;
    border-color: var(--border);
  }

  .photo-frame img {
    max-width: 100%;
    max-height: 32.5rem;
    display: block;
    object-fit: contain;
    transition: transform 0.2s ease, opacity 0.2s ease;
    min-width: 0;
  }

  .empty-text {
    font-size: 0.8125rem;
    color: var(--muted-foreground);
    text-align: center;
    padding: 1.5rem 1rem;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .buttons {
    display: flex;
    gap: 0.625rem;
    margin-top: 0.625rem;
  }

  button {
    font-family: inherit;
  }

  .btn-reject,
  .btn-approve {
    flex: 1;
    height: 2.5rem;
    border-radius: calc(var(--radius) - 2px);
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    transition: all 0.2s ease;
    min-width: 0;
  }

  .btn-reject {
    background: var(--secondary);
    color: var(--foreground);
  }

  .btn-reject:hover {
    background: var(--muted);
    border-color: var(--destructive);
    color: var(--destructive);
  }

  .btn-approve {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .btn-approve:hover {
    background: hsl(197, 90%, 40%);
    border-color: hsl(197, 90%, 40%);
    filter: brightness(0.95);
  }

  button:disabled {
    opacity: 0.5;
    cursor: default;
  }

  .helper {
    font-size: 0.6875rem;
    color: var(--muted-foreground);
    text-align: center;
    margin-top: 0.125rem;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  /* RIGHT PANEL (EVENT LOGS + ACTIVITY) */

  .sidebar-right {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    border-left: 1px solid var(--border);
    padding-left: 1rem;
    min-width: 0;
  }

  .panel-box {
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: 0;
    min-width: 0;
  }

  .panel-title {
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted-foreground);
    font-weight: 600;
  }

  .event-log-list {
    margin: 0.25rem 0 0;
    padding: 0;
    list-style: none;
    font-size: 0.6875rem;
    color: var(--foreground);
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    min-width: 0;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .event-log-item {
    display: flex;
    justify-content: space-between;
    gap: 0.375rem;
    padding: 0.25rem 0;
    opacity: 0.9;
    min-width: 0;
  }

  .event-log-time {
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    letter-spacing: 0.3em;
    font-size: 0.625rem;
    color: var(--muted-foreground);
    white-space: nowrap;
    flex-shrink: 0;
    font-weight: 500;
  }

  .event-log-text {
    flex: 1;
    text-align: right;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .activity-bars {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 6px;
    padding-top: 4px;
  }

  .activity-chart {
    position: relative;
    height: 11.25rem;
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 0.5rem 0.5rem 0.75rem 2.25rem;
    min-width: 0;
  }

  .activity-chart svg {
    width: 100%;
    height: 100%;
    display: block;
    min-width: 0;
  }

  .activity-axis {
    font-size: 0.5625rem;
    color: var(--muted-foreground);
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .activity-axis.y {
    position: absolute;
    top: 0.5rem;
    left: 0.375rem;
    bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;
  }

  .activity-axis.x {
    display: grid;
    grid-template-columns: repeat(24, minmax(0, 1fr));
    gap: 0.125rem;
    padding-left: 2.25rem;
  }

  .activity-axis.x span {
    text-align: center;
    white-space: nowrap;
  }

  .activity-line {
    fill: none;
    stroke: var(--primary);
    stroke-width: 2;
  }

  .activity-line-fill {
    fill: hsla(268, 85%, 55%, 0.15);
  }

  .activity-point {
    fill: var(--primary);
  }

  .activity-grid-line {
    stroke: var(--border);
    stroke-dasharray: 3 3;
  }

  /* SMALL ICON BUTTONS (kept for logic but hidden from UI) */

  .kebab-button,
  .approved-button {
    display: none;
  }

  /* APPROVED OVERLAY (grid) – restyled but same IDs/classes */

  .approved-overlay {
    position: fixed;
    inset: 0;
    background: var(--background);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 30;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .approved-panel {
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-radius: calc(var(--radius) + 4px);
    width: 100%;
    max-width: 900px;
    max-height: calc(100dvh - 3rem);
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--glass-border);
    min-width: 0;
    color: var(--card-foreground);
  }

  .approved-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 4px;
  }

  .approved-title {
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--card-foreground);
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .approved-subtitle {
    font-size: 0.6875rem;
    color: var(--muted-foreground);
    margin-bottom: 0.25rem;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .approved-close-btn {
    border: none;
    background: transparent;
    color: var(--foreground);
    font-size: 20px;
    cursor: pointer;
    padding: 0 4px;
    transition: color 0.2s ease;
  }

  .approved-close-btn:hover {
    color: var(--primary);
  }

  .approved-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 8px;
    padding-top: 4px;
    padding-bottom: 6px;
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    min-width: 0;
  }

  .approved-empty {
    font-size: 0.8125rem;
    color: var(--muted-foreground);
    padding: 1rem 0.25rem 0.5rem;
    text-align: center;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .approved-thumb {
    position: relative;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 0;
    overflow: hidden;
    background: var(--card);
    cursor: pointer;
    flex: 0 0 auto;
    min-width: 0;
  }

  .approved-thumb img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .approved-thumb.busy {
    opacity: 0.4;
    cursor: default;
  }

  .approved-thumb-actions {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 4px 4px 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.16s ease, transform 0.16s ease;
    pointer-events: none;
    background: linear-gradient(
      to top,
      rgba(15, 23, 42, 0.95),
      rgba(15, 23, 42, 0.6),
      transparent
    );
  }

  .approved-thumb:hover .approved-thumb-actions {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .thumb-action-btn {
    border-radius: calc(var(--radius) - 4px);
    border: 1px solid var(--border);
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    color: var(--card-foreground);
    font-size: 0.5625rem;
    padding: 0.25rem 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 0.1875rem;
    cursor: pointer;
    font-weight: 500;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .thumb-action-btn span.icon {
    font-size: 10px;
    line-height: 1;
  }

  .thumb-action-btn.danger {
    border-color: var(--destructive);
    color: var(--destructive);
  }

  .approved-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.625rem;
    margin-top: 0.375rem;
    font-size: 0.625rem;
    color: var(--muted-foreground);
    min-width: 0;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .approved-footer-controls {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .approved-footer button {
    flex: 0 0 auto;
    min-width: 4rem;
    font-size: 0.625rem;
    padding: 0.3125rem 0.5625rem;
  }

  /* APPROVED VIEWER */

  .approved-viewer-overlay {
    position: fixed;
    inset: 0;
    background: var(--background);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 40;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .approved-viewer-panel {
    position: relative;
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-radius: calc(var(--radius) + 4px);
    width: 100%;
    max-width: 900px;
    max-height: calc(100dvh - 2rem);
    padding: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    border: 1px solid var(--glass-border);
    min-width: 0;
  }

  .approved-viewer-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    padding: 2px 2px 0;
  }

  .viewer-toolbar-left {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .viewer-icon-btn {
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--foreground);
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    flex: 0 0 auto;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    height: 2.5rem;
  }

  .viewer-icon-btn span.icon {
    font-size: 14px;
    line-height: 1;
  }

  .viewer-icon-btn.danger {
    border-color: var(--destructive);
    color: var(--destructive);
  }

  .viewer-icon-btn.close-only {
    padding: 0 6px;
    font-size: 20px;
    border: none;
    background: transparent;
  }

  .viewer-icon-btn.close-only:hover {
    color: var(--primary);
    background: transparent;
  }

  .viewer-icon-btn:hover {
    background: var(--muted);
    border-color: var(--primary);
    color: var(--primary);
  }

  .approved-viewer-image-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
  }

  .approved-viewer-img {
    max-width: 100%;
    max-height: calc(100dvh - 12rem);
    object-fit: contain;
    border-radius: var(--radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    background: var(--card);
    min-width: 0;
  }

  .approved-viewer-nav {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 2px 4px 0;
  }

  .viewer-nav-btn {
    flex: 0 0 auto;
    min-width: 4.375rem;
    font-size: 0.6875rem;
    padding: 0.5rem 0.875rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--secondary);
    color: var(--foreground);
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    height: 2.5rem;
  }

  .viewer-nav-btn.primary {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }

  .viewer-nav-btn.primary:hover {
    background: hsl(197, 90%, 40%);
    border-color: hsl(197, 90%, 40%);
    filter: brightness(0.95);
  }

  .viewer-nav-btn:disabled {
    opacity: 0.4;
    cursor: default;
  }

  /* PHOTO INFO OVERLAY */
  .photo-info-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: hsla(225, 10%, 8%, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  :root[data-theme="light"] .photo-info-overlay {
    background: hsla(220, 33%, 97%, 0.85);
  }

  .photo-info-content {
    width: 90%;
    max-width: 600px;
    max-height: calc(100dvh - 64px);
    overflow-y: auto;
    border-radius: calc(var(--radius) + 4px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .photo-info-preview {
    width: 100%;
    margin-bottom: 1.5rem;
    border-radius: calc(var(--radius) - 2px);
    overflow: hidden;
    background: var(--secondary);
    border: 1px solid var(--border);
  }

  .photo-info-preview-img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
    max-height: 400px;
  }

  .photo-info-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .photo-info-title {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: var(--foreground);
    margin: 0;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .photo-info-close {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: calc(var(--radius) - 4px);
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted-foreground);
    cursor: pointer;
    transition: all 0.2s;
  }

  .photo-info-close:hover {
    background: var(--secondary);
    border-color: var(--primary);
    color: var(--foreground);
  }

  .photo-info-close svg {
    width: 1rem;
    height: 1rem;
  }

  .photo-info-body {
    padding: 1.5rem;
  }

  .photo-info-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    color: var(--muted-foreground);
    font-size: 0.875rem;
  }

  .photo-info-loading .spinner {
    width: 2rem;
    height: 2rem;
    border: 2px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .photo-info-content-inner {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .photo-info-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .photo-info-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    color: var(--muted-foreground);
    font-weight: 500;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .photo-info-value {
    font-size: 0.875rem;
    color: var(--foreground);
    font-weight: 500;
    word-break: break-word;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .photo-info-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .photo-info-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: calc(var(--radius) - 2px);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .photo-info-btn svg {
    width: 1rem;
    height: 1rem;
  }

  .photo-info-btn-primary {
    background: var(--primary);
    color: var(--primary-foreground);
    border-color: var(--primary);
  }

  .photo-info-btn-primary:hover {
    background: var(--primary);
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px hsla(268, 85%, 70%, 0.3);
  }

  .photo-info-btn-secondary {
    background: transparent;
    color: var(--foreground);
    border-color: var(--border);
  }

  .photo-info-btn-secondary:hover {
    background: var(--secondary);
    border-color: var(--primary);
  }

  .photo-info-error {
    padding: 2rem;
    text-align: center;
    color: var(--destructive);
    font-size: 0.875rem;
  }

  /* REPORT MODAL (for Event Reports menu) */

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: var(--background);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none;
    align-items: flex-start;
    justify-content: center;
    z-index: 35;
    padding: 1.5rem 1rem;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .modal-panel {
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-radius: calc(var(--radius) + 4px);
    max-width: 640px;
    width: 100%;
    padding: 1.5rem;
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-width: 0;
    margin-top: 1.5rem;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
  }

  .modal-title {
    font-size: 0.875rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--card-foreground);
    font-weight: 600;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .modal-close {
    border: none;
    background: transparent;
    color: var(--foreground);
    font-size: 20px;
    cursor: pointer;
    padding: 0 4px;
    transition: color 0.2s ease;
  }

  .modal-close:hover {
    color: var(--primary);
  }

  .modal-body {
    font-size: 0.8125rem;
    color: var(--muted-foreground);
    line-height: 1.6;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    margin-bottom: 8px;
  }

  /* SETTINGS MODAL */

  .settings-panel {
    max-width: 760px;
    max-height: calc(100dvh - 3rem);
    overflow-y: auto;
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 300;
  }

  .settings-panel .modal-title,
  .settings-panel .settings-section-title,
  .settings-panel .settings-help,
  .settings-panel .settings-status {
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 300;
  }

  .settings-section {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    background: var(--card);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .settings-section-title {
    font-size: 0.6875rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted-foreground);
    font-weight: 600;
  }

  .settings-grid {
    display: grid;
    gap: 12px;
  }

  .settings-row {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
  }

  .settings-label {
    font-size: 0.6875rem;
    color: var(--card-foreground);
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .settings-input {
    width: 100%;
    height: 2.5rem;
    background: var(--background);
    border: 1px solid var(--input);
    border-radius: calc(var(--radius) - 2px);
    padding: 0.5rem 0.75rem;
    color: var(--foreground);
    font-size: 0.875rem;
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 300;
    transition: all 0.2s ease;
    min-width: 0;
  }

  .settings-input:focus {
    outline: none;
    border-color: var(--ring);
    box-shadow: 0 0 0 2px hsla(var(--ring) / 0.2);
  }

  select.settings-input {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.5rem;
  }

  .settings-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 6px;
  }

  .settings-status {
    min-height: 1rem;
    font-size: 0.75rem;
    color: var(--muted-foreground);
  }

  .settings-help {
    font-size: 0.6875rem;
    color: var(--muted-foreground);
    line-height: 1.5;
  }

  .btn-ghost,
  .btn-primary {
    height: 2.5rem;
    border-radius: calc(var(--radius) - 2px);
    padding: 0.5rem 0.875rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    cursor: pointer;
    font-family: 'FuturaBT-Light', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  @media (max-width: 720px) {
    .settings-panel {
      max-width: 100%;
    }

    .settings-row {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--foreground);
    flex: 0 0 auto;
    transition: all 0.2s ease;
  }

  .btn-ghost:hover {
    background: var(--secondary);
    border-color: var(--primary);
    color: var(--primary);
  }

  .btn-primary {
    background: var(--primary);
    border: 1px solid var(--primary);
    color: var(--primary-foreground);
    flex: 0 0 auto;
    transition: all 0.2s ease;
  }

  .btn-primary:hover {
    background: hsl(268, 85%, 50%);
    border-color: hsl(268, 85%, 50%);
    filter: brightness(0.95);
  }

  .report-preview {
    margin: 0;
    margin-top: 0.25rem;
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 0.75rem;
    font-size: 0.6875rem;
    color: var(--card-foreground);
    white-space: pre-wrap;
    min-width: 0;
    font-family: monospace;
    line-height: 1.6;
  }

  /* Report loading container for Lottie */
  .report-loading {
    display: none;
    align-items: center;
    justify-content: center;
    height: 120px;
  }

  /* LOCK SCREEN */

  .lock-screen {
    position: fixed;
    inset: 0;
    background: var(--background);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .lock-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
    max-width: 420px;
    padding: 0 24px;
  }

  .lock-header-id {
    text-align: center;
    margin-bottom: 6px;
  }

  .lock-app-name {
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-size: 2rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--foreground);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 600;
    min-width: 0;
  }

  .lock-location {
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--muted-foreground);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .lock-card {
    background: var(--card);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-radius: calc(var(--radius) + 4px);
    padding: 1.5rem;
    width: 100%;
    max-width: 340px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
    color: var(--card-foreground);
    border: 1px solid var(--glass-border);
    min-width: 0;
  }

  .lock-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
    color: var(--destructive);
    transition: color 0.2s ease;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .lock-input {
    width: 100%;
    height: 2.5rem;
    border-radius: calc(var(--radius) - 2px);
    border: 1px solid var(--input);
    background: var(--background);
    padding: 0.5rem 1rem;
    color: var(--foreground);
    font-size: 1.125rem;
    letter-spacing: 0.3em;
    outline: none;
    transition: all 0.2s ease;
    min-width: 0;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .lock-input::placeholder {
    font-size: 0.875rem;
    letter-spacing: 0.1em;
    color: var(--muted-foreground);
  }

  .lock-input:focus {
    border-color: var(--ring);
    box-shadow: 0 0 0 2px hsla(var(--ring) / 0.2);
  }

  .lock-button {
    margin-top: 0.75rem;
    width: 100%;
    height: 2.5rem;
    border-radius: calc(var(--radius) - 2px);
    border: none;
    background: var(--accent);
    color: var(--accent-foreground);
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.3em;
    transition: all 0.2s ease;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .lock-button:hover {
    background: hsl(197, 90%, 40%);
  }

  .lock-button:disabled {
    opacity: 0.6;
    cursor: default;
  }

  .lock-error {
    margin-top: 0.5rem;
    font-size: 0.6875rem;
    color: var(--destructive);
    min-height: 0.875rem;
    text-align: center;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  .lock-meta {
    margin-top: 0.5rem;
    font-size: 0.625rem;
    color: var(--muted-foreground);
    text-align: center;
    line-height: 1.5;
    font-family: "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  }

  @keyframes lock-shake {
    0%   { transform: translateX(0); }
    20%  { transform: translateX(-6px); }
    40%  { transform: translateX(6px); }
    60%  { transform: translateX(-4px); }
    80%  { transform: translateX(4px); }
    100% { transform: translateX(0); }
  }

  .lock-card.shake {
    animation: lock-shake 0.35s ease;
  }

  @keyframes lock-pulse {
    0% { transform: scale(1); box-shadow: 0 18px 45px rgba(0,0,0,0.7); }
    50% { transform: scale(1.01); box-shadow: 0 22px 55px rgba(16,185,129,0.7); }
    100% { transform: scale(1); box-shadow: 0 18px 45px rgba(0,0,0,0.7); }
  }

  .lock-card.success {
    animation: lock-pulse 0.3s ease;
  }

  .lock-brand {
    font-family: 'Pixy', "Gotham", "Satoshi", "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    font-size: 0.625rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted-foreground);
    opacity: 0.9;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    margin-top: 0.75rem;
    font-weight: 500;
    min-width: 0;
  }

  /* RESPONSIVE */

  /* Tablets / small laptops */
  @media (max-width: 1024px) {
    body {
      padding: 0.75rem;
      max-width: 100vw;
      overflow-x: hidden;
    }

    .card-main {
      grid-template-columns: 170px minmax(0, 1fr);
      grid-template-rows: auto auto;
      grid-template-areas:
        "nav center"
        "nav right";
      min-width: 0;
    }

    .sidebar-left { 
      grid-area: nav; 
      min-width: 0;
    }
    .center-panel { 
      grid-area: center; 
      min-width: 0;
    }
    .sidebar-right { 
      grid-area: right; 
      min-width: 0;
    }
  }

  /* Phones – stacked vertical layout, mobile-friendly nav + header */
  @media (max-width: 768px) {
    body {
      padding: 0.75rem 0.625rem;
      max-width: 100vw;
      overflow-x: hidden;
    }

    .page-wrapper {
      gap: 0.75rem;
      min-width: 0;
      max-width: 100%;
    }

    .admin-header {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
      border-radius: calc(var(--radius) + 4px);
      padding: 0.75rem 0.875rem;
      gap: 0.625rem;
      min-width: 0;
    }

    .header-left,
    .header-right {
      width: 100%;
      justify-content: center;
      min-width: 0;
    }

    .header-left {
      justify-content: center;
      gap: 0.5rem;
    }

    .header-title {
      font-size: 0.875rem;
      letter-spacing: 0.2em;
      white-space: normal;
      line-height: 1.3;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .header-right {
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .status-pill {
      font-size: 0.5625rem;
      padding: 0.3125rem 0.625rem;
      min-width: 0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .card {
      padding: 0.875rem 0.75rem;
      border-radius: calc(var(--radius) + 4px);
      min-width: 0;
    }

    .card-main {
      grid-template-columns: minmax(0, 1fr);
      grid-template-rows: auto auto auto;
      grid-template-areas:
        "nav"
        "center"
        "right";
      gap: 0.75rem;
      min-width: 0;
    }

    .sidebar-left {
      grid-area: nav;
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding: 0.375rem 0 0.75rem;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 0;
    }

    .nav-label {
      display: none;
    }

    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      padding: 0.625rem 0.875rem;
      text-align: center;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 0.8125rem;
      width: 100%;
      min-width: 0;
    }

    .nav-item::before {
      display: none;
    }

    .nav-item.active {
      background: var(--card);
      color: var(--primary);
      border-color: var(--primary);
    }

    .nav-item-lock {
      align-self: center;
      margin-top: 4px;
      font-size: 14px;
      letter-spacing: 0.18em;
    }

    .center-panel {
      grid-area: center;
    }

    .photo-meta-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
      font-size: 0.75rem;
    }

    .pending-count {
      font-size: 0.875rem;
    }

    .photo-frame {
      min-height: 260px;
    }

    .sidebar-right {
      grid-area: right;
      border-left: none;
      padding-left: 0;
      border-top: 1px solid var(--border);
      padding-top: 0.75rem;
      margin-top: 0;
      min-width: 0;
    }

    .panel-box {
      min-height: 0;
    }

    .event-log-list {
      max-height: 10rem;
    }

    .activity-bars {
      gap: 0.25rem;
    }

    .activity-chart {
      height: 8.5rem;
    }
  }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js" integrity="sha512-tB17y8UnF6R45OZyeP+fM4x6hzFH6qC1t1PmiJdWWYV7eonbbyrcF0av8RyzZkjIl95QoUiG+2l3OjVhL7Jqmw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- LOCK OVERLAY -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-wrapper">
      <div class="lock-header-id">
        <div class="lock-app-name">PHOTO APP</div>
        <div class="lock-location">Pantalla Plaza Colón</div>
      </div>

      <div class="lock-card" id="lockCard">
        <div id="lockTitle" class="lock-title">Restricted access</div>

                <input
          id="accessCode"
          class="lock-input"
          type="password"
          placeholder="Access code"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        />

        <button id="accessSubmit" class="lock-button">ENTER</button>

        <div id="accessError" class="lock-error"></div>

        <div class="lock-meta">
          This tool is for internal use by Luminar Apps and Municipio de Mayagüez.
        </div>
      </div>

      <div class="lock-brand">LMNR GROUP X MUNICIPIO DE MAYAGUEZ</div>
    </div>
  </div>

  <div class="page-wrapper">
    <!-- TOP HEADER -->
    <header class="admin-header">
      <div class="header-left">
        <img
          src="Assets/Luminar.Apps-Light.png"
          alt="Luminar Apps"
          class="header-logo"
        />
      </div>

      <div class="header-title">ADMIN PORTAL</div>

      <div class="header-right">
        <button class="theme-toggle-btn" id="themeToggleBtn" title="Toggle dark/light mode" aria-label="Toggle theme">
          <svg class="icon-moon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg class="icon-sun" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
        <div class="app-toggle">
          <span id="appStatusDot" class="status-dot off"></span>
          <label class="toggle" id="appToggleWrapper">
            <input type="checkbox" id="appToggle" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <span id="statusPill" class="status-pill">SERVER STATUS: LOADING…</span>
      </div>
    </header>

    <!-- MAIN CARD -->
    <div class="card">
      <div class="card-main">
        <!-- LEFT NAV -->
        <aside class="sidebar-left">
          <div class="nav-group">
            <div class="nav-label">Dashboard</div>
            <button class="nav-item active" id="navDashboard">DASHBOARD</button>
            <button class="nav-item" id="navApproved">APPROVED PHOTOS</button>
            <button class="nav-item" id="navReports">EVENT REPORTS</button>
            <button class="nav-item" id="navSettings">APP SETTINGS</button>
            <button class="nav-item" id="navResetLogs">RESET LOGS</button>
          </div>
          <button class="nav-item nav-item-lock" id="lockAdminBtn">Lock Admin</button>
        </aside>

        <!-- CENTER PANEL (PHOTO REVIEW) -->
        <section class="center-panel">
          <div class="photo-meta-row">
            <div id="photoLabel" class="photo-label">PHOTO</div>
            <div id="pendingCount" class="pending-count">AWAITING APPROVAL: 0</div>
          </div>

          <div id="photoFrame" class="photo-frame empty">
            <div id="emptyText" class="empty-text">
              Loading next pending photo…
            </div>
            <img id="photoImg" alt="Pending photo" style="display:none;" />
          </div>

          <div class="buttons">
            <button id="rejectBtn" class="btn-reject" disabled>Reject</button>
            <button id="approveBtn" class="btn-approve" disabled>Approve</button>
          </div>
        </section>

        <!-- RIGHT PANEL (EVENT LOGS + ACTIVITY) -->
        <aside class="sidebar-right">
          <div class="panel-box">
            <div class="panel-title">Event logs:</div>
            <ul id="eventLogList" class="event-log-list">
              <!-- Static placeholder entries; backend can replace later -->
              <li class="event-log-item">
                <span class="event-log-time">08:19 PM</span>
                <span class="event-log-text">User submitted a form</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:18 PM</span>
                <span class="event-log-text">User uploaded a photo</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:16 PM</span>
                <span class="event-log-text">User visited the web app</span>
              </li>
              <li class="event-log-item">
                <span class="event-log-time">08:15 PM</span>
                <span class="event-log-text">User subscribed to newsletter</span>
              </li>
            </ul>
          </div>

          <div class="panel-box">
          <div class="panel-title">Activity</div>
            <div id="activityBars" class="activity-bars">
              <div class="activity-chart">
                <div id="activityYAxis" class="activity-axis y"></div>
                <svg id="activityChart" viewBox="0 0 300 140" preserveAspectRatio="none"></svg>
              </div>
              <div id="activityXAxis" class="activity-axis x"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- HIDDEN BUTTONS (kept for existing JS logic, but not shown in UI) -->
  <button id="moreButton" class="kebab-button" type="button">⚙︎</button>
  <button id="approvedButton" class="approved-button" type="button">▦</button>

  <!-- DROPDOWN MENU (logic kept, but mostly triggered from left nav now) -->
  <div id="moreMenu" class="dropdown-menu" style="display:none;">
    <div id="menuViewApproved" class="dropdown-item">
      <span>View approved photos</span>
    </div>
    <div id="menuGenerateReport" class="dropdown-item">
      <span>Generate event report</span>
      <span class="helper-label">(send email)</span>
    </div>
    <div id="menuGenerateReportYesterday" class="dropdown-item">
      <span>Generate yesterday's report</span>
      <span class="helper-label">(send email)</span>
    </div>
    <div class="dropdown-separator"></div>
    <div id="menuResetLogs" class="dropdown-item">
      <span>Reset logs</span>
      <span class="helper-label">(clear event logs)</span>
    </div>
    <div id="menuClearApproved" class="dropdown-item">
      <span>Clear drive (pending + approved)</span>
    </div>
  </div>

  <!-- APPROVED PHOTOS OVERLAY -->
  <div id="approvedOverlay" class="approved-overlay">
    <div class="approved-panel">
      <div class="approved-header">
        <div>
          <div class="approved-title">Approved photos</div>
          <div class="approved-subtitle">
            Tap a thumbnail to view it. Hover to download or delete.
          </div>
        </div>
        <button
          type="button"
          class="approved-close-btn"
          data-close-approved="1"
        >×</button>
      </div>

      <div id="approvedEmpty" class="approved-empty">
        Loading approved photos…
      </div>
      <div id="approvedGrid" class="approved-grid"></div>

      <div class="approved-footer">
        <div id="approvedFooterText">
          Changes may take a few seconds to appear on the public screen.
        </div>
        <div class="approved-footer-controls">
          <button type="button" id="approvedPrevBtn" class="btn-reject">
            Prev
          </button>
          <button type="button" id="approvedNextBtn" class="btn-approve">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SINGLE APPROVED PHOTO VIEWER -->
  <div id="approvedViewer" class="approved-viewer-overlay">
    <div class="approved-viewer-panel">
      <div class="approved-viewer-toolbar">
        <div class="viewer-toolbar-left">
          <button id="viewerDownloadBtn" type="button" class="viewer-icon-btn">
            <span class="icon">⬇</span>
            <span>Download</span>
          </button>
          <button id="viewerDeleteBtn" type="button" class="viewer-icon-btn danger">
            <span class="icon">🗑</span>
            <span>Delete</span>
          </button>
        </div>
        <button id="viewerCloseBtn" type="button" class="viewer-icon-btn close-only">
          <span class="icon">×</span>
        </button>
      </div>
      <div class="approved-viewer-image-wrap">
        <img
          id="approvedViewerImg"
          class="approved-viewer-img"
          alt="Approved photo preview"
        />
      </div>
      <div class="approved-viewer-nav">
        <button id="viewerPrevBtn" type="button" class="viewer-nav-btn">
          ‹ Prev
        </button>
        <button id="viewerNextBtn" type="button" class="viewer-nav-btn primary">
          Next ›
        </button>
      </div>
    </div>
  </div>

  <!-- PHOTO INFO OVERLAY -->
  <div id="photoInfoOverlay" class="photo-info-overlay" style="display: none;">
    <div class="photo-info-content glass-panel">
      <div class="photo-info-header">
        <h3 class="photo-info-title">PHOTO DETAILS</h3>
        <button class="photo-info-close" id="photoInfoClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="photo-info-body">
        <div id="photoInfoLoading" class="photo-info-loading">
          <div class="spinner"></div>
          <span>Loading photo information...</span>
        </div>

        <div id="photoInfoContent" class="photo-info-content-inner" style="display: none;">
          <!-- Photo Preview -->
          <div class="photo-info-preview">
            <img id="photoInfoPreviewImg" class="photo-info-preview-img" alt="Photo preview" />
          </div>

          <div class="photo-info-section">
            <div class="photo-info-label">USER EMAIL</div>
            <div id="photoInfoEmail" class="photo-info-value">—</div>
          </div>

          <div class="photo-info-section">
            <div class="photo-info-label">LOCATION</div>
            <div id="photoInfoLocation" class="photo-info-value">—</div>
          </div>

          <div class="photo-info-section">
            <div class="photo-info-label">LAST NAME</div>
            <div id="photoInfoName" class="photo-info-value">—</div>
          </div>

          <div class="photo-info-actions">
            <button id="photoInfoDownloadTemplate" class="photo-info-btn photo-info-btn-primary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>DOWNLOAD FOR INSTAGRAM</span>
            </button>
            <button id="photoInfoDownloadOriginal" class="photo-info-btn photo-info-btn-secondary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>DOWNLOAD ORIGINAL</span>
            </button>
          </div>
        </div>

        <div id="photoInfoError" class="photo-info-error" style="display: none;">
          <p>Unable to load photo information.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- EVENT REPORT MODAL -->
<div id="reportOverlay" class="modal-overlay">
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-title">Event reports</div>
      <button id="reportCloseBtn" class="modal-close">×</button>
    </div>
    <div class="modal-body">
      <p>
        View the current session summary or generate a full report that will be
        delivered to your configured email.
      </p>
      <div class="modal-actions">
        <button id="reportViewBtn" class="btn-ghost">View report (preview)</button>
        <button id="reportGenerateBtn" class="btn-primary">Generate &amp; email</button>
      </div>

      <!-- NEW: Lottie loader container -->
      <div id="reportLoading" class="report-loading" style="display:none;"></div>

      <pre id="reportPreview" class="report-preview">
Report preview will appear here once the backend preview endpoint is configured.
      </pre>
    </div>
  </div>
</div>

  <!-- APP SETTINGS MODAL -->
  <div id="settingsOverlay" class="modal-overlay">
    <div class="modal-panel settings-panel">
      <div class="modal-header">
        <div class="modal-title">App settings</div>
        <button id="settingsCloseBtn" class="modal-close">×</button>
      </div>
      <div class="modal-body">
        <p class="settings-help">
          Customize the public form and ticket experience without editing code.
        </p>

        <div class="settings-section">
          <div class="settings-section-title">Ticket overlay</div>
          <div class="settings-row">
            <span class="settings-label">Show ticket number after upload</span>
            <label class="toggle">
              <input type="checkbox" id="settingsTicketEnabled" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Gallery display</div>
          <div class="settings-grid">
            <label class="settings-label" for="settingsGalleryDisplayLimit">Photos to display in gallery</label>
            <select id="settingsGalleryDisplayLimit" class="settings-input">
              <option value="all">All photos</option>
              <option value="last25">Last 25 photos</option>
              <option value="last10">Last 10 photos</option>
            </select>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Intro copy</div>
          <div class="settings-grid">
            <label class="settings-label" for="settingsIntroTitle">Intro title</label>
            <input id="settingsIntroTitle" class="settings-input" type="text" />
            <label class="settings-label" for="settingsIntroSubtitle">Intro subtitle</label>
            <input id="settingsIntroSubtitle" class="settings-input" type="text" />
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Form fields</div>
          <div class="settings-grid">
            <div class="settings-row">
              <span class="settings-label">Enable location (country/region)</span>
              <label class="toggle">
                <input type="checkbox" id="settingsLocationEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="settings-row">
              <span class="settings-label">Enable last name</span>
              <label class="toggle">
                <input type="checkbox" id="settingsLastNameEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsLastNameLabel">Last name label</label>
            <input id="settingsLastNameLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsLastNamePlaceholder">Last name placeholder</label>
            <input id="settingsLastNamePlaceholder" class="settings-input" type="text" />

            <div class="settings-row">
              <span class="settings-label">Enable email</span>
              <label class="toggle">
                <input type="checkbox" id="settingsEmailEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsEmailLabel">Email label</label>
            <input id="settingsEmailLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsEmailPlaceholder">Email placeholder</label>
            <input id="settingsEmailPlaceholder" class="settings-input" type="text" />

            <div class="settings-row">
              <span class="settings-label">Enable newsletter opt-in</span>
              <label class="toggle">
                <input type="checkbox" id="settingsNewsletterEnabled" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <label class="settings-label" for="settingsNewsletterLabel">Newsletter label</label>
            <input id="settingsNewsletterLabel" class="settings-input" type="text" />
            <label class="settings-label" for="settingsNewsletterHelper">Newsletter helper text</label>
            <input id="settingsNewsletterHelper" class="settings-input" type="text" />
          </div>
        </div>

        <div class="settings-actions">
          <span id="settingsStatus" class="settings-status"></span>
          <button id="settingsSaveBtn" class="btn-primary">Save settings</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Backend origin – this is where your Node/Express lives
    const BASE_URL = "https://mayaguez-photoapp.vercel.app";
    const ADMIN_TOKEN_KEY = "lumi_admin_token_v1";
    const INACTIVITY_MS = 10 * 60 * 1000; // 10 minutes

    // Frame template used in gallery & downloads
    const FRAME_IMAGE_URL = "Assets/Photo App Template Image.png";
    // Vertical template for admin downloads
    const DOWNLOAD_TEMPLATE_URL = "Assets/IGFiturVertical.png";

    // Stage + window specs (same as gallery CSS)
    const STAGE_WIDTH = 1920;
    const STAGE_HEIGHT = 1080;
    // photo-window = 1350x900 inside 1920x1080, 20px from top, 550px from left
    const WINDOW_X = (550 / 1920) * STAGE_WIDTH;
    const WINDOW_Y = (20 / 1080) * STAGE_HEIGHT;
    const WINDOW_WIDTH = (1350 / 1920) * STAGE_WIDTH;
    const WINDOW_HEIGHT = (900 / 1080) * STAGE_HEIGHT;

    // Download template specs (vertical 1080x1920)
    const DOWNLOAD_TEMPLATE_WIDTH = 1080;
    const DOWNLOAD_TEMPLATE_HEIGHT = 1920;
    const DOWNLOAD_PHOTO_WIDTH = 1000;
    const DOWNLOAD_PHOTO_HEIGHT = 666.666;
    // Photo centered in template: (1080-1000)/2 = 40px left, (1920-666.666)/2 = 626.667px top
    const DOWNLOAD_PHOTO_X = 40;
    const DOWNLOAD_PHOTO_Y = 626.667;

    // Reusable offscreen canvas for framed downloads
    const downloadCanvas = document.createElement("canvas");
    const downloadCtx = downloadCanvas.getContext("2d");

    // Preloaded frame image promise (to reduce errors)
    let frameImageCache = null;
    let frameImagePromise = null;

    function preloadFrameImage() {
      if (frameImagePromise) return frameImagePromise;
      frameImagePromise = new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          frameImageCache = img;
          resolve(img);
        };
        img.onerror = () => reject(new Error("Error loading frame PNG"));
        img.src = FRAME_IMAGE_URL;
      });
      return frameImagePromise;
    }

    // Preload vertical download template
    let downloadTemplateCache = null;
    let downloadTemplatePromise = null;

    function preloadDownloadTemplate() {
      if (downloadTemplatePromise) return downloadTemplatePromise;
      downloadTemplatePromise = new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          downloadTemplateCache = img;
          resolve(img);
        };
        img.onerror = () => reject(new Error("Error loading download template PNG"));
        img.src = DOWNLOAD_TEMPLATE_URL;
      });
      return downloadTemplatePromise;
    }
let globalLottie = null;

function ensureGlobalLottie() {
  if (!globalLottie) {
    globalLottie = lottie.loadAnimation({
      container: document.getElementById("globalLottie"),
      renderer: "svg",
      loop: true,
      autoplay: false,
      path: "Assets/Material wave loading.json",
    });
  }
}

function showGlobalLoader() {
  ensureGlobalLottie();
  const el = document.getElementById("globalLoader");
  el.style.display = "flex";
  globalLottie.goToAndPlay(0);
}

function hideGlobalLoader() {
  const el = document.getElementById("globalLoader");
  el.style.display = "none";
  if (globalLottie) globalLottie.stop();
}
    // Will store the admin session token returned by /admin/auth
    let adminToken = null;

    // Lock / auth elements
    const lockScreen = document.getElementById("lockScreen");
    const lockCard = document.getElementById("lockCard");
    const lockTitle = document.getElementById("lockTitle");
    const accessCodeInput = document.getElementById("accessCode");
    const accessSubmitBtn = document.getElementById("accessSubmit");
    const accessError = document.getElementById("accessError");

    // Admin UI elements
    const photoFrame = document.getElementById("photoFrame");
    const photoImg = document.getElementById("photoImg");
    const emptyText = document.getElementById("emptyText");
    const statusPill = document.getElementById("statusPill");
    const approveBtn = document.getElementById("approveBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    // DARK MODE TOGGLE (Moon/Sun Icon Button)
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const moonIcon = themeToggleBtn?.querySelector(".icon-moon");
    const sunIcon = themeToggleBtn?.querySelector(".icon-sun");
    
    // Initialize theme from localStorage or default to dark
    const savedTheme = localStorage.getItem("adminTheme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    updateThemeIcons(savedTheme);
    
    function updateThemeIcons(theme) {
      if (!moonIcon || !sunIcon) return;
      // Show moon icon in dark mode, sun icon in light mode
      if (theme === "dark") {
        moonIcon.style.display = "block";
        sunIcon.style.display = "none";
      } else {
        moonIcon.style.display = "none";
        sunIcon.style.display = "block";
      }
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute("data-theme") || "dark";
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("adminTheme", newTheme);
      updateThemeIcons(newTheme);
    }
    
    if (themeToggleBtn) {
      themeToggleBtn.addEventListener("click", toggleTheme);
    }

    const appToggleInput = document.getElementById("appToggle");
    const appToggleWrapper = document.getElementById("appToggleWrapper");
    const appStatusDot = document.getElementById("appStatusDot");

    // NEW: photo meta elements
    const photoLabel = document.getElementById("photoLabel");
    const pendingCountEl = document.getElementById("pendingCount");
    const eventLogList = document.getElementById("eventLogList");
    const activityBars = document.getElementById("activityBars");
    const activityChart = document.getElementById("activityChart");
    const activityXAxis = document.getElementById("activityXAxis");
    const activityYAxis = document.getElementById("activityYAxis");
    // Pending counter state (frontend)
    let pendingCountState = 0;
    // Delta we expect after our own actions (approve/reject)
    let pendingCountDelta = 0;

    function updatePendingDisplay() {
      if (!pendingCountEl) return;
      pendingCountEl.textContent = `AWAITING APPROVAL: ${pendingCountState}`;
    }

    // Use backend count, but adjust if we know we just removed some items
    function applyPendingFromServer(rawPendingCount, isEmptyFlag) {
      if (!pendingCountEl) return;

      let serverCount = null;
      if (typeof rawPendingCount === "number") {
        serverCount = rawPendingCount;
      } else if (isEmptyFlag) {
        serverCount = 0;
      }

      // If backend didn't send anything, don't touch the current display
      if (serverCount === null) return;

      // If backend returns the SAME number we had before, but we know we just
      // approved/rejected items (pendingCountDelta != 0), adjust it by that delta.
      if (pendingCountDelta !== 0 && pendingCountState === serverCount) {
        pendingCountState = Math.max(0, serverCount + pendingCountDelta);
        pendingCountDelta = 0;
      } else {
        // Normal case: trust the backend
        pendingCountState = serverCount;
        pendingCountDelta = 0;
      }

      updatePendingDisplay();
    }
        // --- EVENT LOGS (right sidebar) ---

    function renderEventLogs(events) {
      if (!eventLogList) return;

      eventLogList.innerHTML = "";

      if (!events || !events.length) {
        const li = document.createElement("li");
        li.className = "event-log-item";

        const timeSpan = document.createElement("span");
        timeSpan.className = "event-log-time";
        timeSpan.textContent = "--:--";

        const textSpan = document.createElement("span");
        textSpan.className = "event-log-text";
        textSpan.textContent = "No recent events.";

        li.appendChild(timeSpan);
        li.appendChild(textSpan);
        eventLogList.appendChild(li);
        return;
      }

      events.forEach((evt) => {
        const li = document.createElement("li");
        li.className = "event-log-item";

        const timeSpan = document.createElement("span");
        timeSpan.className = "event-log-time";
        timeSpan.textContent = evt.time || "--:--";

        const textSpan = document.createElement("span");
        textSpan.className = "event-log-text";
        textSpan.textContent = evt.text || "";

        li.appendChild(timeSpan);
        li.appendChild(textSpan);
        eventLogList.appendChild(li);
      });
    }

    async function fetchEventLogs() {
      if (!adminToken) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/event-logs?limit=12`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          // auth will be handled by other flows; don't spam the lock
          return;
        }

        const data = await res.json();
        if (data && Array.isArray(data.events)) {
          renderEventLogs(data.events);
        }
      } catch (err) {
        console.error("Error fetching event logs", err);
      }
    }

    function formatHourLabel(hour) {
      const normalized = ((hour % 24) + 24) % 24;
      const period = normalized >= 12 ? "PM" : "AM";
      const hour12 = normalized % 12 || 12;
      return `${hour12}${period}`;
    }
    function getYAxisStep(maxCount) {
      if (maxCount <= 10) return 1;
      if (maxCount <= 100) return 10;
      if (maxCount <= 500) return 50;
      const rough = Math.ceil(maxCount / 9 / 50) * 50;
      return rough || 50;
    }

    function renderActivityBars(counts, currentHour) {
      if (!activityBars || !activityChart || !activityXAxis || !activityYAxis) return;
      if (!Array.isArray(counts) || counts.length !== 24) return;

      const displayHours = 6;
      const hours = [];
      for (let offset = displayHours - 1; offset >= 0; offset -= 1) {
        hours.push((currentHour - offset + 24) % 24);
      }
      const displayCounts = hours.map((hour) => counts[hour] || 0);

      const maxCount = Math.max(...displayCounts, 0);
      const step = getYAxisStep(maxCount);
      const maxTick = step * 9;
      const svgWidth = 300;
      const svgHeight = 140;
      const paddingTop = 8;
      const paddingBottom = 8;
      const paddingLeft = 8;
      const paddingRight = 8;
      const usableHeight = svgHeight - paddingTop - paddingBottom;
      const usableWidth = svgWidth - paddingLeft - paddingRight;

      activityYAxis.innerHTML = "";
      for (let i = 9; i >= 0; i -= 1) {
        const label = document.createElement("span");
        label.textContent = `${i * step}`;
        activityYAxis.appendChild(label);
      }

      activityXAxis.innerHTML = "";
      activityXAxis.style.gridTemplateColumns = `repeat(${hours.length}, minmax(0, 1fr))`;
      hours.forEach((hour) => {
        const label = document.createElement("span");
        label.textContent = formatHourLabel(hour);
        activityXAxis.appendChild(label);
      });

      const points = displayCounts.map((count, index) => {
        const denominator = displayCounts.length - 1 || 1;
        const x = paddingLeft + (usableWidth * index) / denominator;
        const ratio = maxTick ? Math.min(count / maxTick, 1) : 0;
        const y = paddingTop + usableHeight - ratio * usableHeight;
        return { x, y, count };
      });

      const linePoints = points.map((pt) => `${pt.x},${pt.y}`).join(" ");
      const fillPoints = `${paddingLeft},${paddingTop + usableHeight} ${linePoints} ${paddingLeft + usableWidth},${paddingTop + usableHeight}`;

      const currentX = paddingLeft + usableWidth;

      activityChart.innerHTML = `
        <line class="activity-grid-line" x1="${paddingLeft}" x2="${paddingLeft + usableWidth}" y1="${paddingTop + usableHeight}" y2="${paddingTop + usableHeight}" />
        ${Array.from({ length: 9 }, (_, i) => {
          const y = paddingTop + usableHeight - ((i + 1) / 9) * usableHeight;
          return `<line class="activity-grid-line" x1="${paddingLeft}" x2="${paddingLeft + usableWidth}" y1="${y}" y2="${y}" />`;
        }).join("")}
        <polygon class="activity-line-fill" points="${fillPoints}" />
        <polyline class="activity-line" points="${linePoints}" />
        ${points.map((pt) => `<circle class="activity-point" cx="${pt.x}" cy="${pt.y}" r="2" />`).join("")}
        <line class="activity-grid-line" x1="${currentX}" x2="${currentX}" y1="${paddingTop}" y2="${paddingTop + usableHeight}" />
      `;
    }

    async function fetchActivityStats() {
      if (!adminToken) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/activity-stats`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          return;
        }

        const data = await res.json();
        if (data && Array.isArray(data.counts)) {
          const currentHour = Number.isInteger(data.currentHour)
            ? data.currentHour
            : new Date().getHours();
          renderActivityBars(data.counts, currentHour);
        }
      } catch (err) {
        console.error("Error fetching activity stats", err);
      }
    }
    // LEFT NAV
    const navDashboard = document.getElementById("navDashboard");
    const navApproved = document.getElementById("navApproved");
    const navReports = document.getElementById("navReports");
    const navSettings = document.getElementById("navSettings");
    const navResetLogs = document.getElementById("navResetLogs");
    const lockAdminBtn = document.getElementById("lockAdminBtn");

    // Menu + approved overlay
    const moreButton = document.getElementById("moreButton");
    const moreMenu = document.getElementById("moreMenu");
    const approvedButton = document.getElementById("approvedButton");
    const menuViewApproved = document.getElementById("menuViewApproved");
    const menuGenerateReport = document.getElementById("menuGenerateReport");
    const menuGenerateReportYesterday = document.getElementById("menuGenerateReportYesterday");
    const menuResetLogs = document.getElementById("menuResetLogs");
    const menuClearApproved = document.getElementById("menuClearApproved");

    const approvedOverlay = document.getElementById("approvedOverlay");
    const approvedGrid = document.getElementById("approvedGrid");
    const approvedEmpty = document.getElementById("approvedEmpty");
    const approvedFooterText = document.getElementById("approvedFooterText");
    const approvedPrevBtn = document.getElementById("approvedPrevBtn");
    const approvedNextBtn = document.getElementById("approvedNextBtn");

    // Viewer overlay elements
    const approvedViewer = document.getElementById("approvedViewer");
    const approvedViewerImg = document.getElementById("approvedViewerImg");
    const viewerDownloadBtn = document.getElementById("viewerDownloadBtn");
    const viewerDeleteBtn = document.getElementById("viewerDeleteBtn");
    const viewerCloseBtn = document.getElementById("viewerCloseBtn");
    const viewerPrevBtn = document.getElementById("viewerPrevBtn");
    const viewerNextBtn = document.getElementById("viewerNextBtn");

    // REPORT MODAL ELEMENTS
    const reportOverlay = document.getElementById("reportOverlay");
    const reportCloseBtn = document.getElementById("reportCloseBtn");
    const reportViewBtn = document.getElementById("reportViewBtn");
    const reportGenerateBtn = document.getElementById("reportGenerateBtn");
    const reportPreview = document.getElementById("reportPreview");
    const reportLoading = document.getElementById("reportLoading");

    // SETTINGS MODAL ELEMENTS
    const settingsOverlay = document.getElementById("settingsOverlay");
    const settingsCloseBtn = document.getElementById("settingsCloseBtn");
    const settingsSaveBtn = document.getElementById("settingsSaveBtn");
    const settingsStatus = document.getElementById("settingsStatus");
    const settingsTicketEnabled = document.getElementById("settingsTicketEnabled");
    const settingsGalleryDisplayLimit = document.getElementById("settingsGalleryDisplayLimit");
    const settingsIntroTitle = document.getElementById("settingsIntroTitle");
    const settingsIntroSubtitle = document.getElementById("settingsIntroSubtitle");
    const settingsLocationEnabled = document.getElementById("settingsLocationEnabled");
    const settingsLastNameEnabled = document.getElementById("settingsLastNameEnabled");
    const settingsLastNameLabel = document.getElementById("settingsLastNameLabel");
    const settingsLastNamePlaceholder = document.getElementById("settingsLastNamePlaceholder");
    const settingsEmailEnabled = document.getElementById("settingsEmailEnabled");
    const settingsEmailLabel = document.getElementById("settingsEmailLabel");
    const settingsEmailPlaceholder = document.getElementById("settingsEmailPlaceholder");
    const settingsNewsletterEnabled = document.getElementById("settingsNewsletterEnabled");
    const settingsNewsletterLabel = document.getElementById("settingsNewsletterLabel");
    const settingsNewsletterHelper = document.getElementById("settingsNewsletterHelper");

// Lottie loader for the report modal
let reportLottie = null;

function ensureReportLottie() {
  if (reportLottie || !window.lottie || !reportLoading) return;
  reportLottie = lottie.loadAnimation({
    container: reportLoading,
    renderer: "svg",
    loop: true,
    autoplay: false,
    path: "Assets/Material wave loading.json", // 🔥 your file
  });
}

function showReportLoading() {
  ensureReportLottie();
  if (reportLoading) {
    reportLoading.style.display = "flex";
  }
  if (reportLottie) {
    reportLottie.play();
  }
  // lock buttons while we load
  if (reportViewBtn) reportViewBtn.disabled = true;
  if (reportGenerateBtn) reportGenerateBtn.disabled = true;
  if (reportPreview) reportPreview.textContent = "";
}

function hideReportLoading() {
  if (reportLottie) {
    reportLottie.stop();
  }
  if (reportLoading) {
    reportLoading.style.display = "none";
  }
  if (reportViewBtn) reportViewBtn.disabled = false;
  if (reportGenerateBtn) reportGenerateBtn.disabled = false;
}

    let currentFileId = null;
    let isBusy = false;
    let autoRefreshId = null;
    let inactivityTimer = null;

    // Currently viewed approved file in zoom viewer
    let viewerCurrentFileId = null;
    let viewerCurrentImgUrl = null;
    let viewerCurrentIndex = -1;

    // App/server status
    let appServerEnabled = true;

    // Approved gallery paging
    let approvedFilesCache = [];
    let approvedPageIndex = 0;
    const APPROVED_PAGE_SIZE = 24;

    // --- Toggle UI (frontend) ---
    function updateStatusPill() {
      if (appServerEnabled) {
        statusPill.textContent = "SERVER STATUS: READY";
        statusPill.classList.remove("offline");
      } else {
        statusPill.textContent = "SERVER STATUS: OFFLINE";
        statusPill.classList.add("offline");
      }
    }

    function updateAppToggleUI(enabled) {
      appServerEnabled = enabled;
      if (enabled) {
        appToggleWrapper.classList.add("is-on");
        appToggleWrapper.classList.remove("disabled");
        appStatusDot.classList.add("on");
        appStatusDot.classList.remove("off");
      } else {
        appToggleWrapper.classList.remove("is-on");
        appStatusDot.classList.remove("on");
        appStatusDot.classList.add("off");
      }
      updateStatusPill();
    }

    function disableAdminControlsForOffline() {
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      statusPill.textContent = "SERVER STATUS: OFFLINE";
      statusPill.classList.add("offline");
      stopAutoRefresh();
    }

    // Load server app status from backend
    async function fetchAppStatus() {
      if (!adminToken) return;
      try {
        const res = await fetch(`${BASE_URL}/admin/app-status`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Enter the access code to continue.");
          return;
        }

        const data = await res.json();
        if (data && typeof data.enabled === "boolean") {
          updateAppToggleUI(data.enabled);
          appToggleInput.checked = data.enabled;
          if (!data.enabled) {
            disableAdminControlsForOffline();
          }
        } else {
          updateAppToggleUI(true);
          appToggleInput.checked = true;
        }
      } catch (err) {
        console.error("Error fetching app status", err);
        updateAppToggleUI(true);
        appToggleInput.checked = true;
      }
    }

    // --- Inactivity handling ---
    function clearAdminToken() {
      adminToken = null;
      localStorage.removeItem(ADMIN_TOKEN_KEY);
    }

    function resetInactivityTimer() {
      if (!adminToken) return;
      if (inactivityTimer) clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        clearAdminToken();
        showLock("Session closed due to inactivity.");
      }, INACTIVITY_MS);
    }

    ["click", "keydown", "mousemove", "touchstart"].forEach((evt) => {
      window.addEventListener(evt, resetInactivityTimer, { passive: true });
    });

    // --- Lock helpers ---
    function shakeLockCard() {
      lockCard.classList.remove("shake");
      void lockCard.offsetWidth; // force reflow
      lockCard.classList.add("shake");
    }

    function showLock(message) {
      if (message) {
        accessError.textContent = message;
      } else {
        accessError.textContent = "";
      }

      lockTitle.textContent = "Restricted access";
      lockTitle.style.color = "#f97373";
      lockCard.classList.remove("success");

      lockScreen.style.display = "flex";
      stopAutoRefresh();
      currentFileId = null;
      clearAdminToken();
      approveBtn.disabled = true;
      rejectBtn.disabled = true;
      accessCodeInput.value = "";
    }

    function hideLock() {
      accessError.textContent = "";
      lockScreen.style.display = "none";
      resetInactivityTimer();
    }

    // Helper: headers with admin token when available
    function withAdminHeaders(extra = {}) {
      const headers = { ...extra };
      if (adminToken) {
        headers["x-admin-token"] = adminToken;
      }
      return headers;
    }

    async function attemptLogin() {
      const code = accessCodeInput.value.trim();
      if (!code) {
        accessError.textContent = "Enter the access code.";
        shakeLockCard();
        return;
      }

      accessSubmitBtn.disabled = true;
      accessError.textContent = "";

      try {
        const res = await fetch(`${BASE_URL}/admin/auth`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
        });

        let data = {};
        try {
          data = await res.json();
        } catch (_) {}

        if (res.ok && data.ok && data.token) {
          adminToken = data.token;
          localStorage.setItem(ADMIN_TOKEN_KEY, adminToken);

          lockTitle.textContent = "Access granted";
          lockTitle.style.color = "#22c55e";
          lockCard.classList.add("success");
          accessCodeInput.value = "";

          setTimeout(async () => {
            hideLock();
            lockTitle.textContent = "Restricted access";
            lockTitle.style.color = "#f97373";
            lockCard.classList.remove("success");

            await fetchAppStatus();
            await loadNextPhoto();
            await fetchEventLogs();
            await fetchActivityStats();
            startAutoRefresh();
          }, 850);
        } else if (res.status === 401 && data.remainingAttempts != null) {
          accessError.textContent = `Incorrect code. Remaining attempts: ${data.remainingAttempts}.`;
          accessCodeInput.value = "";
          accessCodeInput.focus();
          shakeLockCard();
        } else if (res.status === 403 && data.error === "blocked") {
          const minutes = Math.ceil(data.blockedMinutes || 30);
          accessError.textContent = `Access blocked for ${minutes} minutes. Contact the administrator.`;
          accessCodeInput.value = "";
          shakeLockCard();
        } else if (data.error === "admin_code_not_configured") {
          accessError.textContent = "Access code is not configured on the server.";
          accessCodeInput.value = "";
          shakeLockCard();
        } else {
          accessError.textContent = "Authentication error. Please try again.";
          accessCodeInput.value = "";
          shakeLockCard();
        }
      } catch (err) {
        console.error(err);
        accessError.textContent = "Network error. Please try again.";
        shakeLockCard();
      } finally {
        accessSubmitBtn.disabled = false;
      }
    }

    accessSubmitBtn.addEventListener("click", attemptLogin);
    accessCodeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") attemptLogin();
    });

    // --- Busy + admin logic ---
    function setBusy(busy) {
      isBusy = busy;
      approveBtn.disabled = busy || !currentFileId || !appServerEnabled;
      rejectBtn.disabled = busy || !currentFileId || !appServerEnabled;
      if (busy) {
        statusPill.textContent = "PROCESSING…";
      } else {
        updateStatusPill();
      }
    }

    async function loadNextPhoto() {
        if (!appServerEnabled) {
        disableAdminControlsForOffline();
        photoImg.style.display = "none";
        emptyText.style.display = "block";
        emptyText.textContent = "Server is offline for this event.";
        photoFrame.classList.add("empty");
        if (pendingCountEl) {
          pendingCountState = 0;
          pendingCountDelta = 0;
          updatePendingDisplay();
        }
        if (photoLabel) photoLabel.textContent = "PHOTO";
        return;
      }

      setBusy(true);
      photoImg.style.display = "none";
      emptyText.style.display = "block";
      emptyText.textContent = "Loading next pending photo…";
      photoFrame.classList.add("empty");

      try {
        const res = await fetch(`${BASE_URL}/admin/next-photo`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Enter the access code to continue.");
          return;
        }

        const data = await res.json();

        // NEW: handle pending counter & photo number using helper
        applyPendingFromServer(data.pendingCount, data.empty);

        if (photoLabel) {
          if (data.photoNumber != null) {
            photoLabel.textContent = `PHOTO #${data.photoNumber}`;
          } else if (data.fileId) {
            photoLabel.textContent = "PHOTO";
          } else {
            photoLabel.textContent = "PHOTO";
          }
        }

        if (data.empty) {
          currentFileId = null;
          emptyText.textContent = "There are no pending photos at this moment.";
          statusPill.textContent = appServerEnabled
            ? "SERVER STATUS: READY · NO PENDING"
            : "SERVER STATUS: OFFLINE";
          approveBtn.disabled = true;
          rejectBtn.disabled = true;
          return;
        }

        currentFileId = data.fileId;

        const imgUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
          currentFileId
        )}?token=${encodeURIComponent(adminToken || "")}`;

        photoImg.src = imgUrl;
        photoImg.onload = () => {
          photoFrame.classList.remove("empty");
          emptyText.style.display = "none";
          photoImg.style.display = "block";
        };

        statusPill.textContent = "SERVER STATUS: READY";
        approveBtn.disabled = false;
        rejectBtn.disabled = false;
      } catch (err) {
        console.error(err);
        emptyText.textContent = "Error loading photo. Reload the page.";
        statusPill.textContent = "ERROR";
        approveBtn.disabled = true;
        rejectBtn.disabled = true;
      } finally {
        setBusy(false);
      }
    }

    async function sendAction(endpoint) {
      if (!currentFileId || isBusy) return;
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      if (!appServerEnabled) {
        alert("Server is offline for this event.");
        return;
      }

      setBusy(true);

      try {
        const res = await fetch(`${BASE_URL}${endpoint}`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ fileId: currentFileId }),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          console.error("Action failed", res.status);
          statusPill.textContent = "ERROR";
          return;
        }

        // If the action actually succeeded, we know ONE item left the pending queue.
        if (endpoint === "/admin/approve" || endpoint === "/admin/reject") {
          pendingCountDelta -= 1; // accumulate in case of multiple quick actions
          if (pendingCountEl) {
            const previewCount = Math.max(0, pendingCountState + pendingCountDelta);
            pendingCountEl.textContent = `AWAITING APPROVAL: ${previewCount}`;
          }
        }
      } catch (err) {
        console.error(err);
        statusPill.textContent = "ERROR";
      } finally {
        await loadNextPhoto();
      }
    }

    approveBtn.addEventListener("click", () =>
      sendAction("/admin/approve")
    );
    rejectBtn.addEventListener("click", () =>
      sendAction("/admin/reject")
    );

    // --- Swipe logic ---
    let startX = null;

    function onStart(e) {
      const touch = e.touches ? e.touches[0] : e;
      startX = touch.clientX;
    }

    function onEnd(e) {
      if (startX == null || !currentFileId || isBusy) return;
      const touch = e.changedTouches ? e.changedTouches[0] : e;
      const dx = touch.clientX - startX;

      const threshold = 50;
      if (dx > threshold) {
        sendAction("/admin/approve");
      } else if (dx < -threshold) {
        sendAction("/admin/reject");
      }
      startX = null;
    }

    photoFrame.addEventListener("mousedown", onStart);
    photoFrame.addEventListener("mouseup", onEnd);
    photoFrame.addEventListener("touchstart", onStart);
    photoFrame.addEventListener("touchend", onEnd);

    // --- Auto-refresh / live updates ---
    async function checkForUpdates() {
      if (isBusy) return;
      if (!adminToken) return;
      if (!appServerEnabled) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/next-photo`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        const data = await res.json();

        // update counters if present (respecting our local delta)
        applyPendingFromServer(data.pendingCount, data.empty);
        
        if (photoLabel && data.photoNumber != null && !data.empty) {
          photoLabel.textContent = `PHOTO #${data.photoNumber}`;
        }

        if (data.empty) {
          if (currentFileId !== null) {
            await loadNextPhoto();
          }
          return;
        }

                if (currentFileId === null || data.fileId !== currentFileId) {
          await loadNextPhoto();
        }

        // also refresh event logs on the same cadence
        await fetchEventLogs();
        await fetchActivityStats();
      } catch (err) {
        console.error("Auto-refresh error", err);
      }
    }

    function startAutoRefresh() {
      if (autoRefreshId) return;
      autoRefreshId = setInterval(checkForUpdates, 10000);
    }

    function stopAutoRefresh() {
      if (!autoRefreshId) return;
      clearInterval(autoRefreshId);
      autoRefreshId = null;
    }

    // --- MENU LOGIC (kept mostly for compatibility) ---
    function closeMoreMenu() {
      moreMenu.style.display = "none";
    }

    function toggleMoreMenu() {
      if (moreMenu.style.display === "block") {
        closeMoreMenu();
      } else {
        moreMenu.style.display = "block";
      }
    }

    moreButton.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMoreMenu();
    });

    approvedButton.addEventListener("click", (e) => {
      e.stopPropagation();
      openApprovedOverlay();
    });

    document.addEventListener("click", (e) => {
      if (!moreMenu.contains(e.target) && e.target !== moreButton) {
        closeMoreMenu();
      }
    });

    // --- APPROVED GRID FUNCTIONS ---
    function openApprovedOverlay() {
      closeMoreMenu();
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      approvedOverlay.style.display = "flex";
      loadApprovedGrid();
    }

    function closeApprovedOverlay() {
      approvedOverlay.style.display = "none";
    }

    document.querySelectorAll("[data-close-approved]").forEach((btn) => {
      btn.addEventListener("click", closeApprovedOverlay);
    });

    function updateViewerNavButtons() {
      const total = approvedFilesCache.length;
      if (viewerCurrentIndex < 0 || total === 0) {
        viewerPrevBtn.disabled = true;
        viewerNextBtn.disabled = true;
        return;
      }
      viewerPrevBtn.disabled = viewerCurrentIndex <= 0;
      viewerNextBtn.disabled = viewerCurrentIndex >= total - 1;
    }

    function openApprovedViewer(fileId, imgUrl) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      viewerCurrentFileId = fileId;
      viewerCurrentImgUrl = imgUrl;
      approvedViewerImg.src = imgUrl;
      approvedViewer.style.display = "flex";

      viewerCurrentIndex = approvedFilesCache.findIndex(
        (item) => String(item.fileId) === String(fileId)
      );
      updateViewerNavButtons();
    }

    function closeApprovedViewer() {
      viewerCurrentFileId = null;
      viewerCurrentImgUrl = null;
      viewerCurrentIndex = -1;
      approvedViewer.style.display = "none";
    }

    approvedViewer.addEventListener("click", (e) => {
      if (e.target === approvedViewer) {
        closeApprovedViewer();
      }
    });

    viewerCloseBtn.addEventListener("click", closeApprovedViewer);

    function findThumbByFileId(fileId) {
      const thumbs = approvedGrid.querySelectorAll(".approved-thumb");
      for (const el of thumbs) {
        if (el.dataset.id === String(fileId)) return el;
      }
      return null;
    }

    function buildApprovedThumb(fileId, imgUrl) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "approved-thumb";
      btn.dataset.id = fileId;

      const img = document.createElement("img");
      img.src = imgUrl;
      img.alt = "Approved photo";

      const actions = document.createElement("div");
      actions.className = "approved-thumb-actions";

      const dlBtn = document.createElement("button");
      dlBtn.type = "button";
      dlBtn.className = "thumb-action-btn";
      dlBtn.innerHTML = '<span class="icon">⬇</span><span>DL</span>';

      dlBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        downloadApprovedWithFrame(fileId);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "thumb-action-btn danger";
      delBtn.innerHTML = '<span class="icon">🗑</span><span>Del</span>';

      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        confirmDeleteApproved(fileId, btn);
      });

      actions.appendChild(dlBtn);
      actions.appendChild(delBtn);

      btn.appendChild(img);
      btn.appendChild(actions);

      btn.addEventListener("click", () => {
        // Get filename from cache to extract ticket number
        const item = approvedFilesCache.find(f => f.fileId === fileId);
        const fileName = item?.fileName || fileId;
        openPhotoInfoOverlay(fileId, fileName);
      });

      return btn;
    }

    function renderApprovedPage() {
      approvedGrid.innerHTML = "";

      const total = approvedFilesCache.length;
      if (!total) {
        approvedEmpty.style.display = "block";
        approvedEmpty.textContent = "There are no approved photos at this moment.";
        approvedFooterText.textContent = "0 photos";
        approvedPrevBtn.disabled = true;
        approvedNextBtn.disabled = true;
        return;
      }

      approvedEmpty.style.display = "none";

      const start = approvedPageIndex * APPROVED_PAGE_SIZE;
      const end = Math.min(start + APPROVED_PAGE_SIZE, total);
      const slice = approvedFilesCache.slice(start, end);

      slice.forEach((item) => {
        const { fileId, imgUrl } = item;
        if (!imgUrl) return;
        const thumb = buildApprovedThumb(fileId, imgUrl);
        approvedGrid.appendChild(thumb);
      });

      approvedFooterText.textContent = `Showing ${start + 1}–${end} of ${total} photos`;
      approvedPrevBtn.disabled = approvedPageIndex === 0;
      approvedNextBtn.disabled = end >= total;
    }

    approvedPrevBtn.addEventListener("click", () => {
      if (approvedPageIndex === 0) return;
      approvedPageIndex -= 1;
      renderApprovedPage();
    });

    approvedNextBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(approvedFilesCache.length / APPROVED_PAGE_SIZE);
      if (approvedPageIndex >= totalPages - 1) return;
      approvedPageIndex += 1;
      renderApprovedPage();
    });

    async function loadApprovedGrid() {
      approvedGrid.innerHTML = "";
      approvedEmpty.style.display = "block";
      approvedEmpty.textContent = "Loading approved photos…";

      if (!adminToken) {
        approvedEmpty.textContent = "Session expired. Log in again.";
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}/admin/approved-list`, {
          headers: withAdminHeaders(),
        });

        if (res.status === 401 || res.status === 403) {
          approvedEmpty.textContent = "Session expired. Log in again.";
          showLock("Session expired. Enter the access code.");
          return;
        }

        const data = await res.json();
        const files = data.files || [];

        if (!files.length) {
          approvedFilesCache = [];
          approvedEmpty.textContent = "There are no approved photos at this moment.";
          approvedFooterText.textContent = "0 photos";
          return;
        }

        approvedFilesCache = [];

        files.forEach((f) => {
          let fileId = null;
          let imgUrl = "";
          let fileName = "";

          if (typeof f === "string") {
            if (f.startsWith("http://") || f.startsWith("https://")) {
              imgUrl = f;
              fileId = f;
            } else {
              fileId = f;
            }
          } else if (f && typeof f === "object") {
            fileId = f.id || f.fileId || f.name || null;
            fileName = f.name || f.fileName || "";
            imgUrl =
              f.url ||
              f.thumbnailUrl ||
              f.thumbnailLink ||
              f.webViewLink ||
              "";
          }

          if (!imgUrl && fileId) {
            imgUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
              fileId
            )}?token=${encodeURIComponent(adminToken || "")}`;
          }

          if (!imgUrl) return;
          if (!fileId) fileId = imgUrl;
          if (!fileName) fileName = fileId;

          approvedFilesCache.push({ fileId, imgUrl, fileName });
        });

        approvedPageIndex = 0;
        renderApprovedPage();
      } catch (err) {
        console.error("Error loading approved list", err);
        approvedEmpty.style.display = "block";
        approvedEmpty.textContent =
          "Error loading approved photos. Please try again.";
      }
    }

    function confirmDeleteApproved(fileId, thumbEl) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }
      const ok = window.confirm(
        "Are you sure you want to remove this approved photo from the gallery?\n\nThis action cannot be undone."
      );
      if (!ok) return;
      deleteApprovedPhoto(fileId, thumbEl);
    }

    async function deleteApprovedPhoto(fileId, thumbEl) {
      if (!fileId) return;
      if (thumbEl) thumbEl.classList.add("busy");

      try {
        const res = await fetch(`${BASE_URL}/admin/delete-approved`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ fileId }),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        approvedFilesCache = approvedFilesCache.filter(
          (item) => item.fileId !== fileId
        );

        renderApprovedPage();
      } catch (err) {
        console.error("Error deleting approved photo", err);
        if (thumbEl) thumbEl.classList.remove("busy");
        alert("Could not delete the approved photo. Please try again.");
      }
    }

    async function clearApprovedFolder() {
      closeMoreMenu();
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const ok = window.confirm(
        "Clear ALL photos from Pending + Approved?\n\n" +
          "This will permanently delete all images from both folders."
      );
      if (!ok) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/clear-drive`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({}),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        if (approvedOverlay.style.display === "flex") {
          approvedFilesCache = [];
          approvedGrid.innerHTML = "";
          approvedEmpty.style.display = "block";
          approvedEmpty.textContent = "There are no approved photos at this moment.";
          approvedFooterText.textContent = "0 photos";
        }

        alert("Pending + approved folders cleared.");
      } catch (err) {
        console.error("Error clearing approved folder", err);
        alert("Could not clear the folder. Please try again.");
      }
    }

    async function resetLogs() {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const ok = window.confirm(
        "Clear all event logs?\n\nThis keeps the header row but erases all event entries."
      );
      if (!ok) return;

      try {
        const res = await fetch(`${BASE_URL}/admin/reset-logs`, {
          method: "POST",
          headers: withAdminHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({}),
        });

        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        if (eventLogList) {
          eventLogList.innerHTML = "";
        }
        renderActivityBars(new Array(24).fill(0), new Date().getHours());

        alert("Event logs cleared.");
      } catch (err) {
        console.error("Error clearing logs", err);
        alert("Could not clear the logs. Please try again.");
      }
    }

    async function downloadApprovedWithFrame(fileId) {
      if (!fileId) return;
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      const photoUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
        fileId
      )}?token=${encodeURIComponent(adminToken || "")}`;

      try {
        const photoImgEl = new Image();
        photoImgEl.crossOrigin = "anonymous";

        const downloadTemplateImg = await preloadDownloadTemplate();

        const photoPromise = new Promise((resolve, reject) => {
          photoImgEl.onload = resolve;
          photoImgEl.onerror = () => reject(new Error("Error loading photo"));
        });

        photoImgEl.src = photoUrl;

        await Promise.all([photoPromise]);

        // Set canvas to download template size (1080x1920)
        downloadCanvas.width = DOWNLOAD_TEMPLATE_WIDTH;
        downloadCanvas.height = DOWNLOAD_TEMPLATE_HEIGHT;
        downloadCtx.clearRect(0, 0, DOWNLOAD_TEMPLATE_WIDTH, DOWNLOAD_TEMPLATE_HEIGHT);

        const pw = photoImgEl.width;
        const ph = photoImgEl.height;

        if (!pw || !ph) {
          alert("Photo dimensions are invalid.");
          return;
        }

        // Calculate how to fit the photo into 1000x666.666px area
        const targetWidth = DOWNLOAD_PHOTO_WIDTH;
        const targetHeight = DOWNLOAD_PHOTO_HEIGHT;
        const photoAspect = pw / ph;
        const targetAspect = targetWidth / targetHeight;

        let sx, sy, sWidth, sHeight;

        if (photoAspect > targetAspect) {
          // Photo is wider - fit to height
          sHeight = ph;
          sWidth = sHeight * targetAspect;
          sx = (pw - sWidth) / 2;
          sy = 0;
        } else {
          // Photo is taller - fit to width
          sWidth = pw;
          sHeight = sWidth / targetAspect;
          sx = 0;
          sy = (ph - sHeight) / 2;
        }

        // Draw photo centered in the template (1000x666.666px area)
        downloadCtx.drawImage(
          photoImgEl,
          sx,
          sy,
          sWidth,
          sHeight,
          DOWNLOAD_PHOTO_X,
          DOWNLOAD_PHOTO_Y,
          targetWidth,
          targetHeight
        );

        // Draw template on top
        if (downloadTemplateImg) {
          downloadCtx.drawImage(
            downloadTemplateImg,
            0,
            0,
            DOWNLOAD_TEMPLATE_WIDTH,
            DOWNLOAD_TEMPLATE_HEIGHT
          );
        }

        function triggerDownloadFromBlob(blob) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `mayaguez_selfie_${fileId}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        if (typeof downloadCanvas.toBlob === "function") {
          downloadCanvas.toBlob(async (blob) => {
            if (blob) {
              triggerDownloadFromBlob(blob);
            } else {
              const dataUrl = downloadCanvas.toDataURL("image/png");
              const resp = await fetch(dataUrl);
              const fallbackBlob = await resp.blob();
              triggerDownloadFromBlob(fallbackBlob);
            }
          }, "image/png");
        } else {
          const dataUrl = downloadCanvas.toDataURL("image/png");
          const resp = await fetch(dataUrl);
          const blob = await resp.blob();
          triggerDownloadFromBlob(blob);
        }
      } catch (err) {
        console.error("Error generating download with template:", err);
        alert("Could not create the download image. Please try again.");
      }
    }

    viewerDownloadBtn.addEventListener("click", () => {
      if (!viewerCurrentFileId) return;
      downloadApprovedWithFrame(viewerCurrentFileId);
    });

    viewerDeleteBtn.addEventListener("click", () => {
      if (!viewerCurrentFileId) return;
      const thumbEl = findThumbByFileId(viewerCurrentFileId);
      confirmDeleteApproved(viewerCurrentFileId, thumbEl);
      closeApprovedViewer();
    });

    viewerPrevBtn.addEventListener("click", () => {
      if (viewerCurrentIndex <= 0) return;
      viewerCurrentIndex -= 1;
      const item = approvedFilesCache[viewerCurrentIndex];
      if (!item) return;
      openApprovedViewer(item.fileId, item.imgUrl);
    });

    viewerNextBtn.addEventListener("click", () => {
      if (viewerCurrentIndex < 0) return;
      if (viewerCurrentIndex >= approvedFilesCache.length - 1) return;
      viewerCurrentIndex += 1;
      const item = approvedFilesCache[viewerCurrentIndex];
      if (!item) return;
      openApprovedViewer(item.fileId, item.imgUrl);
    });

    // Photo Info Overlay Variables
    let currentPhotoInfo = {
      fileId: null,
      ticketNumber: null,
      userInfo: null,
    };

    const photoInfoOverlay = document.getElementById("photoInfoOverlay");
    const photoInfoClose = document.getElementById("photoInfoClose");
    const photoInfoLoading = document.getElementById("photoInfoLoading");
    const photoInfoContent = document.getElementById("photoInfoContent");
    const photoInfoError = document.getElementById("photoInfoError");
    const photoInfoPreviewImg = document.getElementById("photoInfoPreviewImg");
    const photoInfoEmail = document.getElementById("photoInfoEmail");
    const photoInfoLocation = document.getElementById("photoInfoLocation");
    const photoInfoName = document.getElementById("photoInfoName");
    const photoInfoDownloadTemplate = document.getElementById("photoInfoDownloadTemplate");
    const photoInfoDownloadOriginal = document.getElementById("photoInfoDownloadOriginal");

    // Extract ticket number from filename
    function extractTicketFromFileName(fileName) {
      if (!fileName || typeof fileName !== "string") return null;
      // Pattern: T001-... or legacy 01_...
      const match = fileName.match(/^T(\d+)-/i) || fileName.match(/^(\d+)_/);
      if (match) {
        const num = parseInt(match[1], 10);
        return `T${String(num).padStart(3, "0")}`;
      }
      return null;
    }

    // Open photo info overlay
    async function openPhotoInfoOverlay(fileId, fileName) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      // Load photo preview
      const photoUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
        fileId
      )}?token=${encodeURIComponent(adminToken || "")}`;
      photoInfoPreviewImg.src = photoUrl;

      const ticketNumber = extractTicketFromFileName(fileName);
      if (!ticketNumber) {
        // Still show overlay but with no match
        currentPhotoInfo = { fileId, ticketNumber: null, userInfo: null };
        photoInfoOverlay.style.display = "flex";
        photoInfoLoading.style.display = "none";
        photoInfoContent.style.display = "flex";
        photoInfoError.style.display = "none";
        photoInfoEmail.textContent = "No email";
        photoInfoLocation.textContent = "No country";
        photoInfoName.textContent = "No last name";
        return;
      }

      currentPhotoInfo = { fileId, ticketNumber, userInfo: null };
      photoInfoOverlay.style.display = "flex";
      photoInfoLoading.style.display = "flex";
      photoInfoContent.style.display = "none";
      photoInfoError.style.display = "none";

      try {
        const res = await fetch(
          `${BASE_URL}/admin/photo-info/${encodeURIComponent(ticketNumber)}`,
          {
            headers: withAdminHeaders(),
          }
        );

        if (res.status === 401 || res.status === 403) {
          showLock("Enter the access code to continue.");
          closePhotoInfoOverlay();
          return;
        }

        const data = await res.json();
        photoInfoLoading.style.display = "none";

        if (data.ok && data.match) {
          const match = data.match;
          currentPhotoInfo.userInfo = match;

          // Display user info with fallbacks
          photoInfoEmail.textContent = match.email || "No email";
          
          const locationParts = [match.region, match.country].filter(Boolean);
          photoInfoLocation.textContent = locationParts.length > 0 
            ? locationParts.join(", ") 
            : "No country";
          
          photoInfoName.textContent = match.last_name || "No last name";

          photoInfoContent.style.display = "flex";
        } else {
          // No match found - still show overlay but with no data
          currentPhotoInfo.userInfo = null;
          photoInfoEmail.textContent = "No email";
          photoInfoLocation.textContent = "No country";
          photoInfoName.textContent = "No last name";
          photoInfoContent.style.display = "flex";
        }
      } catch (err) {
        console.error("Error loading photo info:", err);
        photoInfoLoading.style.display = "none";
        photoInfoError.style.display = "block";
      }
    }

    // Close photo info overlay
    function closePhotoInfoOverlay() {
      photoInfoOverlay.style.display = "none";
      currentPhotoInfo = { fileId: null, ticketNumber: null, userInfo: null };
    }

    // Download with template (no user info printed)
    photoInfoDownloadTemplate.addEventListener("click", () => {
      if (!currentPhotoInfo.fileId) return;
      downloadApprovedWithFrame(currentPhotoInfo.fileId);
    });

    // Download original (clean photo)
    photoInfoDownloadOriginal.addEventListener("click", async () => {
      if (!currentPhotoInfo.fileId) return;
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      try {
        const photoUrl = `${BASE_URL}/admin/photo/${encodeURIComponent(
          currentPhotoInfo.fileId
        )}?token=${encodeURIComponent(adminToken || "")}`;

        const response = await fetch(photoUrl);
        if (!response.ok) {
          throw new Error("Failed to fetch photo");
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mayaguez_selfie_${currentPhotoInfo.fileId}_original.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("Error downloading original photo:", err);
        alert("Could not download the photo. Please try again.");
      }
    });

    // Close handlers
    photoInfoClose.addEventListener("click", closePhotoInfoOverlay);
    photoInfoOverlay.addEventListener("click", (e) => {
      if (e.target === photoInfoOverlay) {
        closePhotoInfoOverlay();
      }
    });

    function getYesterdayDateString() {
      const now = new Date();
      now.setDate(now.getDate() - 1);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // --- MENU ITEM HANDLERS ---
    menuViewApproved.addEventListener("click", openApprovedOverlay);

   async function generateReportNow() {
  if (!adminToken) {
    showLock("Session expired. Enter the access code.");
    return;
  }

  // If the modal is open, we show the animation there.
  // If it's not open (called from kebab menu), it still runs fine.
  if (reportOverlay.style.display === "flex") {
    showGlobalLoader();
  }

  try {
    const res = await fetch(`${BASE_URL}/session-report-now`, {
      method: "POST",
      headers: withAdminHeaders({ "Content-Type": "application/json" }),
      body: JSON.stringify({}),
    });

    if (res.status === 401 || res.status === 403) {
      showLock("Session expired. Enter the access code.");
      return;
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }

    let data = {};
    try {
      data = await res.json();
    } catch (_) {}

    const text =
      (data && data.reportText) ||
      "Event report generated and sent to the configured email.";

    if (reportPreview) {
      reportPreview.textContent = text;
    }

    alert("Event report generated and sent to the configured email.");
  } catch (err) {
    console.error("Error generating event report", err);
    if (reportPreview) {
      reportPreview.textContent =
        "Could not generate the event report. Please try again.";
    }
    alert("Could not generate the event report. Please try again.");
  } finally {
    hideGlobalLoader();
  }
}

    menuResetLogs.addEventListener("click", () => {
      closeMoreMenu();
      resetLogs();
    });

    menuClearApproved.addEventListener("click", clearApprovedFolder);

    // --- SHUTDOWN FLOW (toggle) ---
    async function handleToggleChange(e) {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      if (!appToggleInput.checked) {
        appToggleInput.checked = true;

        const confirmShutdown = window.confirm(
          "Would you like to shut down the server and generate the event report?"
        );
        if (!confirmShutdown) {
          appToggleInput.checked = true;
          return;
        }

        const code = window.prompt("Enter the access code to confirm:");
        if (!code) {
          appToggleInput.checked = true;
          return;
        }

        try {
          showGlobalLoader();
          const res = await fetch(`${BASE_URL}/admin/shutdown`, {
            method: "POST",
            headers: withAdminHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify({ accessCode: code }),
          });

          let data = {};
          try {
            data = await res.json();
          } catch (_) {}

          if (res.status === 401 && data.error === "invalid_access_code") {
            alert("Access code is incorrect.");
            return;
          }

          if (!res.ok || !data.ok) {
            const message = data.error
              ? `Could not shut down the server (${data.error}). Please try again.`
              : "Could not shut down the server. Please try again.";
            alert(message);
            return;
          }

          const reportText = data.reportText || "Event report generated.";

          const blob = new Blob([reportText], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "selfieapp_event_report.txt";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          updateAppToggleUI(false);
          appToggleInput.checked = false;
          disableAdminControlsForOffline();
          photoImg.style.display = "none";
          emptyText.style.display = "block";
          emptyText.textContent = "Server is offline for this event.";
          photoFrame.classList.add("empty");

          if (pendingCountEl) {
            pendingCountState = 0;
            pendingCountDelta = 0;
            updatePendingDisplay();
          }

          alert("Server has been shut down and the event report was generated.");
        } catch (err) {
          console.error("Error calling /admin/shutdown", err);
          alert("Could not shut down the server. Please try again.");
        } finally {
          hideGlobalLoader();
          await fetchAppStatus();
        }
      } else {
        const confirmStart = window.confirm(
          "Start a new session and bring the server online?"
        );
        if (!confirmStart) {
          appToggleInput.checked = false;
          return;
        }

        async function clearDriveForStart() {
          if (!adminToken) {
            showLock("Session expired. Enter the access code.");
            return false;
          }

          const ok = window.confirm(
            "Clear ALL photos from Pending + Approved before starting?\n\n" +
              "This will send every file to trash so the session can start clean."
          );
          if (!ok) return false;

          try {
            const res = await fetch(`${BASE_URL}/admin/clear-drive`, {
              method: "POST",
              headers: withAdminHeaders({ "Content-Type": "application/json" }),
              body: JSON.stringify({}),
            });

            if (res.status === 401 || res.status === 403) {
              showLock("Session expired. Enter the access code.");
              return false;
            }

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }

            return true;
          } catch (err) {
            console.error("Error clearing drive before start", err);
            alert("Could not clear the pending + approved folders. Please try again.");
            return false;
          }
        }

        async function attemptStartServer(allowRetry = true) {
          showGlobalLoader();
          try {
            const res = await fetch(`${BASE_URL}/admin/app-status`, {
              method: "POST",
              headers: withAdminHeaders({ "Content-Type": "application/json" }),
              body: JSON.stringify({ enabled: true }),
            });

            let data = {};
            try {
              data = await res.json();
            } catch (_) {}

            if (res.status === 401 || res.status === 403) {
              showLock("Session expired. Enter the access code.");
              appToggleInput.checked = false;
              return;
            }

            if (!res.ok || !data.ok) {
              const message = data.error
                ? `Could not start the server (${data.error}). Please try again.`
                : "Could not start the server. Please try again.";
              alert(message);
              appToggleInput.checked = false;

              if (allowRetry) {
                const cleared = await clearDriveForStart();
                if (cleared) {
                  await attemptStartServer(false);
                }
              }
              return;
            }

            updateAppToggleUI(true);
            appToggleInput.checked = true;
            appToggleWrapper.classList.remove("disabled");
            emptyText.style.display = "block";
            emptyText.textContent = "No pending photos.";
            photoFrame.classList.add("empty");

            if (pendingCountEl) {
              pendingCountState = 0;
              pendingCountDelta = 0;
              updatePendingDisplay();
            }

            await fetchEventLogs();
            await fetchActivityStats();
            await loadNextPhoto();
            startAutoRefresh();

            if (data.warning === "settings_persist_failed") {
              alert(
                "Server is online, but the status could not be saved to the Settings sheet. " +
                  "Please confirm Sheets permissions and try again."
              );
            } else {
              alert("Server is online and ready for a new session.");
            }
          } catch (err) {
            console.error("Error enabling server", err);
            alert("Could not start the server. Please try again.");
            appToggleInput.checked = false;
          } finally {
            hideGlobalLoader();
            await fetchAppStatus();
          }
        }

        try {
          await attemptStartServer();
        } catch (err) {
          console.error("Error enabling server", err);
          alert("Could not start the server. Please try again.");
          appToggleInput.checked = false;
          hideGlobalLoader();
        }
      }
    }

    appToggleInput.addEventListener("change", handleToggleChange);

    // --- LEFT NAV BEHAVIOR ---

    function setActiveNav(button) {
      [navDashboard, navApproved, navReports, navSettings, navResetLogs].forEach((btn) => {
        if (!btn) return;
        btn.classList.toggle("active", btn === button);
      });
    }

    if (navDashboard) {
      navDashboard.addEventListener("click", () => {
        setActiveNav(navDashboard);
        // Dashboard is the default view; nothing extra to show/hide right now
      });
    }

    if (navApproved) {
      navApproved.addEventListener("click", () => {
        setActiveNav(navApproved);
        openApprovedOverlay();
      });
    }

    if (navReports) {
      navReports.addEventListener("click", () => {
        setActiveNav(navReports);
        if (!adminToken) {
          showLock("Session expired. Enter the access code.");
          return;
        }
        openReportOverlay();
      });
    }

    if (navSettings) {
      navSettings.addEventListener("click", () => {
        setActiveNav(navSettings);
        openSettingsOverlay();
      });
    }

    if (navResetLogs) {
      navResetLogs.addEventListener("click", () => {
        setActiveNav(navResetLogs);
        menuResetLogs.click();
      });
    }

    if (lockAdminBtn) {
      lockAdminBtn.addEventListener("click", () => {
        clearAdminToken();
        showLock("Session locked. Enter the access code to continue.");
      });
    }

    // --- REPORT MODAL LOGIC ---

function openReportOverlay() {
  reportOverlay.style.display = "flex";
  reportPreview.textContent = "Tap “View report (preview)” to load the current summary.";
  hideReportLoading(); // make sure loader is off when you first open
}

    function closeReportOverlay() {
      reportOverlay.style.display = "none";
    }

    reportCloseBtn.addEventListener("click", closeReportOverlay);
    reportOverlay.addEventListener("click", (e) => {
      if (e.target === reportOverlay) {
        closeReportOverlay();
      }
    });

reportViewBtn.addEventListener("click", async () => {
  if (!adminToken) {
    showLock("Session expired. Enter the access code.");
    return;
  }

  showReportLoading();

  try {
    const res = await fetch(`${BASE_URL}/session-report-preview`, {
      method: "GET",
      headers: withAdminHeaders(),
    });

    if (res.status === 401 || res.status === 403) {
      showLock("Session expired. Enter the access code.");
      return;
    }

    if (!res.ok) {
      reportPreview.textContent =
        "Could not load the report preview. Please try again.";
      return;
    }

    const data = await res.json();

    if (data && data.reportText) {
      reportPreview.textContent = data.reportText;
    } else {
      reportPreview.textContent =
        "No report text was returned by the server.";
    }
  } catch (err) {
    console.error("Error fetching report preview", err);
    reportPreview.textContent =
      "Error loading the report preview. Please try again.";
  } finally {
    hideReportLoading();
  }
});

    reportGenerateBtn.addEventListener("click", async () => {
      await generateReportNow();
    });

    // --- Try to restore existing session on load ---

    function setSettingsStatus(message, tone = "muted") {
      if (!settingsStatus) return;
      settingsStatus.textContent = message || "";
      if (tone === "success") {
        settingsStatus.style.color = "#86efac";
      } else if (tone === "error") {
        settingsStatus.style.color = "#fca5a5";
      } else {
        settingsStatus.style.color = "var(--muted-foreground)";
      }
    }

    function fillSettingsForm(settings) {
      if (!settings) return;
      settingsTicketEnabled.checked = Boolean(settings.ticketEnabled);
      settingsGalleryDisplayLimit.value = settings.galleryDisplayLimit || "all";
      settingsIntroTitle.value = settings.intro?.title || "";
      settingsIntroSubtitle.value = settings.intro?.subtitle || "";
      settingsLocationEnabled.checked = Boolean(settings.form?.locationEnabled);
      settingsLastNameEnabled.checked = Boolean(settings.form?.lastName?.enabled);
      settingsLastNameLabel.value = settings.form?.lastName?.label || "";
      settingsLastNamePlaceholder.value = settings.form?.lastName?.placeholder || "";
      settingsEmailEnabled.checked = Boolean(settings.form?.email?.enabled);
      settingsEmailLabel.value = settings.form?.email?.label || "";
      settingsEmailPlaceholder.value = settings.form?.email?.placeholder || "";
      settingsNewsletterEnabled.checked = Boolean(settings.form?.newsletter?.enabled);
      settingsNewsletterLabel.value = settings.form?.newsletter?.label || "";
      settingsNewsletterHelper.value = settings.form?.newsletter?.helper || "";
    }

    function collectSettingsPayload() {
      return {
        ticketEnabled: settingsTicketEnabled.checked,
        galleryDisplayLimit: settingsGalleryDisplayLimit.value || "all",
        intro: {
          title: settingsIntroTitle.value.trim(),
          subtitle: settingsIntroSubtitle.value.trim(),
        },
        form: {
          locationEnabled: settingsLocationEnabled.checked,
          lastName: {
            enabled: settingsLastNameEnabled.checked,
            label: settingsLastNameLabel.value.trim(),
            placeholder: settingsLastNamePlaceholder.value.trim(),
          },
          email: {
            enabled: settingsEmailEnabled.checked,
            label: settingsEmailLabel.value.trim(),
            placeholder: settingsEmailPlaceholder.value.trim(),
          },
          newsletter: {
            enabled: settingsNewsletterEnabled.checked,
            label: settingsNewsletterLabel.value.trim(),
            helper: settingsNewsletterHelper.value.trim(),
          },
        },
      };
    }

    async function openSettingsOverlay() {
      if (!adminToken) {
        showLock("Session expired. Enter the access code.");
        return;
      }

      settingsOverlay.style.display = "flex";
      setSettingsStatus("Loading settings…");

      try {
        const res = await fetch(`${BASE_URL}/admin/settings`, {
          headers: withAdminHeaders(),
        });
        if (res.status === 401 || res.status === 403) {
          showLock("Session expired. Enter the access code.");
          return;
        }
        const data = await res.json();
        if (data && data.settings) {
          fillSettingsForm(data.settings);
          setSettingsStatus("");
        } else {
          setSettingsStatus("No settings were returned from the server.", "error");
        }
      } catch (err) {
        console.error("Error loading settings", err);
        setSettingsStatus("Failed to load settings.", "error");
      }
    }

    function closeSettingsOverlay() {
      settingsOverlay.style.display = "none";
      setSettingsStatus("");
    }

    if (settingsCloseBtn) {
      settingsCloseBtn.addEventListener("click", closeSettingsOverlay);
    }

    if (settingsOverlay) {
      settingsOverlay.addEventListener("click", (e) => {
        if (e.target === settingsOverlay) {
          closeSettingsOverlay();
        }
      });
    }

    if (settingsSaveBtn) {
      settingsSaveBtn.addEventListener("click", async () => {
        if (!adminToken) {
          showLock("Session expired. Enter the access code.");
          return;
        }

        setSettingsStatus("Saving settings…");

        try {
          const payload = collectSettingsPayload();
          const res = await fetch(`${BASE_URL}/admin/settings`, {
            method: "POST",
            headers: withAdminHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify(payload),
          });

          if (res.status === 401 || res.status === 403) {
            showLock("Session expired. Enter the access code.");
            return;
          }

          const data = await res.json();
          if (data && data.ok) {
            fillSettingsForm(data.settings);
            setSettingsStatus("Settings saved.", "success");
          } else {
            setSettingsStatus("Could not save settings.", "error");
          }
        } catch (err) {
          console.error("Error saving settings", err);
          setSettingsStatus("Error saving settings.", "error");
        }
      });
    }
    (function bootstrapAdmin() {
      preloadFrameImage().catch(() => {
        console.warn("Frame image preload failed (will retry on demand).");
      });

      const saved = localStorage.getItem(ADMIN_TOKEN_KEY);
      if (!saved) {
        showLock();
        return;
      }

      adminToken = saved;
      hideLock();

      fetchAppStatus()
        .then(() => loadNextPhoto())
        .then(() => fetchEventLogs())
        .then(() => fetchActivityStats())
        .then(() => startAutoRefresh())
        .catch(() => {
          showLock();
        });
    })();
  </script>
  <div id="globalLoader" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(10,17,30,0.75);
  z-index:99999;
  align-items:center;
  justify-content:center;
">
  <div id="globalLottie" style="width:180px;height:180px;"></div>
</div>
</body>
</html>
